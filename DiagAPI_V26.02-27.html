<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>DiagAPI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- =====================
     Styles
     ===================== -->
<style>

/* ============================= */
/* Console ACD Pro (Sidebar)     */
/* ============================= */
:root{
  --sidebar-w: 300px;
  --sidebar-w-collapsed: 76px;
}

.layout{ display:flex; }

#sidebar{
  position: fixed;
  top: 0;
  left: 0;
  width: var(--sidebar-w);
  height: 100vh;
  overflow-y: auto;
  padding: 14px 14px 18px;
  box-sizing: border-box;
  border-right: 1px solid var(--border);
  background: linear-gradient(180deg, var(--bg2), var(--bg));
  z-index: 9999;
  transition: width .18s ease, padding .18s ease;
}

#mainContent{
  margin-left: var(--sidebar-w);
  width: calc(100% - var(--sidebar-w));
  padding: 18px 18px 44px;
}

/* Top */
.sidebarTop{
  position: sticky;
  top: 0;
  z-index: 3;
  padding-bottom: 10px;
  background: linear-gradient(180deg, var(--bg2), rgba(0,0,0,0));
}

.sidebarToggle{
  width: 100%;
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.04);
  color: var(--text);
  cursor:pointer;
}
.sidebarToggle:hover{ filter: brightness(1.05); }
.sidebarToggleIcon{ font-size: 16px; line-height: 1; }
.sidebarToggleText{ font-weight: 600; }

/* Forcer le contenu header existant en colonne */
#sidebar .headerInner{
  display:flex !important;
  flex-direction: column !important;
  gap: 12px !important;
  align-items: stretch !important;
}
#sidebar .inputsWrap{
  display:flex !important;
  flex-direction: column !important;
  gap: 10px !important;
}
#sidebar .inputGroup{ width: 100% !important; flex: 1 1 auto !important; }
#sidebar .headerActions{
  display:flex !important;
  flex-direction: column !important;
  gap: 10px !important;
  align-items: stretch !important;
}
#sidebar button, #sidebar .copybtn{ width: 100%; justify-content: center; }

/* Mode r√©tract√© */
body.sidebar-collapsed #sidebar{
  width: var(--sidebar-w-collapsed);
  padding: 12px 10px 16px;
}
body.sidebar-collapsed #mainContent{
  margin-left: var(--sidebar-w-collapsed);
  width: calc(100% - var(--sidebar-w-collapsed));
}
body.sidebar-collapsed #sidebar .sidebarToggleText{ display:none; }

/* Cache la majorit√© des contenus en mode r√©duit, mais garde les actions principales */
body.sidebar-collapsed #sidebar .headerInputs,
body.sidebar-collapsed #sidebar .inputsWrap,
body.sidebar-collapsed #sidebar .inputGroup,
body.sidebar-collapsed #sidebar .headerTop .subtitle,
body.sidebar-collapsed #sidebar .headerTop .envBadgeWrap{
  display:none !important;
}

body.sidebar-collapsed #sidebar .headerActions{
  gap: 8px !important;
}
body.sidebar-collapsed #sidebar .headerActions button,
body.sidebar-collapsed #sidebar .headerActions .copybtn{
  padding: 10px 8px;
  font-size: 12px;
}

/* Mobile: sidebar en haut */
@media (max-width: 920px){
  #sidebar{
    position: static;
    width: 100%;
    height: auto;
    border-right: none;
    border-bottom: 1px solid var(--border);
  }
  #mainContent{
    margin-left: 0;
    width: 100%;
  }
  body.sidebar-collapsed #sidebar,
  body.sidebar-collapsed #mainContent{
    width: 100%;
    margin-left: 0;
  }
}


    :root{
      /* ACD ‚Äì Suite Expert (approx. palette) */
      --se-800:#0b1f3b;
      --se-700:#123a6b;
      --se-500:#1f5aa6;
      --se-300:#9fc0f5;
      --se-200:#d8e6ff;

      /* Neutrals */
      --n-0:#ffffff;
      --n-50:#f7f9fc;
      --n-100:#eef3f9;
      --n-200:#e1e8f3;
      --n-300:#d0d9e7;
      --n-600:#4b5563;
      --n-900:#0b1220;

      --bg:var(--n-50);
      --surface:var(--n-0);
      --surface2:var(--n-100);
      --text:var(--n-900);
      --muted:var(--n-600);
      --border:var(--n-200);
      --border2:var(--n-300);
      --pre:var(--n-100);

      --primary:var(--se-700);
      --primaryText:#ffffff;

      --ok:#0a7a25;
      --err:#b00020;

      --badgeOkBg:#eaf7ee; --badgeOkBd:#bfe7c8;
      --badgeNoBg:#fdecef; --badgeNoBd:#f2b8c2;
      --badgeNaBg:#eef3f9; --badgeNaBd:#d0d9e7;

      --shadow: 0 10px 25px rgba(11,31,59,.08);
      --radius: 16px;
      --radiusSm: 12px;
    }

    /* Th√®me sombre */
    :root[data-theme="dark"]{
      --bg:#0b1220;
      --surface:#0f1b2e;
      --surface2:#12233b;
      --text:#ffffff;
      --muted:#cbd5e1;
      --border:#1f2f4a;
      --border2:#2a3c5c;
      --pre:#0f1b2e;

      --badgeOkBg:rgba(10,122,37,.18); --badgeOkBd:rgba(10,122,37,.35);
      --badgeNoBg:rgba(176,0,32,.18); --badgeNoBd:rgba(176,0,32,.35);
      --badgeNaBg:rgba(238,243,249,.08); --badgeNaBd:rgba(208,217,231,.20);

      --shadow: 0 10px 25px rgba(0,0,0,.35);
    }

    /* Toggle th√®me */
    .themeToggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      user-select:none;
    }
    .themeToggle span{ font-size:12px; font-weight:700; color:#fff; opacity:.95; }
    .switch{
      width:44px;
      height:24px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.22);
      position:relative;
      cursor:pointer;
      outline:none;
    }
    .switch:focus{ box-shadow: 0 0 0 4px rgba(159,192,245,.30); }
    .switch .knob{
      width:20px;
      height:20px;
      border-radius:999px;
      background:#ffffff;
      position:absolute;
      top:1px;
      left:1px;
      transition: transform .18s ease;
      box-shadow: 0 6px 14px rgba(0,0,0,.20);
    }
    #themeSwitch[aria-checked="true"]{ background: rgba(159,192,245,.55); }
    #themeSwitch[aria-checked="true"] .knob{ transform: translateX(20px); }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      max-width:none;
      font-family: "Segoe UI", SegoeUI, system-ui, -apple-system, Roboto, Arial, sans-serif;
      background:var(--bg); color:var(--text);
      font-size:14px; font-weight:400;
    }

    /* Header */
    header{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:16px; margin-bottom:16px;
      padding:16px 18px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, var(--se-800), var(--se-700));
      color: #fff;
      box-shadow: var(--shadow);
    }
    header .subTitle{ color: rgba(255,255,255,.85) !important; }

    
    /* Option chiffrement mot de passe (sous le champ Mot de passe) */
    .encrypt-option{ margin-top: 8px; margin-left: 34px; }
    .encrypt-option .encrypt-label{ display:flex; align-items:center; gap:8px; font-weight:600; }

/* Header inputs (Code Agent / Ticket Zendesk) */
    .headerInputs{ flex: 1; display:flex; align-items:center; justify-content:center; }
    .headerInputs .inputsWrap{ width:100%; max-width: 720px; display:flex; gap:12px; }
    .headerInputs .inputGroup{ flex:1; min-width: 0; }
    .headerInputs .inputGroup:first-child{ flex:0 0 150px; }
    .headerInputs .inputLabel{ font-size: 12px; font-weight: 600; opacity: .9; margin: 0 0 6px 2px; }
    .headerInputs input{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      color: #fff;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .headerInputs input::placeholder{ color: rgba(255,255,255,.55); }
    .headerInputs input:focus{ border-color: rgba(255,255,255,.45); background: rgba(0,0,0,.24); }

    /* Environment badge */
    .env-badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border2);
      background: var(--surface2);
      color: var(--text);
      font-size:12px;
      font-weight:700;
      letter-spacing:.4px;
      text-transform:uppercase;
      line-height:1;
      box-shadow: 0 6px 14px rgba(11,31,59,.10);
      user-select:none;
    }
    .env-badge.env-local{
      border-color: rgba(159,192,245,.9);
      background: rgba(216,230,255,.95);
      color: var(--se-800);
    }
    .env-badge.env-client{
      border-color: var(--border2);
      background: rgba(238,243,249,.85);
      color: var(--n-900);
    }
    h1{ font-size:24px; font-weight:700; margin:0; letter-spacing:.2px; }
    h2{ font-size:16px; font-weight:700; margin:22px 0 10px; }
    .subTitle{ font-size:12px; color:var(--muted); margin-top:6px; }

    /* Forms */
    label{ font-size:12px; font-weight:700; display:block; margin-bottom:6px; }
    input, select{
      width:100%; padding:10px 12px; border-radius:var(--radiusSm);
      border:1px solid var(--border2); background:var(--surface); color:var(--text);
      font-size:14px; outline:none;
    }
    input:focus, select:focus{
      border-color: var(--se-300);
      box-shadow: 0 0 0 4px rgba(159,192,245,.35);
    }
    .muted{ color:var(--muted); }

    /* Cards & layout */
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      padding:14px;
      border-radius:var(--radius);
      box-shadow: var(--shadow);
    }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 860px){
      body{ margin:16px; }
      .grid{ grid-template-columns:1fr; }
      header{ flex-direction:column; }
    }
    .row{ margin-bottom:12px; }
    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;
    }

    /* Buttons */
    button{
      padding:10px 14px; border-radius:var(--radiusSm);
      border:1px solid var(--border2);
      background:var(--surface);
      color:var(--text);
      font-weight:700; cursor:pointer;
      transition: transform .04s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    button:hover{ background:var(--surface2); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    /* Variantes ACD */
    .btn-primary{
      border-color: transparent !important;
      background: linear-gradient(135deg, var(--se-800), var(--se-700)) !important;
      color: var(--primaryText) !important;
      box-shadow: 0 6px 16px rgba(11,31,59,.15);
    }
    .btn-primary:hover{
      background: linear-gradient(135deg, var(--se-700), var(--se-500)) !important;
    }

    .btn-secondary{
      background: linear-gradient(180deg, var(--n-100), var(--n-0)) !important;
      border-color: var(--border2) !important;
      color: var(--text) !important;
    }
    .btn-secondary:hover{ background: var(--n-100) !important; }

    /* r√©tro-compat : ancien .primary */
    button.primary{
      border-color: transparent;
      background: linear-gradient(135deg, var(--se-800), var(--se-700));
      color:var(--primaryText);
      box-shadow: 0 6px 16px rgba(11,31,59,.15);
    }
    button.primary:hover{ background: linear-gradient(135deg, var(--se-700), var(--se-500)); }
/* Pills / badges */
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:var(--surface2);
      font-size:12px;
    }
    .badge{
      display:inline-flex; align-items:center;
      padding:3px 8px; border-radius:999px;
      border:1px solid var(--border2);
      font-size:11px; font-weight:700;
    }
    .badge.ok{ background:var(--badgeOkBg); border-color:var(--badgeOkBd); color:var(--ok); }
    .badge.err{ background:var(--badgeNoBg); border-color:var(--badgeNoBd); color:var(--err); }
    .badge.na{ background:var(--badgeNaBg); border-color:var(--badgeNaBd); color:var(--muted); }

    /* Tabs */
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--border2);
      background: var(--surface2);
      color: var(--text);
      font-weight:700; font-size:12px;
      cursor:pointer;
    }
    .tab:hover{ background: var(--n-100); }
    .tab.active{
      border-color: transparent;
      background: linear-gradient(135deg, var(--se-800), var(--se-700));
      color:#fff;
    }
/* Key/Value rows */
    .kv{ display:flex; flex-direction:column; gap:8px; }
    .kv-row{
      display:grid; grid-template-columns: 220px 1fr;
      gap:10px; align-items:center;
      padding:8px 10px;
      background:var(--surface2);
      border:1px solid var(--border);
      border-radius:var(--radiusSm);
    }
    .kv-key{ font-size:12px; color:var(--muted); font-weight:700; }
    .kv-val{ font-size:14px; }
    .hidden{ display:none !important; }

    /* Status */
    .status{ font-size:12px; color:var(--muted); }
    .status.ok{ color:var(--ok); font-weight:700; }
    .status.err{ color:var(--err); font-weight:700; }

    /* Pre / history */
    pre{
      background:var(--pre);
      border:1px solid var(--border);
      border-radius:var(--radiusSm);
      padding:12px;
      overflow:auto;
      font-size:12px;
      line-height:1.45;
    }
    .hint{ font-size:12px; color:var(--muted); }
  
    /* ============================= */
    /*   INPUT PREMIUM ‚Äì ACD         */
    /* ============================= */
    .input-group{position:relative;margin-bottom:18px;font-family:"Segoe UI",SegoeUI,system-ui,-apple-system,Roboto,Arial,sans-serif;}
    .input-group input{width:100%;height:40px;padding:10px 44px 10px 40px;border-radius:10px;border:1px solid var(--n-300);background:var(--n-0);font-size:14px;transition:all .2s ease;box-sizing:border-box;}
    .input-group input:focus{outline:none;border-color:var(--se-500);box-shadow:0 0 0 3px rgba(31,90,166,.18);}
    .input-group label{position:absolute;top:11px;left:40px;font-size:14px;color:#64748b;transition:all .2s ease;pointer-events:none;background:transparent;}
    .input-group input:focus + label,
    .input-group input:not(:placeholder-shown) + label{top:-8px;left:34px;font-size:11px;background:var(--n-0);padding:0 6px;color:var(--se-500);}
    .input-icon{position:absolute;top:11px;left:12px;font-size:16px;color:#64748b;line-height:1;}
    .input-inline-btn{position:absolute;right:10px;top:8px;height:24px;padding:0 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid var(--n-300);background:var(--n-0);color:var(--se-800);cursor:pointer;}
    .input-inline-btn:hover{background:var(--n-50);}
    .password-toggle{position:absolute;right:12px;top:11px;cursor:pointer;font-size:16px;color:#64748b;user-select:none;}

  
/* ---------- Premium Auth Layout Fixes ---------- */
.label-acd{ font-size:14px; font-weight:700; color:var(--text); display:block; margin-bottom:6px; }
.input-plain{ padding:10px 12px !important; }
.urlRow{ display:flex; flex-direction:column; gap:10px; }
.urlPresets{ display:flex; gap:8px; flex-wrap:wrap; }
@media (min-width: 780px){
  .urlRow{ flex-direction:column; }
}


/* --- ACD : Connected card spacing & separators --- */
#sec-connected .connectedBody{padding-top:4px;}
#sec-connected .sessionRow{padding:6px 0;}
#sec-connected .acd-separator{
  height:1px;
  background:var(--border);
  width:100%;
  margin:12px 0;
}
#sec-connected .sessionRow + .acd-separator{margin-top:14px;}


    /* Chiffrer mot de passe (align√© √† droite sous le champ Mot de passe) */
    .encrypt-inline-row{
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      width: 100%;
    }
    .encrypt-inline-label{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      white-space: nowrap;
      user-select: none;
    }
    .encrypt-inline-label input[type="checkbox"]{
      width: 16px;
      height: 16px;
      margin: 0;
    }


    /* Modal Import JSON */
    .acd-modal{ position:fixed; inset:0; display:none; z-index:9999; }
    .acd-modal[aria-hidden="false"]{ display:block; }
    .acd-modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
    :root[data-theme="dark"] .acd-modal-backdrop{ background:rgba(0,0,0,.60); }
    .acd-modal-dialog{
      position:relative;
      width:min(760px, calc(100% - 24px));
      margin:60px auto;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .acd-modal-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background: linear-gradient(180deg, rgba(18,58,107,.10), transparent);
      border-bottom:1px solid var(--border);
    }
    .acd-modal-title{ font-weight:700; }
    .acd-modal-body{ padding:14px 16px; }
    .textarea-acd{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--border2);
      border-radius: var(--radiusSm);
      padding:10px 12px;
      background:var(--surface2);
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      line-height:1.35;
      resize:vertical;
    }
    .help{ color:var(--muted); font-size:12px; }


/* ============================= */
/* Sidebar Pro am√©lior√©e         */
/* ============================= */
.sidebarToggleIcon{
  display:inline-block;
  transition: transform .2s ease;
}
body.sidebar-collapsed .sidebarToggleIcon{
  transform: rotate(180deg);
}

/* Tooltips en mode compact */
body.sidebar-collapsed #sidebar [title]{
  position: relative;
}
body.sidebar-collapsed #sidebar [title]:hover::after{
  content: attr(title);
  position: absolute;
  left: calc(100% + 10px);
  top: 50%;
  transform: translateY(-50%);
  white-space: nowrap;
  padding: 6px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--bg2);
  color: var(--text);
  box-shadow: 0 10px 24px rgba(0,0,0,.15);
  z-index: 10000;
}

/* Collapsed : largeur + centrage boutons */
body.sidebar-collapsed #sidebar{
  width: 72px;
}
body.sidebar-collapsed #mainContent{
  margin-left: 72px;
  width: calc(100% - 72px);
}
body.sidebar-collapsed #sidebar .sidebarToggle{
  justify-content: center;
}
body.sidebar-collapsed #sidebar .sidebarToggleIcon{
  margin: 0;
}


/* ===== Contraste Sidebar am√©lior√© ===== */
#sidebar{
  background: #0f2744 !important;
  border-right: 1px solid rgba(255,255,255,0.08);
}
#sidebar input{
  background: #17375f !important;
  color: #ffffff !important;
}
#sidebar label{
  color: #cfe3ff !important;
}
#sidebar button{
  background: #1f4c83 !important;
  color: #ffffff !important;
  border: 1px solid rgba(255,255,255,0.15);
}
#sidebar button:hover{
  background: #2a63a8 !important;
}


/* ===== Bloc Connexion am√©lior√© ===== */
.kv-block,
.card,
.connexionBlock{
  padding: 22px 24px !important;
}

.kv-row{
  flex-wrap: wrap !important;
}

.kv-row .kv-val{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}


/* ===== Sidebar texte: lisibilit√© ===== */
#sidebar, #sidebar *{
  color: #ffffff;
}
#sidebar .inputLabel, #sidebar label, #sidebar .subtitle, #sidebar .muted{
  color: rgba(255,255,255,0.78) !important;
}
#sidebar .app-name, #sidebar .app-title, #sidebar .headerTitle{
  color: #ffffff !important;
}
#sidebar input::placeholder{
  color: rgba(255,255,255,0.55) !important;
}


/* ===== KV rows: emp√™cher les actions de sortir du cadre ===== */
.kv-row{
  align-items: flex-start !important;
}
.kv-row .kv-val{
  min-width: 0 !important;
  max-width: 100% !important;
  display: flex !important;
  flex-wrap: wrap !important;
  gap: 8px !important;
  justify-content: flex-end !important;
}
.kv-row .kv-val > *{
  max-width: 100% !important;
}
.kv-row .kv-val button,
.kv-row .kv-val .copybtn{
  white-space: nowrap !important;
}
/* En cas de longue valeur (UUID), autoriser le retour √† la ligne */
.kv-row .kv-val .mono,
.kv-row .kv-val .uuid,
.kv-row .kv-val span{
  overflow-wrap: anywhere;
}


/* ===== Badge environnement : mise en avant dans la sidebar ===== */
#sidebar .envBadgeWrap{
  margin-top: 10px !important;
}


/* ===== Badge environnement : override total contraste ===== */
#sidebar [class*="env"],
#sidebar [id*="env"],
#sidebar .envBadgeWrap *,
#sidebar .envBadge * {
  background-color: #ffffff !important;
  color: #0f2744 !important;
  font-weight: 800 !important;
  opacity: 1 !important;
  border-color: #0f2744 !important;
}


/* ===== Sidebar boutons : style rose type "Send" ===== */
#sidebar button{
  background: linear-gradient(135deg, #e2559a, #d94f95) !important;
  color: #ffffff !important;
  border: none !important;
  font-weight: 600 !important;
}

#sidebar button:hover{
  background: linear-gradient(135deg, #ec6aaa, #e2559a) !important;
}

#sidebar button:active{
  transform: translateY(1px);
}


/* ===== Sidebar layout vertical spacing ===== */
#sidebar{
  display: flex !important;
  flex-direction: column !important;
  justify-content: space-between !important;
}

#sidebar .sidebarTop,
#sidebar .headerTop,
#sidebar .sidebar-content-top{
  flex: 0 0 auto;
}

#sidebar .sidebar-bottom,
#sidebar .sidebar-actions,
#sidebar .bottom-actions{
  margin-top: auto !important;
}

/* Si les boutons ne sont pas d√©j√† dans un bloc bottom, cibler explicitement */
#sidebar button:nth-last-child(3),
#sidebar button:nth-last-child(2),
#sidebar button:nth-last-child(1){
  margin-bottom: 12px;
}


/* ===== Sidebar : zone basse "actions" propre ===== */
#sidebar{
  display:flex !important;
  flex-direction: column !important;
}

#sidebar .headerActions{
  margin-top: auto !important;
  padding: 14px 12px 12px !important;
  border-radius: 16px !important;
  background: rgba(255,255,255,0.04) !important;
  border: 1px solid rgba(255,255,255,0.10) !important;
  box-shadow: 0 10px 24px rgba(0,0,0,0.16) !important;
}

#sidebar .headerActions::before{
  content: "";
  display:block;
  height:1px;
  background: rgba(255,255,255,0.10);
  margin: 0 2px 12px;
}

#sidebar .headerActions button{
  border-radius: 14px !important;
}

#sidebar .headerActions .toggleWrap,
#sidebar .headerActions .switchRow,
#sidebar .headerActions .darkModeRow{
  margin-top: 10px !important;
  padding-top: 10px !important;
  border-top: 1px dashed rgba(255,255,255,0.12) !important;
}

/* Micro-a√©ration g√©n√©rale dans la sidebar */
#sidebar .inputsWrap{
  margin-top: 6px !important;
  padding-bottom: 10px !important;
}


/* ===== Zone principale plus large et plus lisible ===== */
#mainContent,
.main-content,
.content-wrapper{
  max-width: 1500px !important;
  width: calc(100% - 320px) !important;
}

.card,
.section,
.block,
.kv-block{
  padding: 28px 32px !important;
}

.card h2,
.section h2{
  font-size: 1.2rem !important;
}

input,
button,
select{
  font-size: 15px !important;
}


/* ===== Layout FULL WIDTH ===== */
#mainContent,
.main-content,
.content-wrapper,
.container,
.wrapper{
  max-width: 100% !important;
  width: calc(100% - 280px) !important;
  margin-right: 0 !important;
}

body.sidebar-collapsed #mainContent{
  width: calc(100% - 72px) !important;
}

.card,
.section,
.block{
  max-width: 100% !important;
}


/* ===== Override layout console: body full width ===== */
body{ margin:0 !important; max-width:none !important; }


/* ===== Mise en √©vidence : Dossier publi√© sur iSuite ===== */
.kv-row.isuite-highlight{
  background: linear-gradient(90deg, rgba(43,125,233,0.12), rgba(43,125,233,0.03)) !important;
  border: 2px solid rgba(43,125,233,0.95) !important;
  border-radius: 14px !important;
  padding: 16px 18px !important;
  box-shadow: 0 10px 24px rgba(43,125,233,0.18) !important;
}

.kv-row.isuite-highlight .kv-key,
.kv-row.isuite-highlight .kv-label{
  font-weight: 700 !important;
}

.kv-row.isuite-highlight .badge{
  font-weight: 700 !important;
}


/* ===== Import JSON : contraste textes ===== */
/* Titre fen√™tre Import */
#importModal .modal-title,
#importModal .modalHeader,
#importModal h2,
#importModal h3{
  color: #0f2744 !important;
  font-weight: 700 !important;
}

/* Boutons "Choisir un fichier" / "Coller le JSON" */
#importModal button,
#importModal .btn,
#importModal .import-btn{
  color: #ffffff !important;
  font-weight: 700 !important;
}

/* Zone texte JSON (textarea) et placeholder */
#importJsonText,
#jsonImportText,
#importModal textarea{
  color: #0f2744 !important;
  font-weight: 500 !important;
}
#importModal textarea::placeholder{
  color: rgba(15,39,68,0.65) !important;
}


/* ===== Import JSON : CONTRASTE (correctif robuste) ===== */
#acdImportJsonModal .acd-modal-title,
#importJsonModalTitle,
.acd-modal-title{
  color: #0f2744 !important;
  font-weight: 800 !important;
  text-shadow: none !important;
}

/* Boutons (garder texte blanc sur fond rose) */
#acdImportJsonModal .btn,
#acdImportJsonModal button{
  color: #ffffff !important;
  font-weight: 700 !important;
}

/* Label et aide */
#acdImportJsonModal .label-acd,
#acdImportJsonModal label,
#acdImportJsonModal .help{
  color: #0f2744 !important;
  font-weight: 600 !important;
}

/* Zone de saisie JSON */
#importJsonTextarea,
#acdImportJsonModal textarea,
#acdImportJsonModal .textarea-acd{
  color: #0f2744 !important;
  font-weight: 500 !important;
  background: #eef4fb !important;
  border-color: rgba(15,39,68,0.35) !important;
}
#importJsonTextarea::placeholder,
#acdImportJsonModal textarea::placeholder{
  color: rgba(15,39,68,0.62) !important;
}


/* ===== Console Pro : lien Annuler ===== */
.cancelLink{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 8px 12px;
  border-radius: 12px;
  color:#0f2744 !important;
  font-weight: 700;
  text-decoration:none;
  border: 1px solid rgba(15,39,68,0.18);
  background: rgba(255,255,255,0.70);
  box-shadow: 0 10px 24px rgba(0,0,0,0.08);
  transition: transform .12s ease, filter .12s ease;
}
.cancelLink::before{
  content:"‚Ü©";
  font-size: 14px;
  opacity: .85;
}
.cancelLink:hover{
  filter: brightness(1.03);
  transform: translateY(-1px);
  text-decoration:none;
}
.cancelLink:active{
  transform: translateY(0px);
}


/* ===== Import JSON : Footer Annuler (toujours visible) ===== */
#importJsonModal .importModalFooter{
  display:flex;
  justify-content:flex-end;
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid rgba(15,39,68,0.10);
}


/* ===== Sidebar : Commentaire ===== */
.sidebarTextarea{
  width: 100%;
  min-height: 84px;
  max-height: 160px;
  resize: vertical;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.16);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.92);
  outline: none;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08);
}
.sidebarTextarea::placeholder{ color: rgba(255,255,255,0.55); }
.sidebarTextarea:focus{
  border-color: rgba(255,255,255,0.30);
  box-shadow: 0 0 0 3px rgba(210,76,143,0.18);
}


/* ===== Sidebar : Liens rapides ===== */
#sidebar .sidebarLinksSection{
  margin: 12px 16px 6px 16px;
  padding: 10px 10px 12px 10px;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 14px;
  background: rgba(255,255,255,.04);
}
#sidebar .sidebarSectionTitle{
  font-weight: 800;
  font-size: 12px;
  letter-spacing: .2px;
  margin: 0 0 10px 0;
  color: rgba(255,255,255,.92);
}
#sidebar .sidebarLinksBtns{
  display:flex;
  flex-direction: column;
  gap: 10px;
}
#sidebar .sidebarLinksBtns .copybtn{
  width: 100%;
  border-radius: 12px;
}


#btnSwaggerSidebar, #btnZendeskSidebar{display:none;}

/* ===== Sidebar : stack Commentaire + Liens rapides ===== */
#sidebar .headerInputs{
  display:flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  gap: 12px;
}

</style>

<!-- =====================
     Scripts
     ===================== -->
<script>

  // ===== CURL helper (pour fen√™tre JSON) =====
  window.lastGeneratedCurl = "";

  
  let lastBalanceCurl = "";
  let lastCabinetsCurl = "";
function _escapeSingleQuotesForBash(s){
    return String(s).replace(/'/g, `'"'"'`);
  }

  function buildCurlCommand(url, options){
    const opt = options || {};
    const method = (opt.method || "GET").toUpperCase();
    const headers = opt.headers || {};
    const lines = [];
    lines.push(`curl -X '${method}' \\`);
    lines.push(`  '${_escapeSingleQuotesForBash(url)}' \\`);

    const hdrPairs = [];
    try{
      if (headers instanceof Headers){
        headers.forEach((v,k)=> hdrPairs.push([k,v]));
      } else if (Array.isArray(headers)){
        headers.forEach((pair)=> { if(pair && pair.length>=2) hdrPairs.push([pair[0], pair[1]]); });
      } else {
        Object.keys(headers).forEach(k=> hdrPairs.push([k, headers[k]]));
      }
    }catch(e){}

    hdrPairs.forEach(([k,v]) => {
      lines.push(`  -H '${_escapeSingleQuotesForBash(k)}: ${_escapeSingleQuotesForBash(v)}' \\`);
    });

    if (opt.body !== undefined && opt.body !== null && String(opt.body).length){
      const body = (typeof opt.body === "string") ? opt.body : JSON.stringify(opt.body);
      lines.push(`  --data '${_escapeSingleQuotesForBash(body)}'`);
    } else {
      if (lines.length && /\\\s*$/.test(lines[lines.length-1])){
        lines[lines.length-1] = lines[lines.length-1].replace(/\\\s*$/,"");
      }
    }
    return lines.join("\n");
  }

  async function fetchWithTrace(url, options){
    const opts = options || {};
    const method = String(opts.method || "GET").toUpperCase();

    // Build curl once, and keep it tied to this call (avoid "last call wins" issues)
    let curl = "";
    try {
      curl = buildCurlCommand(url, opts);
      window.lastGeneratedCurl = curl;
    } catch (e) {
      window.lastGeneratedCurl = "";
    }

    // Key used to retrieve the right curl/status/duration later from the JSON viewer
    function titleKeyFromUrl(u){
      try{
        const uu = new URL(u, window.location.href);
        const p = uu.pathname || "";
        // Prefer route starting at /v1/...
        const idx = p.indexOf("/v1/");
        const route = idx >= 0 ? p.substring(idx) : p;
        return method + " " + route;
      }catch(e){
        return method + " " + String(u || "");
      }
    }
    const titleKey = titleKeyFromUrl(url);

    const t0 = (window.performance && performance.now) ? performance.now() : Date.now();
    const resp = await window.fetch(url, opts);
    const t1 = (window.performance && performance.now) ? performance.now() : Date.now();
    const durationMs = Math.round(t1 - t0);

    // Backward compatible globals
    window.lastHttpStatus = resp.status;
    window.lastHttpDuration = durationMs;

    // Per-route meta (fix: show the correct CURL for the response being displayed)
    window.__acdLastMetaByTitle = window.__acdLastMetaByTitle || {};
    window.__acdLastMetaByTitle[titleKey] = { curl: curl, status: resp.status, durationMs: durationMs, at: Date.now() };

    // Attach meta to the response too (sometimes handy for callers)
    try { resp.__acdCurl = curl; resp.__acdDurationMs = durationMs; } catch(e) {}

    return resp;
  }



/* ACD - API call logger: logs every route + full response in browser console */
(function () {
  if (!window.fetch) return;

  const origFetch = window.fetch.bind(window);
  window.__acdApiLogs = window.__acdApiLogs || [];

  function toPlainHeaders(headers) {
    const out = {};
    try {
      if (!headers) return out;
      if (headers instanceof Headers) {
        headers.forEach((v, k) => { out[k] = v; });
      } else if (Array.isArray(headers)) {
        headers.forEach(([k, v]) => { out[String(k).toLowerCase()] = v; });
      } else if (typeof headers === "object") {
        Object.keys(headers).forEach(k => { out[k] = headers[k]; });
      }
    } catch (_) {}
    return out;
  }

  function truncate(str, maxLen) {
    if (typeof str !== "string") str = String(str ?? "");
    if (str.length <= maxLen) return { value: str, truncated: false };
    return { value: str.slice(0, maxLen) + "‚Ä¶(truncated)‚Ä¶", truncated: true };
  }

  function nowMs() {
    return (window.performance && performance.now) ? performance.now() : Date.now();
  }

  window.fetch = async function (input, init) {
    const startedAt = nowMs();
    const reqUrl = (typeof input === "string") ? input : (input && input.url) ? input.url : String(input);
    const reqMethod = (init && init.method) ? String(init.method).toUpperCase() : (input && input.method) ? String(input.method).toUpperCase() : "GET";
    const reqHeaders = toPlainHeaders((init && init.headers) ? init.headers : (input && input.headers) ? input.headers : undefined);

    // Best-effort request body extraction (avoid logging huge/binary bodies)
    let reqBody = (init && "body" in init) ? init.body : undefined;
    let reqBodyPreview = undefined;
    try {
      if (reqBody == null) {
        reqBodyPreview = undefined;
      } else if (typeof reqBody === "string") {
        reqBodyPreview = truncate(reqBody, 20000).value;
      } else if (reqBody instanceof URLSearchParams) {
        reqBodyPreview = truncate(reqBody.toString(), 20000).value;
      } else if (reqBody instanceof FormData) {
        const items = [];
        reqBody.forEach((v, k) => items.push([k, (v && v.name) ? `File(${v.name})` : String(v)]));
        reqBodyPreview = items;
      } else if (reqBody instanceof Blob) {
        reqBodyPreview = `Blob(${reqBody.type || "unknown"}, ${reqBody.size} bytes)`;
      } else {
        reqBodyPreview = String(reqBody);
      }
    } catch (e) {
      reqBodyPreview = "[unreadable body]";
    }

    try {
      const resp = await origFetch(input, init);
      const endedAt = nowMs();
      const durationMs = Math.round((endedAt - startedAt) * 100) / 100;

      // Clone to avoid consuming body
      let respText = "";
      let respJson = null;
      let contentType = "";
      try {
        const clone = resp.clone();
        contentType = (clone.headers && clone.headers.get) ? (clone.headers.get("content-type") || "") : "";
        respText = await clone.text();
        if (contentType.includes("application/json")) {
          try { respJson = JSON.parse(respText); } catch (_) {}
        }
      } catch (e) {
        respText = "[unable to read response body]";
      }

      const t = truncate(respText, 50000);
      const entry = {
        ts: new Date().toISOString(),
        method: reqMethod,
        url: reqUrl,
        requestHeaders: reqHeaders,
        requestBody: reqBodyPreview,
        status: resp.status,
        ok: resp.ok,
        durationMs,
        responseContentType: contentType,
        responseBody: t.value
      };
      window.__acdApiLogs.push(entry);

      // Console output
      const badge = resp.ok ? "‚úÖ" : "‚ùå";
      console.groupCollapsed(`${badge} [API] ${reqMethod} ${reqUrl} ‚Üí ${resp.status} (${durationMs} ms)`);
      console.log("Request headers:", reqHeaders);
      if (reqBodyPreview !== undefined) console.log("Request body:", reqBodyPreview);
      console.log("Response content-type:", contentType);
      if (respJson !== null) console.log("Response JSON:", respJson);
      console.log("Response body:", t.value);
      if (t.truncated) console.warn("Response body truncated to 50,000 chars.");
      console.groupEnd();

      return resp;
    } catch (err) {
      const endedAt = nowMs();
      const durationMs = Math.round((endedAt - startedAt) * 100) / 100;
      const entry = {
        ts: new Date().toISOString(),
        method: reqMethod,
        url: reqUrl,
        requestHeaders: reqHeaders,
        requestBody: reqBodyPreview,
        error: String(err),
        durationMs
      };
      window.__acdApiLogs.push(entry);
      console.groupCollapsed(`üí• [API] ${reqMethod} ${reqUrl} ‚Üí NETWORK ERROR (${durationMs} ms)`);
      console.log("Request headers:", reqHeaders);
      if (reqBodyPreview !== undefined) console.log("Request body:", reqBodyPreview);
      console.error(err);
      console.groupEnd();
      throw err;
    }
  };
})();
// ===== Fix CSV line breaks (Windows compatible) =====
function normalizeCsvNewLines(csvString){
  if(!csvString) return csvString;
  // Normalise en CRLF (Excel Windows)
  return String(csvString).replace(/\\r?\\n/g, "\\r\\n");
}


// ===== Import JSON : Annuler (fermeture modale) =====
document.addEventListener("DOMContentLoaded", () => {
  const cancel = document.getElementById("btnImportJsonCancelLink");
  const modal = document.getElementById("importJsonModal");
  if(cancel && modal && !cancel.dataset.bound){
    cancel.dataset.bound = "1";
    cancel.addEventListener("click", (e) => {
      e.preventDefault();
      modal.setAttribute("aria-hidden","true");
      // optionnel: refermer la zone "Coller le JSON" si ouverte
      const pasteZone = document.getElementById("importJsonPasteZone");
      if(pasteZone) pasteZone.style.display = "none";
    });
  }
});

</script>


<style id="acd-session-right-patch">
/* =========================================================
   Layout fix: computed session values aligned to the right
   (applies to the on-screen session block)
   ========================================================= */
#sessionArea .sessionBox .sessionRow{
  display:flex !important;
  align-items:center !important;
  justify-content:space-between !important;
  gap:14px !important;
  padding:8px 0 !important;
  flex-wrap:nowrap !important;
}

#sessionArea .sessionBox .sessionKey{
  flex:1 1 auto !important;
  min-width:260px !important;
}

#sessionArea .sessionBox .sessionVal{
  flex:0 0 auto !important;
  margin-left:auto !important;
  text-align:right !important;
  max-width:70% !important;
  overflow-wrap:anywhere !important;
}

/* Narrow screens: allow wrap */
@media (max-width: 520px){
  #sessionArea .sessionBox .sessionRow{ flex-wrap:wrap !important; }
  #sessionArea .sessionBox .sessionVal{ max-width:100% !important; width:100% !important; text-align:left !important; }
}
</style>


<style>
.btnSidebarLink{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  background:#2d4f77;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.btnSidebarLink:hover{
  background:#3a6799;
}
</style>

<!-- Sidebar collapsed: keep ONLY the expand button visible -->
<style id="sidebar-collapsed-only-toggle">
  /* When collapsed, hide every sidebar block except the top toggle */
  body.sidebar-collapsed #sidebar > :not(.sidebarTop){
    display:none !important;
  }
  /* Compact the toggle button: icon only */
  body.sidebar-collapsed #sidebarToggle{
    width:48px !important;
    height:48px !important;
    padding:0 !important;
    border-radius:12px !important;
    justify-content:center !important;
  }
  body.sidebar-collapsed .sidebarToggleText{ display:none !important; }
</style>

</head>

<body>
<div class="layout">
<aside id="sidebar" aria-label="Console">

  <div class="sidebarTop">
    <button id="sidebarToggle" class="sidebarToggle" type="button" title="R√©duire / agrandir le panneau">
      <span class="sidebarToggleIcon">‚ò∞</span>
      <span class="sidebarToggleText">Console</span>
    </button>
  </div>

  <div><h1>DiagAPI</h1>
<div class="acd-version" style="font-size:14px;font-weight:600;margin-top:4px;opacity:.85;">V26.02-27</div>
      <div class="headerMeta"><div class="subtle" id="prettyVersion">‚Äî</div><div class="status"></div></div></div>
  
  <div class="headerInputs" aria-label="Informations export">
    <div class="inputsWrap">
      <div class="inputGroup">
        <div class="inputLabel">Code Agent</div>
        <input id="agentCodeInput" type="text" maxlength="6" placeholder="Code Agent" autocomplete="off" />
      </div>
      <div class="inputGroup">
        <div class="inputLabel">Ticket Zendesk</div>
        <input id="referenceInput" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="Ticket Zendesk" autocomplete="off" />
      </div>
      <div class="inputGroup">
        <div class="inputLabel">Code Cabinet</div>
        <input id="cabinetCodeInput" type="text" maxlength="10" placeholder="Code Cabinet" autocomplete="off" />
      </div>
    </div>
  </div>

  <div class="headerInputs" aria-label="Commentaire">
    <div class="inputsWrap">
      <div class="inputGroup" style="width:100%">
        <div class="inputLabel">Commentaire</div>
        <textarea id="commentaireInput" class="sidebarTextarea" maxlength="500" placeholder="Commentaire (optionnel)‚Ä¶"></textarea>
      </div>
    </div>
  
  <!-- üîó Liens rapides (Console Pro) -->
  <div class="sidebarLinksSection" aria-label="Liens rapides">
    <div class="sidebarSectionTitle">üîó Liens rapides</div>
    <div class="sidebarLinksBtns">
      <button type="button" class="copybtn" id="btnSwaggerSidebar" type="button" title="Ouvrir Swagger dans un nouvel onglet">SWAGGER</button>
      <button type="button" class="copybtn" id="btnZendeskSidebar" type="button" title="Ouvrir le ticket Zendesk (si renseign√©)">Ticket Zendesk</button>
    </div>
  </div>

</div>
<div class="headerActions" style="display:flex; align-items:center; gap:10px;">
  <span id="envBadge" class="env-badge env-client" title="Environnement : CLIENT">CLIENT</span>
  
  <button type="button" class="copybtn" id="btnCopyVarsHeader" title="Copier toutes les variables au format JSON">Export JSON</button>
  <button type="button" class="copybtn" id="btnImportVarsHeader" title="Importer un fichier JSON d\'export">Import JSON</button>
  <input type="file" id="importJsonFile" accept="application/json,.json" style="display:none" />
  <!-- Import JSON modal (fichier ou coller) -->
  <div id="importJsonModal" class="acd-modal" aria-hidden="true">
    <div class="acd-modal-backdrop" data-close="1"></div>
    <div class="acd-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="importJsonModalTitle">
      <div class="acd-modal-header">
        <div class="acd-modal-title" id="importJsonModalTitle">Importer un JSON</div>
        
      </div>
      <div class="acd-modal-body">
        <div class="row" style="margin-bottom:10px">
          <button type="button" class="btn" id="btnImportJsonChooseFile">Choisir un fichier‚Ä¶</button>
          <button type="button" class="btn btn-secondary" id="btnImportJsonPasteToggle">Coller le JSON</button>
        </div>

        <div id="importJsonPasteZone" style="display:none">
          <label for="importJsonTextarea" class="label-acd">JSON √† importer</label>
          <textarea id="importJsonTextarea" class="textarea-acd" rows="10" placeholder='{ "Meta": { ... }, "Identification": { ... } }'></textarea>
          <div class="row" style="margin-top:10px">
            <button type="button" class="btn" id="btnImportJsonFromText">Importer</button>
            <button type="button" class="btn btn-ghost" id="btnImportJsonClearText">Vider</button>
          </div>
          <div class="help" style="margin-top:8px">Astuce : vous pouvez coller un export complet (Meta/Identification/Session/Base‚Ä¶)
</div>
        </div>
      </div>
    </div>
      <div class="importModalFooter">
        <a href="#" id="btnImportJsonCancelLink" class="cancelLink">Annuler</a>
      </div>

  </div>

  <div class="themeToggle" title="Mode sombre">
    <span>Mode sombre</span>
    <div class="switch" id="themeSwitch" role="switch" aria-checked="false" tabindex="0">
      <div class="knob"></div>
    </div>
  </div>
</div>
</aside>
<main id="mainContent">
  
<div class="acd-section" id="sec-auth"><div class="acd-card-header"><div class="acd-section-title"><span class="acd-icon">üîê</span>1. Authentification</div></div><div class="acd-card-body">
<div class="card">

  <div class="tabs">
    <button class="tab active" id="tabLogin" type="button">Connexion</button>
    <button class="tab" id="tabUuid" type="button">Connexion par UUID</button>
  </div>

  <!-- Mode Connexion -->
  <div id="panelLogin">
    <div class="row">
      <label for="urlInput" class="label-acd">URL</label>
      <div class="urlRow">
        <div class="urlPresets">
          <button class="btn-secondary" id="btnTestProd" type="button">Test PROD</button>
          <button class="btn-secondary" id="btnTestAlpha" type="button">Test ALPHA</button>
          <button class="btn-secondary" id="btnTestLocal" type="button">Test LOCAL</button>
        </div>
        <input id="urlInput" class="input-plain" autocomplete="off" placeholder="http://localhost/cnx" />
      </div>
    </div>

    <div class="row">
      <div class="grid">
        <div class="input-group">
          <span class="input-icon">üë§</span>
          <input id="loginInput" autocomplete="username" placeholder=" " />
          <label for="loginInput">Identifiant</label>
          <button class="input-inline-btn" id="quickApiBtn" type="button" title="Renseigner automatiquement l'identifiant API">API</button>
        </div>

        <div class="input-group">
          <span class="input-icon">üîí</span>
          <input id="pwdInput" type="password" autocomplete="current-password" placeholder=" " />
          <label for="pwdInput">Mot de passe</label>
          <span class="password-toggle" id="btnTogglePwd" title="Afficher / masquer">üëÅ</span>
        </div>
      </div>

      <div id="rowEncryptPwd" class="encrypt-inline-row">
        <label class="encrypt-inline-label">
          <input type="checkbox" id="chkEncryptPwd" />
          <span>Chiffrer le mot de passe dans l'export JSON</span>
        </label>
      </div>
    </div>

    <div class="actions">
      <button class="primary btn-primary-acd" id="btnAuth" type="button">Valider</button>
      <button class="btn-secondary" id="btnClear" type="button">Effacer</button>
      <span class="status" id="status"></span>
    </div>
  </div>

  <!-- Mode Connexion par UUID -->
  <div id="panelUuid" class="hidden">
    <div class="row">
      <label for="urlInput2" class="label-acd">URL</label>
      <div class="urlRow">
        <div class="urlPresets">
          <button class="btn-secondary" id="btnTestProd2" type="button">Test PROD</button>
          <button class="btn-secondary" id="btnTestAlpha2" type="button">Test ALPHA</button>
          <button class="btn-secondary" id="btnTestLocal2" type="button">Test LOCAL</button>
        </div>
        <input id="urlInput2" class="input-plain" autocomplete="off" placeholder="http://localhost/cnx" />
      </div>
      <div class="hint" style="margin-top:6px;">Astuce : l'URL doit pointer vers le serveur i-Suite du cabinet.</div>
    </div>

    <div class="row">
      <label for="uuidInput" class="label-acd">UUID</label>
      <input id="uuidInput" class="input-plain" autocomplete="off" placeholder="UUID" />
    </div>

    <div class="actions">
      <button class="primary btn-primary-acd" id="btnUseUuid" type="button">Valider</button>
      <button class="btn-secondary" id="btnClear2" type="button">Effacer</button>
      <span class="status" id="status2"></span>
    </div>
  </div>
</div>


<div id="sessionArea" class="hidden">
  <div class="sessionHeader">
   
    <div class="actions" style="margin:0;">
      <span class="status" id="sessionStatus"></span>
    </div>
  </div>

  <div class="sessionBox">
    

    <div class="sessionRow">
      </div></div>

<div class="acd-section" id="sec-connected">
  <div class="card connectedCard">
    <div class="connectedHeader">
      <div class="connectedTitle"><span class="acd-icon">‚úÖ</span>Connexion √©tablie</div>

    </div>
    <div class="connectedBody">
	    <div class="acd-separator"></div>
	  <div style="margin-top:16px;">
    <div style="font-size:13px; font-weight:900; color:var(--muted); margin-bottom:6px;">Liens</div>
    <div class="actions" style="margin:0;">
      
      <button class="copybtn" id="btnTestComptaWeb" type="button">Test ComptaWeb</button>
      
    </div>
	    <div class="acd-separator"></div>
  </div>

    <div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>Version install√© / version disponible</strong></div>
      <div class="sessionVal" style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">
        <span id="sISuiteVersion">‚Äî</span>
      </div>
    </div>

<div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>UUID</strong></div>
      <div class="sessionVal" style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">
        <span id="sUuid">‚Äî</span>
        <button class="copybtn" id="copyUuidBtn" type="button">Copier</button>
        <button class="copybtn" id="uuidJsonBtn" type="button">JSON</button> <button class="copybtn" id="uuidPortalBtn" type="button" style="margin-left:6px;">Portail</button> <span id="uuidPortalBadge" class="pill hidden" style="margin-left:6px;">OK</span>
      </div>
    </div>
    <div class="acd-separator"></div>
<div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>Type de connexion</strong></div>
      <div class="sessionVal" id="sType" style="justify-self:end;text-align:right;display:inline-flex;justify-content:flex-end;align-items:center;">‚Äî</div>
    </div>
    <div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>ID de connexion</strong></div>
      <div class="sessionVal" id="sCode" style="justify-self:end;text-align:right;display:inline-flex;justify-content:flex-end;align-items:center;">‚Äî</div>
    </div>
    <div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>Nom</strong></div>
      <div class="sessionVal" id="sNom" style="justify-self:end;text-align:right;display:inline-flex;justify-content:flex-end;align-items:center;">‚Äî</div>
    </div>
    <div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>Pr√©nom</strong></div>
      <div class="sessionVal" id="sPrenom" style="justify-self:end;text-align:right;display:inline-flex;justify-content:flex-end;align-items:center;">‚Äî</div>
    </div>
    <div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>Cabinet d'affectation</strong></div>
      <div class="sessionVal" id="sCabinetAffectation" style="justify-self:end;text-align:right;display:inline-flex;justify-content:flex-end;align-items:center;">‚Äî</div>
    </div>
	 
    <div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>Dur√©e de session</strong></div>
      <div class="sessionVal" id="sTimeout" style="justify-self:end;text-align:right;display:inline-flex;justify-content:flex-end;align-items:center;">‚Äî</div>
    </div>

    <div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>S√©curit√©s fonctionnelles</strong></div>
      <div class="sessionVal" style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">
        <span id="sNbSecurites">‚Äî</span>
        <button class="copybtn" id="btnSecuritesDetail" type="button">D√©tail</button>
        <button class="copybtn" id="btnSecuritesJson" type="button">JSON</button>
      </div>
    </div>
    <div class="acd-separator"></div>
    <div id="securitesTableWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table style="width:100%; border-collapse:collapse; min-width:720px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Code</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Libell√©</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Code Parent</th>
            </tr>
          </thead>
          <tbody id="securitesTbody"></tbody>
        </table>
      </div>
    </div>
    <div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>Nombre de dossiers visibles</strong></div>
      <div class="sessionVal" style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">
        <span id="sNbDossiers">‚Äî</span>
        <button class="copybtn" id="btnDossiersDetail" type="button">D√©tail</button>
		        <button class="copybtn" id="btnDossiersCsv" type="button">CSV</button>
        <button class="copybtn" id="btnDossiersJson" type="button">JSON</button>

      </div>
    </div>

    <div id="dossiersTableWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table style="width:100%; border-collapse:collapse; min-width:860px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Id</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Code</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Nom</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Genre</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Cabinet</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Siret</th>
            </tr>
          </thead>
          <tbody id="dossiersTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>Nombre de cabinets visibles</strong></div>
      <div class="sessionVal" style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">
        <span id="sNbCabinets">‚Äî</span>
        <button class="copybtn" id="btnCabinetsDetail" type="button">D√©tail</button>
        
        <button class="copybtn" id="btnCabinetsCsv" type="button">CSV</button><button class="copybtn" id="btnCabinetsJson" type="button">JSON</button>
      </div>
    </div>

    <div id="cabinetsTableWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table style="width:100%; border-collapse:collapse; min-width:720px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Code</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Nom</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Siret</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Ville</th>
            </tr>
          </thead>
          <tbody id="cabinetsTbody"></tbody>
        </table>
      </div>
    </div>

<div class="acd-separator"></div>
<div class="sessionRow" style="display:grid;grid-template-columns:260px 1fr;align-items:center;gap:14px;">
      <div class="sessionKey"><strong>Dossier en cours</strong></div>
<div class="sessionVal" style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">
        <span id="sDossierEnCours">‚Äî</span>
        <button class="copybtn btn-primary-acd btn-primary-acd" id="copyDossierBtn" type="button">R√©cup√©rer</button>
      </div>
    </div>


  </div>

  

    </div>
  </div>
</div>

<div id="afterAuth" class="hidden">
  <h2>2. Informations Dossier</h2>
  <div class="grid">
    <div class="row">
      <label>Code dossier</label>
      <input id="dossierInput" autocomplete="off" />
    </div>
    <div class="row">
      <label>&nbsp;</label>
      <div class="actions">
        <button class="primary" id="btnDossier" type="button" disabled>Valider le dossier</button>
        <span class="status" id="dossierStatus"></span>
      </div>
    </div>
  </div>

  
<div id="afterDossierSection" class="hidden">
<h2>Informations du dossier</h2>
        <button class="copybtn" id="dossierSessionJsonBtn" type="button" style="margin-left:10px;">JSON</button>
  <pre id="dossierInfoBox">‚Äî</pre>

  <h2>Param√©trage comptable</h2>
    <div style="margin-bottom:8px;">
      <button class="copybtn" id="btnComptaDossierJson" type="button">JSON</button>
    </div>
  <span class="status" id="comptaStatus"></span>

  <div class="kv" style="margin-top:10px;">
    <div class="kv-row isuite-highlight">
      <div class="kv-key">Dossier publi√© sur iSuite</div>
      <div class="kv-val"><span class="badge na" id="bPublie">N/A</span></div>
    </div>

    <div class="kv-row">
      <div class="kv-key">Longueur des comptes</div>
      <div class="kv-val"><span id="vLongueur">‚Äî</span></div>
    </div>
    <div class="kv-row">
      <div class="kv-key">Codes TVA</div>
      <div class="kv-val">
        <span id="nbCodesTva">‚Äî</span>
        <button class="copybtn" id="codesTvaDetailBtn" type="button" style="margin-left:6px;">D√©tail</button>
        
        <button class="copybtn" id="codesTvaCsvBtn" type="button" style="margin-left:6px;">CSV</button><button class="copybtn" id="codesTvaJsonBtn" type="button" style="margin-left:6px;">JSON</button>
      </div>
    </div>

    <div id="codesTvaTableWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table id="codesTvaTable" style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Code</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Libell√©</th>
              <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border);">Taux</th>
            </tr>
          </thead>
          <tbody id="codesTvaTbody"></tbody>
        </table>
      </div>
    </div>

<div class="kv-row">
      <div class="kv-key">Gestion du num√©ro de facture</div>
      <div class="kv-val"><span class="badge na" id="bFacture">N/A</span></div>
    </div>

    <div class="kv-row">
      <div class="kv-key">Gestion des quantit√©s</div>
      <div class="kv-val"><span class="badge na" id="bQte">N/A</span>
        <button class="copybtn" id="qteDetailBtn" type="button" style="margin-left:6px;">D√©tail</button>
        <button class="copybtn" id="qteCsvBtn" type="button" style="margin-left:6px;">CSV</button>
        <button class="copybtn" id="qteJsonBtn" type="button" style="margin-left:6px;">JSON</button>
      </div>
    </div>
<div id="qteTableWrap" class="hidden" style="margin-top:8px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table id="qteTable" style="width:100%; border-collapse:collapse; font-size:12px; min-width:720px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Code</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Libell√©</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">PrixUnitMin</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">PrixUnitMax</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">QuantiteMin</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">QuantiteMax</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">NbreDecimale</th>
            </tr>
          </thead>
          <tbody id="qteTbody"></tbody>
        </table>
      </div>
    </div>



    

    <div class="kv-row">
      <div class="kv-key">Gestion de l‚Äô√©ch√©ancier</div>
      <div class="kv-val"><span class="badge na" id="bEch">N/A</span></div>
    </div>

    <div class="kv-row">
      <div class="kv-key">Gestion de l‚Äôanalytique</div>
      <div class="kv-val">
        <span class="badge na" id="bAna">N/A</span>
        <button class="copybtn" id="anaSectionsDetailBtn" type="button" style="margin-left:6px;">D√©tail</button>
        <button class="copybtn" id="anaSectionsCsvBtn" type="button" style="margin-left:6px;">CSV</button>
        <button class="copybtn" id="anaSectionsJsonBtn" type="button" style="margin-left:6px;">JSON</button>
      </div>
    </div>
    <div id="anaSectionsTableWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table id="anaSectionsTable" style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">SEC_LIB</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">SEC_N1</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">SEC_N2</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">SEC_N3</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Sections</th>
            </tr>
          </thead>
          <tbody id="anaSectionsTbody"></tbody>
        </table>
      </div>
    </div>

    <div id="anaDetails" class="hidden">
      <div class="subTitle">Param√©trage analytique</div>

      <div class="kv-row">
        <div class="kv-key">Gestion non hi√©rarchis√©e</div>
        <div class="kv-val"><span class="badge na" id="bAnaNonHier">N/A</span></div>
      </div>

      <div class="kv-row">
        <div class="kv-key">Nombre de niveaux</div>
        <div class="kv-val"><span id="vAnaNiveaux">‚Äî</span></div>
      </div>

      <div class="kv-row">
        <div class="kv-key">Compte de charges</div>
        <div class="kv-val"><span class="badge na" id="bAnaCharges">N/A</span></div>
      </div>

      <div class="kv-row">
        <div class="kv-key">Compte de produits</div>
        <div class="kv-val"><span class="badge na" id="bAnaProduits">N/A</span></div>
      </div>

      <div class="kv-row">
        <div class="kv-key">Compte de bilan</div>
        <div class="kv-val"><span class="badge na" id="bAnaBilan">N/A</span></div>
      </div>
    </div>
  </div>



  
  
  
  <div id="donneesComptablesCard" class="hidden">
    <h2>Donn√©es comptable</h2>
    <span class="status" id="donneesComptablesStatus">S√©lectionnez un exercice puis cliquez sur Calculer.</span>

    <div class="kv" style="margin-top:10px;">
      
    <div class="kv-row">
      <div class="kv-key">Exercice par d√©faut</div>
      <div class="kv-val">
        <span id="vExerciceDefaut">‚Äî</span>
        <button class="copybtn" id="btnExercicesDetail" type="button" style="margin-left:6px;">D√©tail</button>
        <button class="copybtn" id="btnExercicesJson" type="button" style="margin-left:6px;">JSON</button>
      </div>
    </div>

    <div id="exercicesTableWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table id="exercicesTable" style="width:100%; border-collapse:collapse; min-width:520px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Date d√©but</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Date fin</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Courant</th>
            </tr>
          </thead>
          <tbody id="exercicesTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="kv-row">
      <div class="kv-key">Nombre de journaux</div>
      <div class="kv-val">
        <span id="vNbJournaux">‚Äî</span>
        <button class="copybtn" id="btnJournauxDetail" type="button" style="margin-left:6px;">D√©tail</button>
        
        <button class="copybtn" id="btnJournauxCsv" type="button" style="margin-left:6px;">CSV</button><button class="copybtn" id="btnJournauxJson" type="button" style="margin-left:6px;">JSON</button>
      </div>
    </div>

    <div id="journauxTableWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table id="journauxTable" style="width:100%; border-collapse:collapse; min-width:820px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Code</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Libell√©</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Nature</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">TypeDeSaisie</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">CompteDeTresorerie</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">NumeroFacture</th>
            </tr>
          </thead>
          <tbody id="journauxTbody"></tbody>
        </table>
      </div>
</div>



    
    <div class="kv-row">
      <div class="kv-key">Comptes g√©n√©raux</div>
      <div class="kv-val">
        <span id="vNbComptesGeneraux">‚Äî</span>
        <button class="copybtn" id="btnComptesGenerauxDetail" type="button" style="margin-left:6px;">D√©tail</button>
        
        <button class="copybtn" id="btnComptesGenerauxCsv" type="button" style="margin-left:6px;">CSV</button><button class="copybtn" id="btnComptesGenerauxJson" type="button" style="margin-left:6px;">JSON</button>
      </div>
    </div>

    <div id="comptesGenerauxWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table style="width:100%; border-collapse:collapse; min-width:640px;">
          <thead><tr id="comptesGenerauxHead"></tr></thead>
          <tbody id="comptesGenerauxBody"></tbody>
        </table>
      </div>
    </div>

    <div class="kv-row">
      <div class="kv-key">Comptes clients</div>
      <div class="kv-val">
        <span id="vNbComptesClients">‚Äî</span>
        <button class="copybtn" id="btnComptesClientsDetail" type="button" style="margin-left:6px;">D√©tail</button>
        
        <button class="copybtn" id="btnComptesClientsCsv" type="button" style="margin-left:6px;">CSV</button><button class="copybtn" id="btnComptesClientsJson" type="button" style="margin-left:6px;">JSON</button>
      </div>
    </div>

    <div id="comptesClientsWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table style="width:100%; border-collapse:collapse; min-width:640px;">
          <thead><tr id="comptesClientsHead"></tr></thead>
          <tbody id="comptesClientsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="kv-row">
      <div class="kv-key">Comptes fournisseurs</div>
      <div class="kv-val">
        <span id="vNbComptesFournisseurs">‚Äî</span>
        <button class="copybtn" id="btnComptesFournisseursDetail" type="button" style="margin-left:6px;">D√©tail</button>
        
        <button class="copybtn" id="btnComptesFournisseursCsv" type="button" style="margin-left:6px;">CSV</button><button class="copybtn" id="btnComptesFournisseursJson" type="button" style="margin-left:6px;">JSON</button>
      </div>
    </div>

    <div id="comptesFournisseursWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table style="width:100%; border-collapse:collapse; min-width:640px;">
          <thead><tr id="comptesFournisseursHead"></tr></thead>
          <tbody id="comptesFournisseursBody"></tbody>
        </table>
      </div>
    </div>


<div class="row" style="margin-top:0;">
        <div class="field" style="flex:1;">
          <label>Exercice</label>
          <select id="selectExercice" class="input"></select>
        </div>
        <div class="actions" style="align-self:flex-end;">
          <button class="primary" id="btnCalculerBalance" type="button">Calculer</button>
        </div>
      </div>

      <div class="kv-row" style="margin-top:10px;">
        <div class="kv-key">Balance</div>
        <div class="kv-val">
          <span id="vNbBalance">‚Äî</span> comptes
          <button class="copybtn" id="btnBalanceDetail" type="button" style="margin-left:6px;">D√©tail</button>
          <button class="copybtn" id="btnBalanceJson" type="button" style="margin-left:6px;">JSON</button>
        </div>
      </div>

	  
	              <div class="kv-row">
        <div class="kv-key">Grand livre g√©n√©raux</div>
        <div class="kv-val" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <span class="mono" id="glGenInfo">‚Äî</span>
          <button class="copybtn" id="btnGLGenerauxCsv" type="button" disabled>CSV</button>
          <button class="copybtn" id="btnGLGenerauxJson" type="button" disabled>JSON</button>
        </div>
      </div>

 

      </div>
      </div>

      <div class="kv-row">
        <div class="kv-key">Grand livre clients</div>
        <div class="kv-val" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <span class="mono" id="glCliInfo">‚Äî</span>
          <button class="copybtn" id="btnGLClientsCsv" type="button" disabled>CSV</button>
          <button class="copybtn" id="btnGLClientsJson" type="button" disabled>JSON</button>
        </div>
      </div>

      <div class="kv-row">
        <div class="kv-key">Grand livre fournisseurs</div>
        <div class="kv-val" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <span class="mono" id="glFouInfo">‚Äî</span>
          <button class="copybtn" id="btnGLFournisseursCsv" type="button" disabled>CSV</button>
          <button class="copybtn" id="btnGLFournisseursJson" type="button" disabled>JSON</button>
        </div>
      </div>
	  
	  
      <div class="kv-row">
        <div class="kv-key"></div>
        <div class="kv-val">
          <button class="copybtn" id="btnDownloadFec" type="button">FEC</button>
        </div>
      </div>
	  
	        <div class="kv-row">
        <div class="kv-key">R√©sultat debuit Balance</div>
        <div class="kv-val">
          <span id="vResultat">‚Äî</span>
        </div>
      </div>
	  
	       <div class="kv-row">
        <div class="kv-key">R√©sultat depuis Grand livre</div>
        <div class="kv-val"><span id="vResultatGL">‚Äî</span></div>
      </div>

      <div class="kv-row" id="rowResultatGL">
        <div class="kv-key">Ecart</div>
        <div class="kv-val" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <span id="vEcartGLBalance" class="mono" style="opacity:.9;">‚Äî</span>
          <span id="bulleEcartGLBalance" style="display:inline-flex;align-items:center;justify-content:center;min-width:34px;height:22px;padding:0 10px;border-radius:999px;font-weight:700;font-size:12px;background:#334155;color:#e2e8f0;">‚Äî</span>
        </div>
      </div>

	  
	  
	  
    </div>

    <div id="balanceTableWrap" class="hidden" style="margin-top:10px;">
      <div style="overflow:auto; border:1px solid var(--border); border-radius:14px;">
        <table style="width:100%; border-collapse:collapse; min-width:700px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Compte</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">Libell√©</th>
              <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border);">D√©bit</th>
              <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border);">Cr√©dit</th>
              <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border);">Solde</th>
            </tr>
          </thead>
          <tbody id="balanceTbody"></tbody>
        </table>
      </div>
    </div>
  </div>



  

</div>

<script>
  function parseMaybeJson(raw) {
    if (raw === null || raw === undefined) return raw;
    if (typeof raw !== "string") return raw;
    const t = raw.trim();
    if (!t) return t;
    // Try JSON
    if ((t.startsWith("{") && t.endsWith("}")) || (t.startsWith("[") && t.endsWith("]"))) {
      try { return JSON.parse(t); } catch { return raw; }
    }
    // Try number
    if (/^-?\d+(?:\.\d+)?$/.test(t)) {
      const n = Number(t);
      if (!Number.isNaN(n)) return n;
    }
    return raw;
  }

  function getTextById(id) {
    const el = $(id);
    if (!el) return "";
    const v = (el.value ?? el.textContent ?? "").toString();
    return v.trim();
  }
  let gedEventsBound = false;

  const $ = (id) => document.getElementById(id);

  // Helper global : √©vite les erreurs "setText is not defined" si utilis√© dans plusieurs fonctions
  const setText = (id, v) => {
    const el = $(id);
    if (!el) return;
    el.textContent = (v === null || v === undefined) ? "‚Äî" : String(v);
  };


  function pad2(n){ return String(n).padStart(2,'0'); }

  function formatTsForFilename(d){
    const dt = (d instanceof Date) ? d : new Date(d);


    return `${dt.getFullYear()}_${pad2(dt.getMonth()+1)}_${pad2(dt.getDate())}_${pad2(dt.getHours())}${pad2(dt.getMinutes())}${pad2(dt.getSeconds())}`;
  }

  // --- Helpers GL r√©sultat (6/7) ---
  function formatNumberFR(n) {
    const v = Number(n);
    if (!Number.isFinite(v)) return '0';
    return v.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function computeResultatDepuisGL(glArray) {
    // Attend un tableau d'objets du type { CptCptCol, DebE, CreE, ... }
    if (!Array.isArray(glArray)) return 0;
    let sum = 0;
    for (const row of glArray) {
      if (!row) continue;
      const cpt = String(row.CptCptCol ?? row.Cpt ?? row.Compte ?? '').trim();
      if (!(cpt.startsWith('6') || cpt.startsWith('7'))) continue;
      const deb = Number(row.DebE ?? row.Deb ?? row.Debit ?? 0) || 0;
      const cre = Number(row.CreE ?? row.Cre ?? row.Credit ?? 0) || 0;
      sum += (cre - deb);
    }
    return sum;
  }
  // --- /Helpers GL r√©sultat (6/7) ---


  function getRegistrableDomainFromUrl(urlStr){
    try{
      const u = new URL(String(urlStr || '').trim());
      const host = (u.hostname || '').toLowerCase();
      const parts = host.split('.').filter(Boolean);
      if(parts.length >= 2) return parts.slice(-2).join('.');
      return host || '';
    }catch{
      return '';
    }
  }

  function getEnvironmentFromUrl(url){
    try{
      const u = String(url || '').trim();
      if(!u) return '--';

      const host = (new URL(u)).hostname.toLowerCase();

      // LOCAL si domaine suiteexpert.fr
      if(host.endsWith('suiteexpert.fr')) return 'LOCAL';

      // LOCAL si localhost / loopback
      if(host === 'localhost' || host === '127.0.0.1' || host === '::1') return 'LOCAL';

      // LOCAL si IP priv√©e (RFC1918) ou link-local (169.254.0.0/16)
      const ipv4 = host.match(/^\d{1,3}(?:\.\d{1,3}){3}$/);
      if(ipv4){
        const parts = host.split('.').map(n => parseInt(n, 10));
        const [a,b] = parts;

        const isValid = parts.every(n => Number.isInteger(n) && n >= 0 && n <= 255);
        if(isValid){
          const is10 = (a === 10);
          const is192_168 = (a === 192 && b === 168);
          const is172_16_31 = (a === 172 && b >= 16 && b <= 31);
          const is169_254 = (a === 169 && b === 254);
          if(is10 || is192_168 || is172_16_31 || is169_254) return 'LOCAL';
        }
      }

      return 'CLIENT';
    }catch(e){
      // URL non parseable : par d√©faut CLIENT (sauf si vide d√©j√† g√©r√©)
      return 'CLIENT';
    }
  }


  function updateEnvBadge(){
    try{
      const url = ($("urlInput")?.value || "").trim();
      const env = getEnvironmentFromUrl(url);
      const el = $("envBadge");
      if(!el) return;
      el.textContent = env;
      el.classList.toggle("env-local", env === "LOCAL");
      el.classList.toggle("env-client", env === "CLIENT");
      el.title = "Environnement : " + env;
    }catch(e){}
  
  try{ if(typeof updateEncryptCheckboxByEnv==='function') updateEncryptCheckboxByEnv(); }catch(e){}
}

  // --- R√©sultats Balance vs Grand livre (comparaison) ---
  let lastResultBalance = null;
  let lastResultGL = null;

  function formatEuroSafe(value){
    const n = Number(value);
    if (!Number.isFinite(n)) return "‚Äî";
    return formatNumberFR(n) + " ‚Ç¨";
  }

  function setRowError(rowValueId, apiError) {
    const el = document.getElementById(rowValueId);
    if (!el) return;

    const msg =
      apiError?.body?.Message ||
      apiError?.body?.message ||
      apiError?.Message ||
      apiError?.message ||
      "Erreur API inconnue";

    el.innerHTML =
      `<span style="display:inline-flex;align-items:center;gap:6px;">
        <span style="font-size:14px;">‚ö†Ô∏è</span>
        <span>Erreur : ${escapeHtml(String(msg))}</span>
      </span>`;

    el.style.color = "#dc2626";
    el.style.fontWeight = "600";
    try { el.title = JSON.stringify(apiError, null, 2); } catch { /* noop */ }
  }

  function setSpanError(spanId, label, apiError){
    const el = document.getElementById(spanId);
    if(!el) return;

    const msg =
      apiError?.body?.Message ||
      apiError?.body?.message ||
      apiError?.Message ||
      apiError?.message ||
      "Erreur API inconnue";

    el.innerHTML = `<span style="display:inline-flex;align-items:center;gap:6px;">
      <span style="font-size:14px;">‚ö†Ô∏è</span>
      <span>${escapeHtml(label)} : ${escapeHtml(String(msg))}</span>
    </span>`;
    el.style.color = "#dc2626";
    el.style.fontWeight = "600";
    try { el.title = JSON.stringify(apiError, null, 2); } catch { /* noop */ }
  }

  function updateEcartGLBalance(){
    const ecartEl = document.getElementById("vEcartGLBalance");
    const bulleEl = document.getElementById("bulleEcartGLBalance");
    if(!ecartEl || !bulleEl) return;

    if(!Number.isFinite(Number(lastResultBalance)) || !Number.isFinite(Number(lastResultGL))){
      ecartEl.textContent = "‚Äî";
      bulleEl.textContent = "‚Äî";
      bulleEl.style.background = "#334155";
      bulleEl.style.color = "#e2e8f0";
      return;
    }

    const ecart = Number(lastResultGL) - Number(lastResultBalance);
    ecartEl.textContent = formatEuroSafe(ecart);

    const tolerance = 0.01; // 1 centime
    const ok = Math.abs(ecart) < tolerance;

    bulleEl.textContent = ok ? "OK" : "NO";
    bulleEl.style.background = ok ? "#16a34a" : "#dc2626";
    bulleEl.style.color = "#ffffff";
  }
  // --- /R√©sultats Balance vs Grand livre (comparaison) ---



  const TOOL_VERSION = 'V26.02-23.25_STABLE_v30_comptaweb_cab_storage_fixed';

  function buildExportJsonFilename(payload, now){
    // R√®gle de nommage :
    // - AAAAMMJJ_HHMM = date/heure de g√©n√©ration
    // - Si TicketZendesk est vide : APIACD_<CodeAgent>_AAAAMMJJ_HHMM.json
    // - Sinon : APIACD_<CodeAgent>_<TicketZendesk>_AAAAMMJJ_HHMM.json

    const dt = (now instanceof Date) ? now : new Date(now || Date.now());
    const pad = (n) => String(n).padStart(2, "0");
    const ts = dt.getFullYear().toString()
      + pad(dt.getMonth() + 1)
      + pad(dt.getDate()) + "_"
      + pad(dt.getHours())
      + pad(dt.getMinutes());

    const codeAgentRaw = String(payload?.Meta?.CodeAgent || "").trim();
    const ticketRaw = String(payload?.Meta?.TicketZendesk || "").trim();

    // S√©curisation l√©g√®re (compatibilit√© Windows)
    const safe = (s) => String(s || "")
      .replace(/[\\/:*?"<>|]+/g, "_")
      .replace(/\s+/g, "_")
      .replace(/^_+|_+$/g, "");
    const codeAgent = safe(codeAgentRaw) || "CodeAgent";
    const ticketZendesk = safe(ticketRaw);

    return ticketZendesk
      ? `APIACD_${codeAgent}_${ticketZendesk}_${ts}.json`
      : `APIACD_${codeAgent}_${ts}.json`;
  }

  // Utilis√© par les exports CSV/JSON (Codes TVA, Sections analytiques, etc.)
  // Construit un nom de fichier coh√©rent avec la r√®gle m√©tier d'export JSON.
  


function makeExportFilename(ext, suffix) {
  try {
    const now = new Date();
    const pad = (n) => String(n).padStart(2, "0");

    const yy = pad(now.getFullYear() % 100);
    const mm = pad(now.getMonth() + 1);
    const dd = pad(now.getDate());
    const hh = pad(now.getHours());
    const mi = pad(now.getMinutes());

    // Format demand√© : AAMMJJ_HHMM (CSV + JSON)
    const timestampShort = `${yy}${mm}${dd}_${hh}${mi}`;

    let safeExt = (ext || "").replace(".", "").trim().toLowerCase();
    let safeSuffix = (suffix || "").trim();

    // Correction automatique si param√®tres invers√©s
    const knownExt = ["csv", "json", "txt"];
    if (!knownExt.includes(safeExt) && knownExt.includes(safeSuffix.toLowerCase())) {
      const tmp = safeExt;
      safeExt = safeSuffix.toLowerCase();
      safeSuffix = tmp;
    }

    const codeAgentVal = (document.getElementById("agentCodeInput")?.value || "").trim();
    const codeCabinetVal = (document.getElementById("cabinetCodeInput")?.value || "").trim();
    const ticketVal = (document.getElementById("referenceInput")?.value || "").trim();

    const safe = (s) => (s || "").toString().trim().replace(/[^a-zA-Z0-9_-]/g, "_");

    // --- R√®gle uniforme CSV + JSON ---
    // APIACD_<CodeAgent>_<CodeCabinet>_<TicketZendesk>_<NomEdition>_AAMMJJ_HHMM.<ext>
    // Segments vides omis (CodeAgent, CodeCabinet, TicketZendesk).
    if (safeExt === "csv" || safeExt === "json") {
      const parts = ["APIACD"];
      if (safe(codeAgentVal)) parts.push(safe(codeAgentVal));
      if (safe(codeCabinetVal)) parts.push(safe(codeCabinetVal));
      if (safe(ticketVal)) parts.push(safe(ticketVal));
      parts.push(safe(safeSuffix) || "export");
      parts.push(timestampShort);
      return parts.join("_") + "." + safeExt;
    }

    // --- Fallback autres formats ---
    const yyyy = now.getFullYear().toString();
    const timestampStd = `${yyyy}${mm}${dd}_${hh}${mi}`;
    const baseParts = ["APIACD"];
    if (safe(codeAgentVal)) baseParts.push(safe(codeAgentVal));
    if (safe(codeCabinetVal)) baseParts.push(safe(codeCabinetVal));
    if (safe(ticketVal)) baseParts.push(safe(ticketVal));
    baseParts.push(timestampStd);

    const baseName = baseParts.join("_");
    return safeSuffix
      ? `${baseName}_${safe(safeSuffix)}.${safeExt || "txt"}`
      : `${baseName}.${safeExt || "txt"}`;

  } catch (e) {
    return `APIACD_export.${(ext || "txt").replace(".", "")}`;
  }
}




// Cl√©s de persistance (Code Agent)
const ACD_COOKIE_CODE_AGENT = "ACD_CodeAgent";
const ACD_LS_CODE_AGENT = "ACD_CodeAgent";


function getCookie(name){
  try{
    const cookies = document.cookie ? document.cookie.split(";") : [];
    const prefix = name + "=";
    for (let c of cookies){
      c = c.trim();
      if (c.indexOf(prefix) === 0) return decodeURIComponent(c.substring(prefix.length));
    }
  }catch(e){}
  return "";
}


// Code Cabinet : PAS de persistance (ni cookie, ni localStorage)
function loadCodeCabinetPersisted(){ return ""; }
function saveCodeCabinetPersisted(value){ /* no persistence */ }
function loadCodeAgentPersisted() {
  // Code Agent : persistance via cookie (prioritaire) + fallback localStorage
  try {
    const fromCookie = getCookie(ACD_COOKIE_CODE_AGENT);
    if (fromCookie && fromCookie.trim() !== "") return fromCookie;
  } catch (e) {}
  try {
    const fromLs = localStorage.getItem(ACD_LS_CODE_AGENT);
    if (fromLs && fromLs.trim() !== "") return fromLs;
  } catch (e) {}
  return "";
}

function saveCodeAgentPersisted(value) {
  // Code Agent : persistance via cookie + localStorage
  const v = (value || "").trim();
  try {
    // 365 jours
    document.cookie = `${ACD_COOKIE_CODE_AGENT}=${encodeURIComponent(v)}; path=/; max-age=${60 * 60 * 24 * 365}; SameSite=Lax`;
  } catch (e) {}
  try { localStorage.setItem(ACD_LS_CODE_AGENT, v); } catch (e) {}
}

// Mise √† jour apr√®s recalcul du badge
function updateEncryptCheckboxByEnv(){
  try{
    const chk = document.getElementById("chkEncryptPwd");
    const urlEl = document.getElementById("urlInput") || document.getElementById("urlInput2");
    if(!chk || !urlEl) return;

    const url = (urlEl.value || "").toLowerCase().trim();

    // URL vide : √©tat neutre => d√©coch√©e et modifiable
    if(!url){
      chk.checked = false;
      chk.disabled = false;
      return;
    }

    // Align√© avec le badge environnement (m√™me logique)
    const env = (typeof getEnvironmentFromUrl === "function") ? getEnvironmentFromUrl(url) : "--";
    const isLocal = (env === "LOCAL") ||
      url.includes("localhost") ||
      url.includes("127.0.0.1") ||
      url.includes("suiteexpert.fr");

    // R√®gle demand√©e :
    // - CLIENT : coch√©e + non modifiable
    // - LOCAL  : d√©coch√©e + modifiable
    if(isLocal){
      chk.checked = false;
      chk.disabled = false;
    }else{
      chk.checked = true;
      chk.disabled = true;
    }
  }catch(e){
    // no-op (ne pas casser le reste du script)
  }
}

document.addEventListener("DOMContentLoaded", updateEncryptCheckboxByEnv);

// R√©cup√©ration + sauvegarde automatique du Code Agent (cookie + localStorage)


document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("agentCodeInput");
  if (!input) return;

  // Hydratation au chargement
  const saved = loadCodeAgentPersisted();
  if (saved) input.value = saved;

  // Persistance √† la saisie
  input.addEventListener("input", () => {
    saveCodeAgentPersisted(input.value);
  });

    // Code Cabinet persistence
    try {
      const cabInput = document.getElementById("cabinetCodeInput");
      if (cabInput) {
        const cabSaved = loadCodeCabinetPersisted();
        if (cabSaved) cabInput.value = cabSaved;
        cabInput.addEventListener("input", () => saveCodeCabinetPersisted(cabInput.value));
      }
    } catch (e) {}

});
function normalizeRowsForCsv(data){
    // Accept Array, single object, or a JSON string
    if(data == null) return [];
    if(Array.isArray(data)) return data;

    if(typeof data === "string"){
      try{
        const parsed = JSON.parse(data);
        return Array.isArray(parsed) ? parsed : [parsed];
      }catch(e){
        return [{ value: data }];
      }
    }

    if(typeof data === "object") return [data];
    return [{ value: String(data) }];
  }


  function rowsToCsv(rows){
    if(!rows || !rows.length) return "";

    const headers = Object.keys(rows.reduce((acc, row) => {
      Object.keys(row || {}).forEach(k => acc[k] = true);
      return acc;
    }, {}));

    const escape = (v) => {
      if(v === null || v === undefined) return "";
      const s = String(v);
      if(/[;"]/.test(s)){
        return '"' + s.replace(/"/g,'""') + '"';
      }
      return s;
    };

    const lines = [];
    lines.push(headers.join(";"));

    rows.forEach(row => {
      const line = headers.map(h => escape(row[h])).join(";");
      lines.push(line);
    });

    return lines.join("\r\n") + "\r\n";
  }

function downloadCsvFile(data, filename){
  const rows = normalizeRowsForCsv(data);
  const csv = rowsToCsv(rows);

// IE / old Edge
  try{
    if(window.navigator && window.navigator.msSaveOrOpenBlob){
      const blob = new Blob(["\ufeff"+csv], {type:"text/csv;charset=utf-8"});
      window.navigator.msSaveOrOpenBlob(blob, filename || ("export_" + Date.now() + ".csv"));
      return;
    }
  }catch(e){}

  const blob = new Blob(["\ufeff"+csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename || ("export_" + Date.now() + ".csv");
  a.style.display = "none";
  a.rel = "noopener";
  document.body.appendChild(a);

  // Ensure we are within a user gesture: use rAF then click.
  const doClick = () => {
    try{ a.click(); }
    catch(e){
      try{ a.dispatchEvent(new MouseEvent("click", { bubbles:true, cancelable:true, view:window })); }
      catch(e2){
        // Ultimate fallback: open the blob URL
        try{ window.open(url, "_blank", "noopener"); }catch(e3){}
      }
    }
    document.body.removeChild(a);
    setTimeout(() => { try{ URL.revokeObjectURL(url); }catch(e){} }, 5000);
  };

  try{ requestAnimationFrame(doClick); }
  catch(e){ doClick(); }
}

  // Format: YYYY-MM-DDTHH:mm:ss (local time, no timezone suffix)
  function formatLocalDateTime(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}:${pad2(dt.getSeconds())}`;
  }

  // Format: DD/MM/YYYY HH:mm:ss (local time)
  function formatLocalDateTimeFr(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    return `${pad2(dt.getDate())}/${pad2(dt.getMonth()+1)}/${dt.getFullYear()} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}:${pad2(dt.getSeconds())}`;
  }


  let lastExercicesJson = null;
  let exercicesList = [];
  let lastBalanceJson = null;
    lastBalanceCurl = "";
  
  let lastGrandLivreGenerauxJson = null;
  let lastGrandLivreClientsJson = null;
  let lastGrandLivreFournisseursJson = null;
  let lastDossiersJson = null;
  let lastSessionDossierJson = null;
  let lastCabinetsJson = null;
  let lastInfosJson = null;
  let lastAuthJson = null;
      let lastSecuritesJson = null;
  let lastComptaDossierConfigJson = null;
  let lastJournauxJson = null;
  let lastComptesGenerauxJson = null;
  let lastComptesClientsJson = null;
  let lastComptesFournisseursJson = null;
  let lastCodesTvaJson = null;
  let lastAnaSectionsJson = null;
  // --- Derni√®res commandes cURL par endpoint (pour la fen√™tre JSON) ---
  let lastSecuritesCurl = "";
  let lastDossiersVisiblesCurl = "";
  let lastCabinetsVisiblesCurl = "";
  let lastExerciceDefautCurl = "";
  let lastJournauxCurl = "";
  let lastComptesGenerauxCurl = "";
  let lastComptesClientsCurl = "";
  let lastComptesFournisseursCurl = "";


  let storedUUID = sessionStorage.getItem("ACD_UUID") || "";
  let lastComptaDossierJson = null;
  let storedBaseApi = sessionStorage.getItem("ACD_BASE_API") || "";

  // --- Export JSON helpers (global scope) ---
  // R√©cup√®re /v1/compta/dossier et alimente lastComptaDossierJson pour l'export JSON.
  // (D√©clar√© au scope global pour √™tre accessible depuis les handlers.)
  async function fetchComptaDossierForExport() {
    try {
      const baseApiUrl = (storedBaseApi || deriveBaseApi($("urlInput")?.value || "")).replace(/\/+$/,"");
      const uuid = (storedUUID || $("uuidValue")?.textContent?.trim() || "").trim();
      if (!baseApiUrl || !uuid) return null;

      const url = baseApiUrl + "/v1/compta/dossier";
      const res = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": uuid } });

      const raw = await res.text();
      let data = null;
      try { data = raw ? JSON.parse(raw) : null; } catch { data = null; }

      // On conserve quelque chose m√™me en erreur (400/401/‚Ä¶)
      lastComptaDossierJson = res.ok ? data : { "ErreurHTTP": res.status, "Raw": raw };

      // Rafra√Æchit le panneau "Param√©trage comptable" si la fonction existe
      if (res.ok && data && typeof renderComptaDossierParams === "function") {
        try { renderComptaDossierParams(data); } catch(e) {}
      }
      return lastComptaDossierJson;
    } catch (e) {
      // Ne pas casser l'export : on enregistre l'erreur et on continue
      lastComptaDossierJson = { "ErreurJS": String(e?.message || e) };
      return null;
    }
  }

  
  let storedBaseUrlSaisie = sessionStorage.getItem("ACD_BASE_URL_SAISIE") || "";
let lastApiInformationsJson = null;
  let lastUuidAuthJson = null;
  let lastSessionsDossierJson = null;
  let selectedExerciceObj = null;
  let selectedDossierCode = "";
  let storedTimeout = sessionStorage.getItem("ACD_SESSION_TIMEOUT") || "";

    let storedCabinetCode = "";

function setStatus(el, msg, kind="") {
    if (!el) return;
    el.textContent = msg || "";
    el.className = "status " + (kind || "");
  }

  // ===== Console JS (page) =====
  // ===== Console JS (page) =====
  function jsConsoleLog(label, payload, level="log") {
    const pre = $("jsConsoleLog");
    if (!pre) return;

    const ts = new Date().toISOString().replace("T"," ").replace("Z","");
    const base = `[${ts}] ${label}`;

    let extra = "";
    if (payload !== undefined) {
      if (typeof payload === "string") extra = "" + payload;
      else {
        try { extra = "" + JSON.stringify(payload, null, 2); }
        catch { extra = "" + String(payload); }
      }
    }

    pre.textContent += (pre.textContent ? "\n" : "") + base + extra;

    // auto-scroll
    try { pre.scrollTop = pre.scrollHeight; } catch {}

    // mirror to browser console
    try {
      if (level === "error") console.error(label, payload);
      else if (level === "warn") console.warn(label, payload);
      else console.log(label, payload);
    } catch {}
  }

  // ===== Traceur des appels API (routes + retours) =====
  (function installFetchTracer(){
    if (window.__ACD_FETCH_TRACER_INSTALLED__) return;
    window.__ACD_FETCH_TRACER_INSTALLED__ = true;

    const originalFetch = window.fetch ? window.fetch.bind(window) : null;
    if (!originalFetch) return;

    const MAX_BODY_CHARS = 200000; // limite de s√©curit√© pour √©viter de figer la page

    function headersToObject(h) {
      const obj = {};
      try {
        const hh = new Headers(h || {});
        hh.forEach((v,k)=>{ obj[k] = v; });
      } catch {}
      return obj;
    }

    function safeStringifyBody(body) {
      if (body === undefined || body === null) return null;
      if (typeof body === "string") return body;
      if (body instanceof URLSearchParams) return body.toString();
      if (body instanceof FormData) return "[FormData]";
      if (body instanceof Blob) return `[Blob ${body.type || ""} ${body.size || 0} bytes]`;
      try { return JSON.stringify(body); } catch { return String(body); }
    }

    function prettyOrRaw(text) {
      if (text === undefined || text === null) return "";
      const s = String(text);
      try { return JSON.stringify(JSON.parse(s), null, 2); } catch { return s; }
    }

    window.fetch = async function(input, init){
      const start = performance.now();
      let url = "";
      let method = "GET";
      let reqHeaders = {};
      let reqBody = null;

      try {
        if (typeof input === "string") url = input;
        else if (input && typeof input.url === "string") url = input.url;

        // m√©thode
        method = (init?.method || (input?.method) || "GET").toUpperCase();

        // headers
        reqHeaders = headersToObject(init?.headers || input?.headers);

        // body
        reqBody = safeStringifyBody(init?.body);

      } catch {}

      // log requ√™te
      const reqPayload = {
        url, method,
        headers: reqHeaders,
        body: reqBody
      };
      jsConsoleLog(`${method} ${url}`, reqPayload);

      let resp;
      try {
        resp = await originalFetch(input, init);
      } catch (e) {
        const dur = Math.round(performance.now() - start);
        jsConsoleLog(`‚ùå ${method} ${url} (network error)`, { durationMs: dur, error: e?.message || String(e) }, "error");
        throw e;
      }

      // lire r√©ponse (clone)
      let text = "";
      try { text = await resp.clone().text(); } catch { text = ""; }

      const dur = Math.round(performance.now() - start);
      let bodyOut = prettyOrRaw(text);

      if (bodyOut && bodyOut.length > MAX_BODY_CHARS) {
        bodyOut = bodyOut.slice(0, MAX_BODY_CHARS) + "\n[TRONQU√â] R√©ponse trop volumineuse.";


      }

      const respPayload = {
        status: resp.status,
        ok: resp.ok,
        durationMs: dur,
        body: bodyOut
      };

      jsConsoleLog(`‚Ü© ${method} ${url}`, respPayload, resp.ok ? "log" : "error");

      return resp;
    };
  })();

  window.addEventListener("error", (e) => {
    try {
      const msg = e?.message || "Erreur JS";
      const src = e?.filename ? `${e.filename}:${e.lineno}:${e.colno}` : "";
      jsConsoleLog(`Erreur JS: ${msg}`, src);
    } catch {}
  });

  window.addEventListener("unhandledrejection", (e) => {
    try {
      const r = e?.reason;
      if (r && (r.message || r.stack)) {
        jsConsoleLog("Promise rejet√©e (unhandledrejection)", { message: r.message, stack: r.stack });
      } else {
        jsConsoleLog("Promise rejet√©e (unhandledrejection)", r);
      }
    } catch {}
  });


  
  // ===== GED helpers =====
  function setGedBadge(ok) {
    const b = $("gedStatusBadge");
    if (!b) return;
    b.classList.remove("hidden", "ok", "err");
    b.classList.add(ok ? "ok" : "err");
    b.textContent = ok ? "OK" : "NO";
  }

  function hideGedBadge() {
    $("gedStatusBadge")?.classList.add("hidden");
    try { const m=$("gedMsg"); if(m){ m.textContent=""; m.className="status"; } } catch {}
  }

  

  function setGedMsg(msg, kind="") {
    const el = $("gedMsg");
    if (!el) return;
    el.textContent = msg || "";
    el.className = "status " + (kind || "");
  }
function updateGedValidateState() {
    const btn = $("gedValidateBtn");
    const id = ($("gedIdInput")?.value || "").trim();
    const enabled = id.length > 0;
    if (btn) {
      btn.disabled = !enabled;
      btn.classList.toggle("disabled", !enabled);
      btn.style.opacity = enabled ? "1" : "0.55";
      btn.style.cursor = enabled ? "pointer" : "not-allowed";
    }
    if (!enabled) hideGedBadge();
    if (enabled) { try { const m=$("gedMsg"); if(m){ m.textContent=""; m.className="status"; } } catch {} }
  }

  async function loadGedJournals() {
    const sel = $("gedJournalSelect");
    if (!sel) return;
    sel.innerHTML = "";
    if (!storedBaseApi || !storedUUID) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "(Connexion requise)";
      sel.appendChild(opt);
      return;
    }
    try {
      const url = joinUrlParts(storedBaseApi, "v1/compta/journal");
      jsConsoleLog("GED URL journaux", url);
      const resp = await fetchWithTrace(url, { headers: { "accept":"text/plain", "UUID": storedUUID } });
      lastSecuritesCurl = resp.__acdCurl || "";
      const raw = await resp.text();
      jsConsoleLog("GED HTTP journaux", { status: resp.status, ok: resp.ok, raw: raw.slice(0, 1000) });
      const data = raw ? JSON.parse(raw) : [];
      lastJournauxJson = data;
        lastJournauxCurl = resp.__acdCurl || "";
      lastJournauxCurl = resp.__acdCurl || "";

      if (!Array.isArray(data) || data.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Aucun journal";
        sel.appendChild(opt);
        return;
      }
      data.forEach(j => {
        const opt = document.createElement("option");
        opt.value = j.Code;
        opt.textContent = `${j.Code} ‚Äî ${j.Libelle}`;
        sel.appendChild(opt);
      });
    } catch (e) {
      jsConsoleLog("Erreur GED journaux", e && e.message ? { message:e.message, stack:e.stack } : e);
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "(Erreur)";
      sel.appendChild(opt);
    }
  }

  async function loadGedArborescence() {
    const sel = $("gedArboSelect");
    if (!sel) return;
    sel.innerHTML = "";
    if (!storedBaseApi || !storedUUID) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "(Connexion requise)";
      sel.appendChild(opt);
      return;
    }
    try {
      const url = joinUrlParts(storedBaseApi, "v1/ged/arborescence?documents=false&criteres=false");
      jsConsoleLog("GED URL arborescence", url);
      const resp = await fetchWithTrace(url, { headers: { "accept":"text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      jsConsoleLog("GED HTTP arborescence", { status: resp.status, ok: resp.ok, raw: raw.slice(0, 1000) });
      const data = raw ? JSON.parse(raw) : null;
      lastGedArboJson = data;

      const roots = Array.isArray(data) ? data : (data?.Arborescences || []);
      const flat = [];

      function walk(node, depth) {
        if (!node) return;
        flat.push({ node, depth });
        const children = Array.isArray(node.Arborescences) ? node.Arborescences : [];
        children.forEach(ch => walk(ch, depth + 1));
      }

      const isFlat = Array.isArray(roots) && roots.length > 0 && roots[0] && ("IdArborescenceParent" in roots[0]) && !Array.isArray(roots[0].Arborescences);
      if (isFlat) {
        const byParent = new Map();
        roots.forEach(r => {
          const p = r.IdArborescenceParent ?? 0;
          if (!byParent.has(p)) byParent.set(p, []);
          byParent.get(p).push(r);
        });
        function walkFlat(parentId, depth) {
          const kids = byParent.get(parentId) || [];
          kids.forEach(k => {
            flat.push({ node:k, depth });
            walkFlat(k.Id, depth + 1);
          });
        }
        walkFlat(0, 0);
      } else {
        (Array.isArray(roots) ? roots : []).forEach(r => walk(r, 0));
      }

      if (flat.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "(Aucune rubrique)";
        sel.appendChild(opt);
        return;
      }

      flat.forEach(({node, depth}) => {
        const id = node.Id;
        const lib = node.Libelle ?? "";
        const indent = depth > 0 ? "‚Äî ".repeat(depth) : "";
        const opt = document.createElement("option");
        opt.value = String(id);
        opt.textContent = `${indent}${lib} (${id})`;
        sel.appendChild(opt);
      });
    } catch (e) {
      jsConsoleLog("Erreur GED arborescence", e && e.message ? { message:e.message, stack:e.stack } : e);
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "(Erreur)";
      sel.appendChild(opt);
    }
  }

  function showGedSection() {
    const c = $("gedCard");
    if (c) c.classList.remove("hidden");
    hideGedBadge();
    updateGedValidateState();
    // Charge les listes
    loadGedJournals();
    loadGedArborescence();
    // Bind une seule fois
    bindGedEvents();
  }

  function bindGedEvents() {
    if (gedEventsBound) return;
    gedEventsBound = true;

    $("gedIdInput")?.addEventListener("input", updateGedValidateState);

    $("gedLoadPlanBtn")?.addEventListener("click", async () => {
      try {
        jsConsoleLog("Click GED: Plan de classement √©criture");
        const code = ($("gedJournalSelect")?.value || "").trim();
        if (!code) { jsConsoleLog("GED: aucun journal s√©lectionn√©"); return; }

        const url = joinUrlParts(storedBaseApi, "v1/compta/planClassementEcriture/" + encodeURIComponent(code));
        jsConsoleLog("GED URL plan", url);
        const resp = await fetchWithTrace(url, { headers: { "accept":"text/plain", "UUID": storedUUID } });
        const raw = await resp.text();
        jsConsoleLog("GED HTTP plan", { status: resp.status, ok: resp.ok, raw });

        lastGedPlanJson = raw;
        if (resp.ok && raw !== undefined && raw !== null && String(raw).trim() !== "") {
          $("gedIdInput").value = String(raw).trim().slice(0,10);
          updateGedValidateState();
        
          // Auto-validation : d√®s qu‚Äôun IdGed est r√©cup√©r√© depuis le journal
          if ($("gedValidateBtn")) {
            jsConsoleLog("GED: auto-validation IdGed (journal)", { idGed: $("gedIdInput").value });
            $("gedValidateBtn").click();
          }
}
      } catch (e) {
        jsConsoleLog("Erreur GED plan", e && e.message ? { message:e.message, stack:e.stack } : e);
      }
    });

    $("gedPickArboBtn")?.addEventListener("click", () => {
      jsConsoleLog("Click GED: R√©cup√©rer IdGed (arborescence)");
      const v = ($("gedArboSelect")?.value || "").trim();
      if (!v) { jsConsoleLog("GED: aucune rubrique s√©lectionn√©e"); return; }
      $("gedIdInput").value = v.slice(0,10);
      updateGedValidateState();
    
      // Auto-validation : d√®s qu‚Äôun IdGed est r√©cup√©r√© depuis une rubrique GED
      if ($("gedValidateBtn")) {
        jsConsoleLog("GED: auto-validation IdGed (rubrique)", { idGed: $("gedIdInput").value });
        $("gedValidateBtn").click();
      }
});

    $("gedValidateBtn")?.addEventListener("click", async () => {
      try {
        jsConsoleLog("Click GED: Valider");
        setGedMsg("", "");
        updateGedValidateState();
        const id = ($("gedIdInput")?.value || "").trim();
        if (!id) { jsConsoleLog("GED: IdGed vide (bloqu√©)"); return; }

        const url = joinUrlParts(storedBaseApi, "v1/ged/documents/filtrer");
        const body = { IdsArborescences: [ Number(id) ] };
        jsConsoleLog("GED URL filtre", { url, body });
        const resp = await fetchWithTrace(url, {
          method: "POST",
          headers: { "accept":"text/plain", "UUID": storedUUID, "Content-Type":"application/json-patch+json" },
          body: JSON.stringify(body)
        });
        const raw = await resp.text();
        jsConsoleLog("GED HTTP filtre", { status: resp.status, ok: resp.ok, raw: raw.slice(0, 1000) });
        lastGedFilterJson = raw;
        const ok = (resp.status === 200);
        setGedBadge(ok);

        // Nombre de documents trouv√©s
        const docsRow = $("gedDocsCountRow");
        const docsVal = $("gedDocsCountVal");
        const parsed = parseMaybeJson(raw);
        const nDocs = extractGedDocsCount(parsed);
        if (ok && docsRow && docsVal && nDocs !== null) {
          docsRow.style.display = "block";
          docsVal.textContent = String(nDocs);
        } else if (docsRow) {
          docsRow.style.display = "none";
        }

        // D√©tail de la rubrique GED (arborescence)
        if (ok) {
          await loadGedArborescence();
          const node = findGedNodeById(lastGedArboJson, id);
          lastGedRubriqueNode = node;
          renderGedRubriqueTable(node);
                  if (!node) {
            setGedMsg("Rubrique de GED non trouv√©", "err");
          } else {
            setGedMsg("", "");
          }
} else {
          lastGedRubriqueNode = null;
          renderGedRubriqueTable(null);
        }
      } catch (e) {
        jsConsoleLog("Erreur GED filtre", e && e.message ? { message:e.message, stack:e.stack } : e);
      }
    });

    $("gedJsonPlanBtn")?.addEventListener("click", () => {
      jsConsoleLog("Click GED: JSON plan");
      openJsonWindow("GET /v1/compta/planClassementEcriture/{CodeJournal}", lastGedPlanJson);
    });

    $("gedJsonFilterBtn")?.addEventListener("click", () => {
      jsConsoleLog("Click GED: JSON filtre");
      openJsonWindow("POST /v1/ged/documents/filtrer", lastGedFilterJson, window.lastGeneratedCurl);
    });

    $("gedRubriqueJsonBtn")?.addEventListener("click", () => {
      jsConsoleLog("Click GED: JSON rubrique");
      if (!lastGedRubriqueNode) {
        jsConsoleLog("GED JSON rubrique: aucune rubrique charg√©e", { idGed: $("idGedInput")?.value || "" });
        alert('Aucune rubrique GED n‚Äôest charg√©e. Lancez d‚Äôabord "Valider IdGed".');
        return;
      }
      openJsonWindow("GET /v1/ged/arborescence (rubrique)", lastGedRubriqueNode);
    });

  }

function joinUrlParts(...parts) {
    return parts
      .filter(p => p !== undefined && p !== null)
      .map((p, idx) => {
        const s = String(p);
        if (idx === 0) return s.replace(/\/+$/, "", window.lastGeneratedCurl);
        return s.replace(/^\/+/, "").replace(/\/+$/, "");
      })
      .join("/");
  }

  function buildBaseApiUrl(inputUrl) {
    const u = new URL(inputUrl.trim());
    const segs = u.pathname.split("/").filter(Boolean);
    if (segs.length < 1) throw new Error("URL invalide.");
    return joinUrlParts(u.origin, segs[0], "api");
  }

  
  function extractApiMessage(rawText) {
    if (!rawText) return "";
    // try JSON {"Message":"..."} or {"message":"..."} or plain text
    try {
      const o = JSON.parse(rawText);
      return o?.Message || o?.message || o?.error || "";
    } catch {
      // Sometimes API returns plain text
      return "";
    }
  }

function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }


  function boolStatusBadge(v) {
    if (v === true) return '<span class="status ok">OK</span>';
    if (v === false) return '<span class="status err">NO</span>';
    return '‚Äî';
  }

  function renderGedRubriqueTable(node) {
    const wrap = $("gedRubriqueDetail");
    const tbody = $("gedRubriqueTbody");
    const btn = $("gedRubriqueJsonBtn");
    if (!wrap || !tbody) return;

    if (!node) {
      wrap.style.display = "none";
      tbody.innerHTML = "";
      if (btn) { btn.disabled = true; }
      return;
    }

    wrap.style.display = "block";
    const rows = [
      ["Id", node.Id],
      ["Libell√©", node.Libelle],
      ["IdArborescenceParent", node.IdArborescenceParent],
      ["Libell√© complet", node.LibelleComplet],
      ["CodesGenres", node.CodesGenres ? JSON.stringify(node.CodesGenres) : "‚Äî"],

      ["Diffusable", boolStatusBadge(node.Diffusable)],
      ["VisibleEnComptabilite", boolStatusBadge(node.VisibleEnComptabilite)],
      ["VisibleEnPaie", boolStatusBadge(node.VisibleEnPaie)],
      ["LectureSeule", boolStatusBadge(node.LectureSeule)],

      ["CritereArborescence", node.CritereArborescence ? JSON.stringify(node.CritereArborescence) : "‚Äî"],
      ["ValidationRequise", boolStatusBadge(node.ValidationRequise)],
      ["DossierPropre", boolStatusBadge(node.DossierPropre)],
      ["MasqueNomDocument", node.MasqueNomDocument ?? ""],
      ["InvisibleVueDossier", boolStatusBadge(node.InvisibleVueDossier)],
      ["NommageAutomatiqueCreation", boolStatusBadge(node.NommageAutomatiqueCreation)],
      ["MasqueNommageAutomatiqueCreation", node.MasqueNommageAutomatiqueCreation ?? ""],
      ["NommageAutomatiqueSortie", boolStatusBadge(node.NommageAutomatiqueSortie)],
      ["MasqueNommageAutomatiqueSortie", node.MasqueNommageAutomatiqueSortie ?? ""],
      ["Versionnage", boolStatusBadge(node.Versionnage)],
      ["Signature", boolStatusBadge(node.Signature)],
      ["ContrainteExercice", node.ContrainteExercice ?? "‚Äî"],
      ["ArchivageLegal", boolStatusBadge(node.ArchivageLegal)],
    ];

    tbody.innerHTML = rows.map(([k, v]) => {
      const key = escapeHtml(String(k));
      const val = (typeof v === "string" && v.includes('class="status')) ? v : escapeHtml(String(v ?? "‚Äî"));
      return `<tr>
        <td style="padding:8px; border-bottom:1px solid var(--border); color:var(--muted);">${key}</td>
        <td style="padding:8px; border-bottom:1px solid var(--border);">${val}</td>
      </tr>`;
    }).join("");

    if (btn) btn.disabled = false;
  }

  function findGedNodeById(tree, id) {
    const target = Number(id);
    if (!tree) return null;
    const roots = Array.isArray(tree) ? tree : (tree.Arborescences || []);
    const stack = [...roots];
    while (stack.length) {
      const n = stack.shift();
      if (!n) continue;
      if (Number(n.Id) === target) return n;
      if (Array.isArray(n.Arborescences)) stack.push(...n.Arborescences);
    }
    // flat list fallback
    if (Array.isArray(roots)) {
      const flat = roots.find(r => Number(r.Id) === target);
      if (flat) return flat;
    }
    return null;
  }

  function extractGedDocsCount(json) {
    try {
      if (Array.isArray(json)) return json.length;
      if (!json || typeof json !== "object") return null;
      if (Array.isArray(json.Documents)) return json.Documents.length;
      if (typeof json.Total === "number") return json.Total;
      if (typeof json.TotalCount === "number") return json.TotalCount;
      if (typeof json.Nombre === "number") return json.Nombre;
      return null;
    } catch { return null; }
  }




  function formatDateFr(isoDate) {
    // attend un format YYYY-MM-DD
    if (!isoDate || typeof isoDate !== "string") return "‚Äî";
    const m = isoDate.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (!m) return isoDate;
    return `${m[3]}/${m[2]}/${m[1]}`;
  }


  function pickColumns(sample) {
    const preferred = ["Code","Libelle","Intitule","Nom","Nature","Type","TypeDeSaisie","Collectif","CompteDeTresorerie","NumeroFacture","SIRET","Courant","DateDebut","DateFin"];
    const keys = Object.keys(sample || {});
    const cols = preferred.filter(k => keys.includes(k));
    if (cols.length) return cols.slice(0, 8);
    return keys.slice(0, 8);
  }

  function renderTableFromArray(arr, headId, bodyId) {
    const head = $(headId);
    const body = $(bodyId);
    head.innerHTML = "";
    body.innerHTML = "";

    if (!Array.isArray(arr) || arr.length === 0) return;

    const cols = pickColumns(arr[0] || {});
    head.innerHTML = cols.map(c => `<th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(c)}</th>`).join("");

    body.innerHTML = arr.map(o => {
      return `<tr>` + cols.map(c => {
        let v = o?.[c];
        if (c === "DateDebut" || c === "DateFin") v = formatDateFr(v);
        if (typeof v === "object" && v !== null) v = JSON.stringify(v);
        if (v === null || v === undefined) v = "";
        return `<td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(v))}</td>`;
      }).join("") + `</tr>`;
    }).join("");
  }

  function renderAccountsTable(arr, headId, bodyId) {
    const head = $(headId);
    const body = $(bodyId);
    head.innerHTML = "";
    body.innerHTML = "";

    const cols = [
      { key: "Code", label: "Code" },
      { key: "Lib", label: "Libell√©" },
      { key: "Let", label: "Lettrable" },
      { key: "ActivationAnalytique", label: "Analytique" },
      { key: "Qte", label: "Quantit√©s" },
    ];

    head.innerHTML = cols.map(c => `<th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(c.label)}</th>`).join("");

    if (!Array.isArray(arr) || arr.length === 0) return;

    body.innerHTML = arr.map(o => {
      return `<tr>` + cols.map(c => {
        let v = o?.[c.key];
        if (v === null || v === undefined) v = "";
        if (typeof v === "boolean") v = v ? "true" : "false";
        return `<td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(v))}</td>`;
      }).join("") + `</tr>`;
    }).join("");
  }

  

  async function callAuthUuidEndpoint() {
    if (!storedBaseApi || !storedUUID) return;
    const url = joinUrlParts(storedBaseApi, "v1/authentification/uuid");
    try {
      const resp = await fetchWithTrace(url, {
        method: "POST",
        headers: {
          "accept": "text/plain",
          "Content-Type": "application/json-patch+json"
        },
        body: JSON.stringify({ UUID: storedUUID })
      });
      const data = await resp.json();
      openJsonWindow("POST /v1/authentification/uuid", data);
    } catch (e) {
      openJsonWindow("POST /v1/authentification/uuid", { erreur: e.message });
    }
  }



  async function openSessionDossierJson() {
    if (!storedBaseApi || !storedUUID) return;
    const url = joinUrlParts(storedBaseApi, "v1/sessions/dossier", window.lastGeneratedCurl);
    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; } catch { data = { raw }; }

      if (!resp.ok) {
        const msg = (data && typeof data === "object" && (data.Message || data.message)) ? (data.Message || data.message) : raw;
        openJsonWindow("GET /v1/sessions/dossier", { status: resp.status, erreur: msg });
        return;
      }
      openJsonWindow("GET /v1/sessions/dossier", data, window.lastGeneratedCurl);
    } catch (e) {
      openJsonWindow("GET /v1/sessions/dossier", { erreur: String(e && e.message ? e.message : e) });
    }
  }


  async function fetchCodesTva() {
    const nb = $("nbCodesTva");
    if (nb) nb.textContent = "‚Äî";
    lastCodesTvaJson = null;

    if (!storedBaseApi || !storedUUID) return;

    const url = joinUrlParts(storedBaseApi, "v1/compta/param√®tres/codesTVA");

    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } }, window.lastGeneratedCurl);
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : []; } catch { data = []; }

      if (!resp.ok) {
        lastCodesTvaJson = { status: resp.status, raw };
        return;
      }

      if (!Array.isArray(data)) data = [];
      lastCodesTvaJson = data;
      if (nb) nb.textContent = String(data.length);
    } catch (e) {
      lastCodesTvaJson = { erreur: String(e && e.message ? e.message : e) };
    }
  }

  function renderCodesTvaRows(arr) {
    const tbody = $("codesTvaTbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    (Array.isArray(arr) ? arr : []).forEach((it) => {
      const tr = document.createElement("tr");

      const tdCode = document.createElement("td");
      tdCode.style.padding = "8px 12px";
      tdCode.style.borderBottom = "1px solid var(--border)";
      tdCode.textContent = it?.Code ?? "";
      tr.appendChild(tdCode);

      const tdLib = document.createElement("td");
      tdLib.style.padding = "8px 12px";
      tdLib.style.borderBottom = "1px solid var(--border)";
      tdLib.textContent = it?.Lib ?? "";
      tr.appendChild(tdLib);

      const tdTaux = document.createElement("td");
      tdTaux.style.padding = "8px 12px";
      tdTaux.style.textAlign = "right";
      tdTaux.style.borderBottom = "1px solid var(--border)";
      tdTaux.textContent = (it?.Taux ?? "").toString();
      tr.appendChild(tdTaux);

      tbody.appendChild(tr);
    });
  }

  function toggleCodesTvaTable() {
    const wrap = $("codesTvaTableWrap");
    if (!wrap) return;
    const isHidden = wrap.classList.contains("hidden");
    if (isHidden) {
      renderCodesTvaRows(lastCodesTvaJson);
      wrap.classList.remove("hidden");
    } else {
      wrap.classList.add("hidden");
    }
  }




  
  let lastQteParamsJson = null;

  function setQteButtonsVisible(isVisible) {
    const d = isVisible ? "inline-flex" : "none";
    const b1 = $("qteDetailBtn");
    const b2 = $("qteCsvBtn");
    const b3 = $("qteJsonBtn");
    if (b1) b1.style.display = d;
    if (b2) b2.style.display = d;
    if (b3) b3.style.display = d;
  }

  async function fetchQuantitesParams() {
    // R√©cup√®re la liste des param√®tres quantit√©s (si GestionQuantites = true)
    lastQteParamsJson = null;

    const wrap = $("qteTableWrap");
    if (wrap) wrap.classList.add("hidden");
    $("qteDetailBtn") && ($("qteDetailBtn").textContent = "D√©tail");

    if (!storedBaseApi || !storedUUID) return;

    const url = joinUrlParts(storedBaseApi, "v1/compta/param√®tres/quantite");

    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : []; } catch { data = []; }

      if (!resp.ok) {
        lastQteParamsJson = { status: resp.status, raw };
        return;
      }

      if (!Array.isArray(data)) data = [];
      lastQteParamsJson = data;
    } catch (e) {
      lastQteParamsJson = { erreur: String(e && e.message ? e.message : e) };
    }
  }

  function renderQteRows(arr) {
    const tbody = $("qteTbody");
    if (!tbody) return;
    tbody.innerHTML = "";

    (Array.isArray(arr) ? arr : []).forEach((it) => {
      const tr = document.createElement("tr");

      const mk = (val) => {
        const td = document.createElement("td");
        td.style.padding = "8px 12px";
        td.style.borderBottom = "1px solid var(--border)";
        td.textContent = (val ?? "").toString();
        return td;
      };

      tr.appendChild(mk(it?.Code));
      tr.appendChild(mk(it?.Libelle));
      tr.appendChild(mk(it?.PrixUnitMin));
      tr.appendChild(mk(it?.PrixUnitMax));
      tr.appendChild(mk(it?.QuantiteMin));
      tr.appendChild(mk(it?.QuantiteMax));
      tr.appendChild(mk(it?.NbreDecimale));

      tbody.appendChild(tr);
    });
  }

  function toggleQteTable() {
    const wrap = $("qteTableWrap");
    if (!wrap) return;

    const isHidden = wrap.classList.contains("hidden");
    if (isHidden) {
      renderQteRows(lastQteParamsJson);
      wrap.classList.remove("hidden");
      $("qteDetailBtn") && ($("qteDetailBtn").textContent = "Masquer");
    } else {
      wrap.classList.add("hidden");
      $("qteDetailBtn") && ($("qteDetailBtn").textContent = "D√©tail");
    }
  }


  function setAnaSectionsButtonsVisible(isVisible) {
    const d = isVisible ? "inline-flex" : "none";
    const b1 = $("anaSectionsDetailBtn");
    const b2 = $("anaSectionsCsvBtn");
    const b3 = $("anaSectionsJsonBtn");
    if (b1) b1.style.display = d;
    if (b2) b2.style.display = d;
    if (b3) b3.style.display = d;
  }

  async function fetchAnalytiqueSections() {
    // R√©cup√®re la liste des sections analytiques (si Analytique.Active = true)
    lastAnaSectionsJson = null;

    // Masquer par d√©faut
    const wrap = $("anaSectionsTableWrap");
    if (wrap) wrap.classList.add("hidden");
    $("anaSectionsDetailBtn") && ($("anaSectionsDetailBtn").textContent = "D√©tail");

    if (!storedBaseApi || !storedUUID) return;

    const url = joinUrlParts(storedBaseApi, "v1/compta/param√®tres/analytique");

    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : []; } catch { data = []; }

      if (!resp.ok) {
        lastAnaSectionsJson = { status: resp.status, raw };
        return;
      }

      if (!Array.isArray(data)) data = [];
      lastAnaSectionsJson = data;
    } catch (e) {
      lastAnaSectionsJson = { erreur: String(e && e.message ? e.message : e) };
    }
  }

  function renderAnaSectionsRows(arr) {
    const tbody = $("anaSectionsTbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    (Array.isArray(arr) ? arr : []).forEach((it) => {
      const tr = document.createElement("tr");

      const mk = (val) => {
        const td = document.createElement("td");
        td.style.padding = "8px 12px";
        td.style.borderBottom = "1px solid var(--border)";
        td.textContent = (val ?? "").toString();
        return td;
      };

      tr.appendChild(mk(it?.SEC_LIB));
      tr.appendChild(mk(it?.SEC_N1));
      tr.appendChild(mk(it?.SEC_N2));
      tr.appendChild(mk(it?.SEC_N3));

      const tdSecs = document.createElement("td");
      tdSecs.style.padding = "8px 12px";
      tdSecs.style.borderBottom = "1px solid var(--border)";
      const secs = it?.Sections;
      tdSecs.textContent = Array.isArray(secs) ? secs.join(" | ") : (secs ?? "").toString();
      tr.appendChild(tdSecs);

      tbody.appendChild(tr);
    });
  }

  function toggleAnaSectionsTable() {
    const wrap = $("anaSectionsTableWrap");
    if (!wrap) return;

    const isHidden = wrap.classList.contains("hidden");
    if (isHidden) {
      renderAnaSectionsRows(lastAnaSectionsJson);
      wrap.classList.remove("hidden");
      $("anaSectionsDetailBtn") && ($("anaSectionsDetailBtn").textContent = "Masquer");
    } else {
      wrap.classList.add("hidden");
      $("anaSectionsDetailBtn") && ($("anaSectionsDetailBtn").textContent = "D√©tail");
    }
  }

  function extractGedDocumentsCount(data, rawText) {
    // Try common shapes:
    // { Total: n } / { TotalDocuments: n } / { NbDocuments: n } / { Count: n }
    // { Documents: [...] } or { Resultats: [...] } or array response [...]
    try {
      if (data && typeof data === "object") {
        const keys = ["Total", "TotalDocuments", "NbDocuments", "Nombre", "Count", "TotalCount"];
        for (const k of keys) {
          if (typeof data[k] === "number") return data[k];
        }
        if (Array.isArray(data.Documents)) return data.Documents.length;
        if (Array.isArray(data.Resultats)) return data.Resultats.length;
        if (Array.isArray(data.Items)) return data.Items.length;
        if (Array.isArray(data.Arborescences)) return data.Arborescences.length;
      }
      if (Array.isArray(data)) return data.length;
      // If not JSON, try to find "Total":n in raw
      if (typeof rawText === "string") {
        const m = rawText.match(/"Total"\s*:\s*(\d+)/i) || rawText.match(/"TotalDocuments"\s*:\s*(\d+)/i);
        if (m) return Number(m[1]);
      }
    } catch {}
    return null;
  }

function openJsonWindow(title, data, generatedAtText, suggestedFilename, curlCommand) {
    const w = window.open("", "_blank");
    if (!w) return;

    const safeTitle = title ? String(title) : "JSON";
    const hideCurl = safeTitle.trim().toLowerCase() === 'export json';
    const jsonText = JSON.stringify(data ?? null, null, 2);

    const esc = (s) => String(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");

    const embedded = JSON.stringify(data ?? null).replace(/</g, "\\u003c");
    const embeddedFilename = JSON.stringify(String(suggestedFilename || "")).replace(/</g, "\\u003c");
    // Prefer meta tied to this endpoint/method (avoids mismatched CURL when multiple calls happened before opening the viewer)
    const metaKey = safeTitle.replace(/\s+/g, " ").trim();
    const meta = (window.__acdLastMetaByTitle && window.__acdLastMetaByTitle[metaKey]) ? window.__acdLastMetaByTitle[metaKey] : null;

    const embeddedStatus = JSON.stringify((meta && meta.status != null) ? meta.status : (window.lastHttpStatus || null));
    const embeddedDuration = JSON.stringify((meta && meta.durationMs != null) ? meta.durationMs : (window.lastHttpDuration || null));

    // If a curlCommand was explicitly provided and looks valid, keep it; otherwise use the per-title meta
    const chosenCurl = (curlCommand && String(curlCommand).trim()) ? String(curlCommand) : ((meta && meta.curl) ? meta.curl : (window.lastGeneratedCurl || ""));
    const embeddedCurl = JSON.stringify(chosenCurl).replace(/</g, "\\u003c");
    const childScriptOpen = "<scr" + "ipt>";
    const childScriptClose = "</scr" + "ipt>";

    const parts = [];
    parts.push('<!doctype html><html lang="fr"><head><meta charset="utf-8"/>');parts.push('<title>' + esc(safeTitle) + '</title>');parts.push('<meta name="viewport" content="width=device-width, initial-scale=1"/>');parts.push('<style>');parts.push('body{margin:16px;font-family:"Segoe UI",SegoeUI,system-ui,-apple-system,Roboto,Arial,sans-serif;background:#f7f9fc;color:#0b1220;}');parts.push('.top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap;padding:12px 14px;border-radius:16px;background:linear-gradient(135deg,#0b1f3b,#123a6b);color:#fff;box-shadow:0 10px 25px rgba(11,31,59,.08);}');parts.push('h1{font-size:18px;font-weight:700;margin:0;color:#ffffff;}');parts.push('.btns{display:flex;gap:8px;flex-wrap:wrap;}');parts.push('button{appearance:none;border:1px solid #d0d9e7;background:#ffffff;color:#0b1220;padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:700}');parts.push('button.primary{border-color:transparent;background:linear-gradient(135deg,#0b1f3b,#123a6b);color:#ffffff}');parts.push('button.primary:hover{background:linear-gradient(135deg,#123a6b,#1f5aa6)}');parts.push('button:hover{background:#eef3f9}');parts.push('button:active{transform:translateY(1px)}');parts.push('.hint{font-size:12px;color:rgba(255,255,255,.85)}');parts.push('.searchbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0;}');parts.push('.searchbar input[type="text"]{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid #d0d9e7;font-weight:600}');parts.push('.searchbar label{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:#0b1220}');parts.push('.searchbar .meta{font-size:12px;font-weight:700;color:#0b1220;opacity:.85}');parts.push('mark.hit{background:#fde68a;color:#0b1220;padding:0 .08em;border-radius:4px}');parts.push('body.dark mark.hit, body.dark-mode mark.hit{background:#fbbf24;color:#0b1220}');parts.push('body.dark .searchbar input[type="text"], body.dark-mode .searchbar input[type="text"]{background:var(--input-bg-dark);border-color:var(--input-border-dark);color:var(--input-fg-dark);}');parts.push('body.dark .searchbar input[type="text"]::placeholder, body.dark-mode .searchbar input[type="text"]::placeholder{color:var(--input-placeholder);}');parts.push('body.dark .searchbar label, body.dark-mode .searchbar label, body.dark .searchbar .meta, body.dark-mode .searchbar .meta{color:var(--input-fg-dark);}');parts.push('pre{white-space:pre-wrap;word-break:break-word;border:1px solid #2b3850;border-radius:12px;padding:12px;background:#121824;color:#e2e8f0;margin:0;font-family:ui-monospace,SFMono-Regular,Consolas,monospace;}');parts.push(`

/* =========================================================
   Dark mode polish (uniform inputs + visible colored buttons)
   ========================================================= */
:root{
  /* Button tokens */
  --btn-primary-bg: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
  --btn-primary-fg: #ffffff;
  --btn-secondary-bg: rgba(148, 163, 184, 0.18);
  --btn-secondary-fg: #e2e8f0;
  --btn-danger-bg: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
  --btn-danger-fg: #ffffff;
  --btn-outline-border: rgba(148, 163, 184, 0.35);

  /* Inputs tokens */
  --input-bg-dark: rgba(2, 6, 23, 0.55);
  --input-bg-dark-2: rgba(15, 23, 42, 0.55);
  --input-border-dark: rgba(148, 163, 184, 0.22);
  --input-border-focus: rgba(34, 211, 238, 0.65);
  --input-fg-dark: #e2e8f0;
  --input-placeholder: rgba(226, 232, 240, 0.55);
}

/* All dark-mode rules are scoped to body.dark / .dark-mode to be compatible with existing toggle */
body.dark, body.dark-mode, .dark-mode body, .dark-mode{
  color-scheme: dark;
}

/* Uniformise the "zones de saisie" */
body.dark input[type="text"],
body.dark input[type="password"],
body.dark input[type="number"],
body.dark input[type="email"],
body.dark input[type="url"],
body.dark select,
body.dark textarea,
body.dark .input,
body.dark .form-control,
body.dark .url-input,
body.dark .auth-input{
  background: var(--input-bg-dark) !important;
  color: var(--input-fg-dark) !important;
  border: 1px solid var(--input-border-dark) !important;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.06) !important;
}

body.dark input::placeholder,
body.dark textarea::placeholder{
  color: var(--input-placeholder) !important;
}

body.dark input:focus,
body.dark select:focus,
body.dark textarea:focus{
  outline: none !important;
  border-color: var(--input-border-focus) !important;
  box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.18) !important;
}

/* Harmonise wrappers around inputs if present */
body.dark .input-group,
body.dark .field,
body.dark .field-wrap,
body.dark .card,
body.dark .panel,
body.dark .section,
body.dark .zone-grise,
body.dark .box,
body.dark .container-box{
  border-color: rgba(148, 163, 184, 0.16) !important;
}

/* Buttons: make them visible + allow colored backgrounds */
body.dark button,
body.dark .btn,
body.dark input[type="button"],
body.dark input[type="submit"]{
  color: var(--btn-secondary-fg) !important;
  background: var(--btn-secondary-bg) !important;
  border: 1px solid var(--btn-outline-border) !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  transition: transform .06s ease, filter .12s ease, box-shadow .12s ease !important;
}

body.dark button:hover,
body.dark .btn:hover,
body.dark input[type="button"]:hover,
body.dark input[type="submit"]:hover{
  filter: brightness(1.08) !important;
  box-shadow: 0 10px 24px rgba(0,0,0,0.32) !important;
}

body.dark button:active,
body.dark .btn:active{
  transform: translateY(1px) !important;
}

/* Primary actions (Valider / Send / Export / Import) */
body.dark .btn-primary,
body.dark button.primary,
body.dark button.validate,
body.dark button#btnValidate,
body.dark button#btnSend,
body.dark button#exportJsonBtn,
body.dark button#importJsonBtn{
  background: var(--btn-primary-bg) !important;
  color: var(--btn-primary-fg) !important;
  border: 0 !important;
}

/* Secondary (Effacer / Reset) */
body.dark .btn-secondary,
body.dark button.secondary,
body.dark button.reset,
body.dark button#btnClear{
  background: rgba(148, 163, 184, 0.16) !important;
  color: var(--btn-secondary-fg) !important;
  border: 1px solid rgba(148, 163, 184, 0.28) !important;
}

/* Danger (Supprimer etc.) */
body.dark .btn-danger,
body.dark button.danger,
body.dark .danger{
  background: var(--btn-danger-bg) !important;
  color: var(--btn-danger-fg) !important;
  border: 0 !important;
}

/* Disabled states remain visibly disabled */
body.dark button:disabled,
body.dark .btn:disabled,
body.dark input[type="button"]:disabled,
body.dark input[type="submit"]:disabled{
  opacity: 0.45 !important;
  filter: grayscale(0.25) !important;
  cursor: not-allowed !important;
}

/* Small "badge" style (LOCAL/CLIENT) - ensure contrast */
body.dark .badge,
body.dark .env-badge{
  background: rgba(34, 211, 238, 0.18) !important;
  color: #e6fbff !important;
  border: 1px solid rgba(34, 211, 238, 0.32) !important;
}

/* Improve icons inside inputs (eye icon etc.) */
body.dark .input-icon,
body.dark .toggle-password,
body.dark .icon{
  color: rgba(226, 232, 240, 0.75) !important;
}



/* =========================================================
   Layout fix: computed session values aligned to the right
   ========================================================= */
#sessionArea .sessionBox .sessionRow{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 14px;
  padding: 8px 0;
}

#sessionArea .sessionBox .sessionKey{
  flex: 1 1 auto;
  min-width: 260px;
}

#sessionArea .sessionBox .sessionVal{
  flex: 0 0 auto;
  margin-left: auto;
  text-align: right;
  max-width: 70%;
  overflow-wrap: anywhere;
}

/* On narrow screens, allow wrapping while keeping value right-aligned */
@media (max-width: 520px){
  #sessionArea .sessionBox .sessionRow{ flex-wrap: wrap; }
  #sessionArea .sessionBox .sessionVal{ max-width: 100%; width: 100%; text-align: left; }
}



/* =========================================================
   ACD Typographie ‚Äì En-t√™te (Segoe UI)
   Titre 60 : 24px Bold
   Accent 20 : 14px Bold
   Texte 10 : 12px Regular
   ========================================================= */
header h1{
  font-size:24px !important;          /* Titre 60 */
  font-weight:700 !important;
  letter-spacing: .2px;
  line-height: 1.15;
}

header #prettyVersion{
  font-size:12px !important;          /* Texte 10 */
  font-weight:400 !important;
  opacity:.88;
  margin-top:6px;
}

header .status{
  font-size:14px !important;          /* Accent 20 */
  font-weight:700 !important;
  line-height:1.2;
  margin-top:6px !important;
  opacity:1;
}

/* Subtle align/spacing for meta block */
header .headerMeta{
  display:flex;
  flex-direction:column;
  gap:2px;
}



/* =========================================================
   ACD Sections ‚Äì bandeau + badge statut
   ========================================================= */
.acd-section{
  margin-top: 16px;
}
.acd-section-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding: 10px 14px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: var(--surface2);
}
:root[data-theme="dark"] .acd-section-header{
  border-color: var(--border2);
  background: rgba(255,255,255,.04);
}
.acd-section-title{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:16px;          /* Titre 30 */
  font-weight:700;
  color: var(--text);
}
.acd-section-title .acd-icon{
  width:22px; height:22px;
  display:inline-flex; align-items:center; justify-content:center;
  border-radius: 8px;
  background: rgba(159,192,245,.35);
  border: 1px solid rgba(159,192,245,.45);
}
:root[data-theme="dark"] .acd-section-title .acd-icon{
  background: rgba(159,192,245,.18);
  border-color: rgba(159,192,245,.28);
}
.acd-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size:12px;
  font-weight:700;
  border: 1px solid rgba(10,122,37,.30);
  background: rgba(10,122,37,.12);
  color: var(--text);
  user-select:none;
}
.acd-badge .dot{
  width:8px; height:8px; border-radius:50%;
  background: #19c37d;
  box-shadow: 0 0 0 3px rgba(25,195,125,.18);
}
.acd-section-body{
  margin-top:10px;
}
/* Option: make the whole "Connexion √©tablie" zone feel grouped */
.acd-band{
  border-radius: var(--radius);
  padding: 12px;
  background: rgba(216,230,255,.28);
  border: 1px solid rgba(159,192,245,.35);
}
:root[data-theme="dark"] .acd-band{
  background: rgba(15,23,42,.55);
  border-color: rgba(42,60,92,.65);
}


/* =========================================================
   ACD CARD COMPONENT (Reusable)
   ========================================================= */
.acd-card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: 0 4px 14px rgba(0,0,0,.04);
}

:root[data-theme="dark"] .acd-card{
  background: var(--surface);
  border-color: var(--border2);
}

.acd-card-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin:-16px -16px 12px;
  padding:10px 14px;
  border-radius: calc(var(--radius) - 2px);
  border: 1px solid var(--border);
  background: var(--surface2);
}

:root[data-theme="dark"] .acd-card-header{
  border-color: var(--border2);
  background: rgba(255,255,255,.04);
}

.acd-card-body{
  margin-top:10px;
}


/* =========================================================
   Connexion √©tablie ‚Äì carte blanche (comme Authentification)
   ========================================================= */
.connectedCard{ padding:16px; }
.connectedHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin:-16px -16px 12px;
  padding:10px 14px;
  border-radius: calc(var(--radius) - 2px);
  border: 1px solid var(--border);
  background: var(--surface2);
}
:root[data-theme="dark"] .connectedHeader{
  border-color: var(--border2);
  background: rgba(255,255,255,.04);
}
.connectedTitle{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:16px;
  font-weight:700;
  color: var(--text);
}
.connectedBody{ padding: 0; }

/* Keep values on the right down to smaller widths */
@media (max-width: 520px){
  .sessionRow{ flex-wrap: wrap !important; }
  .sessionVal{ max-width: 100% !important; width: 100% !important; text-align:left !important; }
}


/* =========================================================
   Force align right for Connexion √©tablie values
   ========================================================= */
#sec-connected .sessionRow{
  flex-direction: row !important;
  flex-wrap: nowrap !important;
}

#sec-connected .sessionVal{
  margin-left: auto !important;
  text-align: right !important;
  display: flex !important;
  justify-content: flex-end !important;
  align-items: center !important;
  max-width: none !important;
  width: auto !important;
}


/* =========================================================
   Connexion √©tablie ‚Äì layout robuste (labels gauche / valeurs droite)
   Force un alignement m√™me si des rules flex se t√©lescopent.
   ========================================================= */
#sec-connected .connectedBody .sessionRow{
  display: grid !important;
  grid-template-columns: 260px 1fr !important;
  align-items: center !important;
  gap: 14px !important;
}

#sec-connected .connectedBody .sessionKey{
  margin: 0 !important;
}

#sec-connected .connectedBody .sessionVal{
  justify-self: end !important;
  text-align: right !important;
  margin-left: 0 !important;   /* grid g√®re l‚Äôalignement */
  width: auto !important;
  max-width: 100% !important;
  display: inline-flex !important;
  justify-content: flex-end !important;
  align-items: center !important;
}

/* Sur petits √©crans, on repasse en 1 colonne proprement */
@media (max-width: 520px){
  #sec-connected .connectedBody .sessionRow{
    grid-template-columns: 1fr !important;
  }
  #sec-connected .connectedBody .sessionVal{
    justify-self: start !important;
    text-align: left !important;
  }
}


/* =========================================================
   Connexion √©tablie ‚Äì lisibilit√© + s√©parateurs visuels
   ========================================================= */

/* Espace vertical entre les lignes */
#sec-connected .sessionRow{
  padding: 10px 0;
}

/* S√©parateur apr√®s UUID */
#sec-connected .sessionRow:nth-of-type(2){
  border-bottom: 1px solid #e3e6eb;
  margin-bottom: 8px;
  padding-bottom: 14px;
}

/* S√©parateur avant Dossier en cours */
#sec-connected .sessionRow:nth-last-of-type(3){
  border-top: 1px solid #e3e6eb;
  margin-top: 12px;
  padding-top: 14px;
}

/* Mode sombre */
:root[data-theme="dark"] #sec-connected .sessionRow:nth-of-type(2),
:root[data-theme="dark"] #sec-connected .sessionRow:nth-last-of-type(3){
  border-color: rgba(255,255,255,0.12);
}


/* =========================================================
   Boutons primaires unifi√©s (m√™me style que "Valider le dossier")
   ========================================================= */
.btn-primary-acd{
  background: linear-gradient(135deg, #163a63, #1f4f85);
  color: #ffffff !important;
  border: none !important;
  border-radius: 10px !important;
  padding: 10px 16px !important;
  font-weight: 600 !important;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  transition: all .15s ease-in-out;
}
</style>
<style id="acd-export-button-colors">
/* ACD ‚Äì Couleurs export : ciblage par ID pour √©viter les probl√®mes de boutons dynamiques */
button[id*="Csv"], input[id*="Csv"], a[id*="Csv"]{
  background-color:#FFC72C !important; /* Jaune */
  color:#000 !important;
  border:none !important;
}
button[id*="Json"], input[id*="Json"], a[id*="Json"]{
  background-color:#C2185B !important; /* Rose/Bordeaux */
  color:#fff !important;
  border:none !important;
}
</style>


<style id="acd-balance-style">
.acd-positive{
  color:#1B5E20 !important; /* vert fonc√© */
  font-weight:600;
}
.acd-negative{
  color:#B71C1C !important; /* rouge fonc√© */
  font-weight:600;
}
</style>


<style>
.btnSidebarLink{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  background:#2d4f77;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.btnSidebarLink:hover{
  background:#3a6799;
}
</style>

</head><body>`);

    parts.push('<div class="top">'
        + '<div><h1>' + esc(safeTitle) + '</h1>'
        + '<div class="hint">R√©ponse API (JSON) <span id="genAt" class="meta"></span></div></div>'
        + '<div class="btns">'
        + '<button id="btnCopy" type="button">Copier</button>'
        + '<button id="btnSave" type="button">Enregistrer</button>'
        + (hideCurl ? '' : '<button id="btnToggleCurl" type="button" style="display:none">Masquer CURL</button>')
        + (hideCurl ? '' : '<button id="btnCopyCurl" type="button" style="display:none">üìã Copier CURL</button>')
        + '</div>'
        + '</div>');parts.push('<div class="searchbar">'      + '<input id="q" type="text" placeholder="Rechercher dans le JSON‚Ä¶" />'      + '<label><input id="cs" type="checkbox"/> Casse</label>'      + '<span class="meta" id="matchCount">0</span>'      + '<button id="btnClearSearch" type="button">Effacer</button>'      + '</div>');if (!hideCurl) { parts.push('<div id="curlWrap" class="curlWrap" style="display:none"><div class="curlHead">Commande CURL <button id="btnCopyCurlMini" type="button" class="miniBtn" title="Copier">üìã</button></div><pre id="curlBox" class="curlPre"></pre></div>'); }parts.push('<div style="margin:14px 0 8px 0;font-weight:700;font-size:14px;letter-spacing:0.3px;">üìÑ R√©ponse API format JSON</div>');parts.push('<pre id="jsonBox">' + esc(jsonText) + '</pre>');parts.push(childScriptOpen);
    parts.push('const data = ' + embedded + ';');parts.push('const suggestedFilename = ' + embeddedFilename + ';');parts.push('const curl = ' + embeddedCurl + ';');parts.push('const httpStatus = ' + embeddedStatus + ';');parts.push('const httpDuration = ' + embeddedDuration + ';');parts.push('const text = JSON.stringify(data, null, 2);');parts.push(`
    // --- Recherche + surbrillance dans le JSON ---
    const box = document.getElementById("jsonBox");
    const q = document.getElementById("q");
    const cs = document.getElementById("cs");
    const mc = document.getElementById("matchCount");
    const btnClear = document.getElementById("btnClearSearch");

    const escapeHtml = (s) => String(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");

    const escapeReg = (s) => String(s).replace(/[.*+?^{}$()|[\]\]/g, "\$&");

    function renderSearch(){
      if(!box) return;
      const query = (q && q.value ? q.value : "").trim();
      if(!query){
        box.textContent = text;
        if(mc) mc.textContent = "0";
        return;
      }
      const flags = (cs && cs.checked) ? "g" : "gi";
      const re = new RegExp(escapeReg(query), flags);
      let count = 0;
      const html = escapeHtml(text).replace(re, (m) => { count++; return \`<mark class="hit">\${m}</mark>\`; });
      box.innerHTML = html;
      if(mc) mc.textContent = String(count);
    }

    if(q){
      q.addEventListener("input", renderSearch);
      q.addEventListener("keydown", (e) => { if(e.key === "Escape"){ q.value=""; renderSearch(); } });
    }
    if(cs) cs.addEventListener("change", renderSearch);
    if(btnClear) btnClear.addEventListener("click", () => { if(q){ q.value=""; q.focus(); } renderSearch(); });

    renderSearch();
    try { q && q.focus(); } catch(e) {}
    `);
parts.push('(() => { const now=new Date(); const pad=(n)=>String(n).padStart(2,"0"); const ts=pad(now.getDate())+"/"+pad(now.getMonth()+1)+"/"+now.getFullYear()+" "+pad(now.getHours())+":"+pad(now.getMinutes())+":"+pad(now.getSeconds()); const el=document.getElementById("genAt"); if(el) el.textContent = "G√©n√©r√© le "+ts; })();');;parts.push('document.getElementById("btnCopy").addEventListener("click", async () => {');parts.push('  try { await navigator.clipboard.writeText(text);');parts.push('    document.getElementById("btnCopy").textContent = "Copi√© ‚úì";');parts.push('    setTimeout(() => document.getElementById("btnCopy").textContent = "Copier", 1200);');parts.push('  } catch {');parts.push('    const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);');parts.push('    document.getElementById("btnCopy").textContent = "Copi√© ‚úì";');parts.push('    setTimeout(() => document.getElementById("btnCopy").textContent = "Copier", 1200);');parts.push('  }');parts.push('});');parts.push('document.getElementById("btnSave").addEventListener("click", () => {');
parts.push('  const blob = new Blob([text], { type: "application/json;charset=utf-8" });');
parts.push('  const a = document.createElement("a");');
parts.push('  const url = URL.createObjectURL(blob);');
parts.push('  a.href = url;');
parts.push('  const fname = (suggestedFilename && String(suggestedFilename).trim()) ? String(suggestedFilename).trim() : "export.json";');
parts.push('  a.download = fname.toLowerCase().endsWith(".json") ? fname : (fname + ".json");');
parts.push('  document.body.appendChild(a); a.click(); document.body.removeChild(a);');
parts.push('  setTimeout(() => URL.revokeObjectURL(url), 500);');
parts.push('});');
parts.push('document.getElementById("btnCopyCurl").addEventListener("click", async () => {');
parts.push('  if(!curl){ alert("Aucun CURL disponible pour cette r√©ponse."); return; }');
parts.push('  try { await navigator.clipboard.writeText(curl);');
parts.push('    document.getElementById("btnCopyCurl").textContent = "Copi√© ‚úì";');
parts.push('    setTimeout(() => document.getElementById("btnCopyCurl").textContent = "Copier CURL", 1200);');
parts.push('  } catch {');
parts.push('    try { const ta=document.createElement("textarea"); ta.value=curl; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);');
parts.push('      document.getElementById("btnCopyCurl").textContent = "Copi√© ‚úì";');
parts.push('      setTimeout(() => document.getElementById("btnCopyCurl").textContent = "Copier CURL", 1200);');
parts.push('    } catch(e2){ alert("Impossible de copier le CURL."); }');
parts.push('  }');
parts.push('});');

parts.push('function escHtml(str){ return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }');
parts.push('function highlightCurl(str){' +
  '  // Version s√©curis√©e sans regex complexe\n' +
  '  return escHtml(str)' +
  '    .replace(/\\b(curl)\\b/g, \'<span class="hlKw">$1</span>\')' +
  '    .replace(/\\s(-X|-H|--data|--data-raw|--compressed)\\b/g, \' <span class="hlFlag">$1</span>\')' +
  '    .replace(/(https?:\\/\\/[^\\s]+)/g, \'<span class="hlUrl">$1</span>\');\n' +
  '}');
parts.push('const curlWrap = document.getElementById("curlWrap");');
parts.push('const curlBox = document.getElementById("curlBox");');
parts.push('const btnToggleCurl = document.getElementById("btnToggleCurl");');
parts.push('const btnCopyCurlMini = document.getElementById("btnCopyCurlMini");');
parts.push('if(curl && curlWrap && curlBox){ (curlWrap && curlWrap.style).display="block"; curlBox.innerHTML = highlightCurl(curl); } else { if(btnToggleCurl) (btnToggleCurl && btnToggleCurl.style).display="none"; }');

parts.push('async function _copyCurl(){ if(!curl){ alert("Aucun CURL disponible pour cette r√©ponse."); return; } try{ await navigator.clipboard.writeText(curl); } catch(e){ const ta=document.createElement("textarea"); ta.value=curl; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);} }');

parts.push('if(btnToggleCurl){ let open=false; btnToggleCurl && btnToggleCurl.addEventListener("click", async ()=>{ open=!open; if(!curlWrap) return; (curlWrap && curlWrap.style).display = open ? "block" : "none"; btnToggleCurl.textContent = open ? "Masquer CURL" : "Voir CURL"; if(open){ await _copyCurl(); } }); }');
parts.push('if(btnCopyCurlMini){ btnCopyCurlMini && btnCopyCurlMini.addEventListener("click", _copyCurl); }');


parts.push(`
if(httpStatus !== null){
  const badge = document.getElementById("httpBadge");
  if(badge){
    badge.textContent = httpStatus;
    if(String(httpStatus).startsWith("2")) badge.style.background="#1f8b4c";
    else if(String(httpStatus).startsWith("4")) badge.style.background="#b7791f";
    else if(String(httpStatus).startsWith("5")) badge.style.background="#c53030";
    else badge.style.background="#444";
    badge.style.color="#fff";
  }
}
if(httpDuration !== null){
  const meta = document.getElementById("httpMeta");
  if(meta){
    meta.textContent = "Dur√©e d‚Äôex√©cution : " + httpDuration + " ms";
  }
}
`);

parts.push(childScriptClose);

        // (suppression injection export CSV Balance)



    parts.push('</body></html>');
    w.document.write(parts.join(""));
    w.document.close();
  }

  

  async function copyText(text, statusEl) {
    try {
      await navigator.clipboard.writeText(text);
      setStatus(statusEl, "Copi√© ‚úî", "ok");
      setTimeout(() => setStatus(statusEl, "", ""), 1200);
    } catch {
      setStatus(statusEl, "Copie impossible.", "err");
      setTimeout(() => setStatus(statusEl, "", ""), 2000);
    }
  }

  function toggleSection(wrapId, chevId) {
    const wrap = $(wrapId);
    const chev = $(chevId);
    const collapsed = wrap.classList.contains("collapsed");
    if (collapsed) { wrap.classList.remove("collapsed"); chev.textContent = "‚ñº"; }
    else { wrap.classList.add("collapsed"); chev.textContent = "‚ñ∂"; }
  }

  function updateAuthUI() {
    const authed = !!(storedUUID && storedBaseApi);
    $("afterAuth").classList.toggle("hidden", !authed);
    $("btnDossier").disabled = !authed;
    $("copyUuidBtn").disabled = !authed;
  }

  function resetBadges() {
    lastBalanceJson = null;
    lastBalanceCurl = "";
  
    exercicesList = [];

    lastExercicesJson = null;
    lastJournauxJson = null;
    lastComptesGenerauxJson = null;
    lastComptesClientsJson = null;
    lastComptesFournisseursJson = null;
    const badgeIds = ["bPublie","bFacture","bQte","bEch","bAna","bAnaNonHier","bAnaCharges","bAnaProduits","bAnaBilan"];
    for (const id of badgeIds) {
      const el = $(id);
      if (!el) continue;
      el.className = "badge na";
      el.textContent = "N/A";
    }
    setAnaSectionsButtonsVisible(false);
    setQteButtonsVisible(false);

    $("vLongueur").textContent = "‚Äî";
    $("vExerciceDefaut").textContent = "‚Äî";
    $("exercicesTableWrap").classList.add("hidden");
    $("btnExercicesDetail").textContent = "D√©tail";
    $("exercicesTbody").innerHTML = "";
    $("vNbJournaux").textContent = "‚Äî";
    $("journauxTableWrap").classList.add("hidden");
    $("btnJournauxDetail").textContent = "D√©tail";
    $("journauxTbody").innerHTML = "";
    $("vNbComptesGeneraux").textContent = "‚Äî";
    $("vNbComptesClients").textContent = "‚Äî";
    $("vNbComptesFournisseurs").textContent = "‚Äî";
    $("comptesGenerauxWrap").classList.add("hidden");
    $("comptesClientsWrap").classList.add("hidden");
    $("comptesFournisseursWrap").classList.add("hidden");
    $("btnComptesGenerauxDetail").textContent = "D√©tail";
    $("btnComptesClientsDetail").textContent = "D√©tail";
    $("btnComptesFournisseursDetail").textContent = "D√©tail";
    $("comptesGenerauxHead").innerHTML = "";
    $("comptesClientsHead").innerHTML = "";
    $("comptesFournisseursHead").innerHTML = "";
    $("comptesGenerauxBody").innerHTML = "";
    $("comptesClientsBody").innerHTML = "";
    $("comptesFournisseursBody").innerHTML = "";
    $("vAnaNiveaux").textContent = "‚Äî";
    $("anaDetails").classList.add("hidden");

    $("donneesComptablesCard").classList.add("hidden");
    $("selectExercice").innerHTML = "";
    $("vNbBalance").textContent = "‚Äî";
    $("vResultat").textContent = "‚Äî";
    $("balanceTableWrap").classList.add("hidden");
    $("btnBalanceDetail").textContent = "D√©tail";
    $("balanceTbody").innerHTML = "";
    lastBalanceJson = null;
    lastBalanceCurl = "";
  
    exercicesList = [];
  }


  function setBadgeBoolOnly(badgeId, value) {
    const b = $(badgeId);
    if (!b) return;
    if (value === true) { b.className="badge ok"; b.textContent="OK"; return; }
    if (value === false){ b.className="badge no"; b.textContent="NO"; return; }
    b.className="badge na"; b.textContent="N/A";
  }

  function setValueOnly(valId, value) {
    const el = $(valId);
    if (!el) return;
    if (value === undefined || value === null || value === "") el.textContent = "‚Äî";
    else el.textContent = String(value);
  }

  function togglePassword(inputId, toggleId){
    const input = $(inputId);
    const tog = $(toggleId);
    if(!input) return;
    const isPwd = input.type === "password";
    input.type = isPwd ? "text" : "password";
    if(tog) tog.textContent = isPwd ? "üôà" : "üëÅ";
  }


  function formatTimeout(timeoutValue) {
    if (timeoutValue === undefined || timeoutValue === null || timeoutValue === "") return "‚Äî";
    const n = Number(timeoutValue);
    if (!Number.isFinite(n) || n <= 0) return String(timeoutValue);
    const mins = Math.round(n);
    if (mins < 60) return `${mins} min`;
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    return m === 0 ? `${h} h` : `${h} h ${m} min`;
  }

  function hideSession() {
    $("sessionArea").classList.add("hidden");
    $("sUuid").textContent = "‚Äî";
    $("sType").textContent = "‚Äî";
    $("sCode").textContent = "‚Äî";
    $("sNom").textContent = "‚Äî";

    $("sPrenom").textContent = "‚Äî";
        const cabEl = $("sCabinetAffectation"); if (cabEl) cabEl.textContent = "‚Äî";
      try { sessionStorage.setItem("ACD_CODE_CABINET", String((window.CodeCabinet || window.codeCabinet || "").trim())); } catch(e) {}
$("sTimeout").textContent = "‚Äî";
    $("sDossierEnCours").textContent = "‚Äî";
    setStatus($("sessionStatus"), "", "");

    $("sNbSecurites").textContent = "‚Äî";
    $("securitesTbody").innerHTML = "";
    $("securitesTableWrap").classList.add("hidden");
    $("btnSecuritesDetail").textContent = "D√©tail";
    lastSecuritesJson = null;

    $("sNbDossiers").textContent = "‚Äî";
    $("sNbCabinets").textContent = "‚Äî";
    $("dossiersTableWrap").classList.add("hidden");
    $("cabinetsTableWrap").classList.add("hidden");
    $("btnDossiersDetail").textContent = "D√©tail";
    $("btnCabinetsDetail").textContent = "D√©tail";
    $("dossiersTbody").innerHTML = "";
    $("cabinetsTbody").innerHTML = "";
    lastDossiersJson = null;
    lastCabinetsJson = null;

    $("sISuiteVersion").textContent = "‚Äî";
    lastInfosJson = null;

    lastAuthJson = null;
      storedCabinetCode = "";
}




  function showSession(authData) {
    
    // Stockage pour export JSON
    lastAuthJson = authData;
const ident = authData?.Identite || {};
    const vars = authData?.VariablesSession || {};

    $("sDossierEnCours").textContent = vars?.ADR_CODE ?? "‚Äî";

    $("sUuid").textContent = authData?.UUID || storedUUID || "‚Äî";
    $("sType").textContent = ident?.Type || "‚Äî";
    $("sCode").textContent = ident?.Code || "‚Äî";
    $("sNom").textContent = ident?.Nom || "‚Äî";

    $("sPrenom").textContent = ident?.Prenom || "‚Äî";

    
    const cabEl = $("sCabinetAffectation"); if (cabEl) cabEl.textContent = storedCabinetCode || "‚Äî";
const timeoutRaw = vars?.SESSION_TIMEOUT ?? storedTimeout ?? "";
    storedTimeout = timeoutRaw ? String(timeoutRaw) : "";
    sessionStorage.setItem("ACD_SESSION_TIMEOUT", storedTimeout);
    $("sTimeout").textContent = formatTimeout(timeoutRaw);

    $("sessionArea").classList.remove("hidden");


    // Donn√©es de visibilit√©
    fetchInformations();
    fetchSecurites(authData);
    fetchDossiers();
    fetchCabinets();
  }


  async function fetchCabinetAffectation(identifiant) {
    try {
      if (!storedBaseApi || !storedUUID) return;
      if (!identifiant) return;

      const url = joinUrlParts(storedBaseApi, "v1/collaborateurs/" + encodeURIComponent(String(identifiant).trim()));
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      let data = null;
      try { data = raw ? JSON.parse(raw) : null; } catch { data = { raw }; }

      if (!resp.ok) return;

      const code = data?.Societe?.Code;
      if (code && String(code).trim()) {
        storedCabinetCode = String(code).trim();
        const cabEl = $("sCabinetAffectation");
        if (cabEl) cabEl.textContent = storedCabinetCode;
        try { if (storedCabinetCode) sessionStorage.setItem("ACD_CODE_CABINET", storedCabinetCode); } catch(e) {} try { sessionStorage.setItem("ACD_CODE_CABINET", storedCabinetCode); } catch(e) {}
      }
    } catch {
      // silencieux
    }
  }


  function resetOutputs() {
    const cjb = document.getElementById("comptaJsonBox");
    if (cjb) cjb.textContent = "‚Äî";
    const ejb = document.getElementById("exercicesJsonBox");
    if (ejb) ejb.textContent = "‚Äî";    const dib=$("dossierInfoBox"); if(dib) dib.textContent="‚Äî";
    resetBadges();

    setStatus($("status"), "", "");
    setStatus($("status2"), "", "");
    setStatus($("dossierStatus"), "", "");
    setStatus($("comptaStatus"), "", "");

    hideSession();
  }

  async function authenticateWithLogin() {
    resetOutputs();

    const inputUrl = ($("urlInput2")?.value || $("urlInput")?.value || "");
    
    storedBaseUrlSaisie = String(inputUrl || "").trim();
    sessionStorage.setItem("ACD_BASE_URL_SAISIE", storedBaseUrlSaisie);
const login = ($("loginInput").value || "").trim();
    const pwd = $("pwdInput").value || "";

    if (!inputUrl || !login || !pwd) {
      setStatus($("status"), "Champs requis manquants.", "err");
      return;
    }

    let baseApi;
    try { baseApi = buildBaseApiUrl(inputUrl); }
    catch { setStatus($("status"), "URL invalide.", "err"); return; }

    storedBaseApi = baseApi;
    const authUrl = joinUrlParts(baseApi, "v1/authentification");

    setStatus($("status"), "Connexion‚Ä¶");

    try {
      const resp = await fetchWithTrace(authUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ Identifiant: login, MotDePasse: pwd })
      });

      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; }
      catch { data = { raw }; }


      /* balance stored separately */
      if (!resp.ok) {
        const apiMsg = (data && typeof data === "object" && data.Message) ? String(data.Message) : "";
        setStatus($("status"), `Erreur HTTP ${resp.status}${apiMsg ? " ‚Äî " + apiMsg : ""}.`, "err");
        return;
      }
      if (!data?.UUID || typeof data.UUID !== "string" || !data.UUID.trim()) { setStatus($("status"), "UUID absent.", "err"); return; }

      storedUUID = data.UUID.trim();
      sessionStorage.setItem("ACD_UUID", storedUUID);
      sessionStorage.setItem("ACD_BASE_API", storedBaseApi);

      updateAuthUI();
      showSession(data);
      await fetchCabinetAffectation(login);
      setStatus($("status"), "Connect√©.", "ok");
} catch {
      setStatus($("status"), "Erreur r√©seau.", "err");
    }
  }

  async function authenticateWithUuid() {
    resetOutputs();

    const inputUrl = ( $("urlInput2")?.value ?? $("urlInput")?.value ?? "" );

    // Synchronise les 2 champs URL (Connexion / UUID) pour √©viter les champs "vides" selon l'onglet
    const ui1 = $("urlInput");
    const ui2 = $("urlInput2");
    if (ui1 && ui2) {
      const v = String(inputUrl || "").trim();
      if (v && ui1.value !== v) ui1.value = v;
      if (v && ui2.value !== v) ui2.value = v;
    }

    
    storedBaseUrlSaisie = String(inputUrl || "").trim();
    sessionStorage.setItem("ACD_BASE_URL_SAISIE", storedBaseUrlSaisie);
const uuid = ($("uuidInput").value || "").trim();

    if (!inputUrl || !uuid) {
      setStatus($("status2"), "Champs requis manquants.", "err");
      return;
    }

    let baseApi;
    try { baseApi = buildBaseApiUrl(inputUrl); }
    catch { setStatus($("status2"), "URL invalide.", "err"); return; }

    storedBaseApi = baseApi;
    const authUuidUrl = joinUrlParts(baseApi, "v1/authentification/uuid");

    setStatus($("status2"), "Validation‚Ä¶");

    try {
      const resp = await fetchWithTrace(authUuidUrl, {
        method: "POST",
        headers: { "accept": "text/plain", "Content-Type": "application/json-patch+json" },
        body: JSON.stringify({ UUID: uuid })
      });

      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; }
      catch { data = { raw }; }


      /* balance stored separately */
      if (!resp.ok) {
        const apiMsg = (data && typeof data === "object" && data.Message) ? String(data.Message) : "";
        setStatus($("status2"), `Erreur HTTP ${resp.status}${apiMsg ? " ‚Äî " + apiMsg : ""}.`, "err");
        return;
      }

      storedUUID = (data?.UUID && typeof data.UUID === "string" && data.UUID.trim()) ? data.UUID.trim() : uuid;
      sessionStorage.setItem("ACD_UUID", storedUUID);
      sessionStorage.setItem("ACD_BASE_API", storedBaseApi);

      updateAuthUI();
      const dataForSession = (data && typeof data === "object") ? data : { UUID: storedUUID, Identite: {}, VariablesSession: {} };
      if (!dataForSession.UUID) dataForSession.UUID = storedUUID;
      showSession(dataForSession);

      setStatus($("status2"), "Connect√©.", "ok");
    } catch {
      setStatus($("status2"), "Erreur r√©seau.", "err");
    }
  }

  async function validateDossier() {
    setStatus($("dossierStatus"), "", "");
    setStatus($("comptaStatus"), "", "");
    const dib=$("dossierInfoBox"); if(dib) dib.textContent="‚Äî";
    (document.getElementById("comptaJsonBox") ? (document.getElementById("comptaJsonBox").textContent = "‚Äî") : null);
    (document.getElementById("exercicesJsonBox") ? (document.getElementById("exercicesJsonBox").textContent = "‚Äî") : null);
    (document.getElementById("exercicesJsonBox") ? (document.getElementById("exercicesJsonBox").textContent = "‚Äî") : null);
    resetBadges();
    $("afterDossierSection").classList.add("hidden");

    const codeDossier = ($("dossierInput").value || "").trim();
    if (!storedBaseApi || !storedUUID) { setStatus($("dossierStatus"), "Connexion requise.", "err"); return; }
    if (!codeDossier) { setStatus($("dossierStatus"), "Code dossier requis.", "err"); return; }

    const postUrl = joinUrlParts(storedBaseApi, "v2/sessions/dossier");
    const getUrl  = joinUrlParts(storedBaseApi, "v1/sessions/dossier");
    setStatus($("dossierStatus"), "Traitement‚Ä¶");
    jsConsoleLog("Dossier URLs", { postUrl, getUrl, codeDossier });

    try {
      const postResp = await fetchWithTrace(postUrl, {
        method: "POST",
        headers: { "accept": "text/plain", "UUID": storedUUID, "Content-Type": "application/json-patch+json" },
        body: JSON.stringify(codeDossier)
      });
      jsConsoleLog("POST /v2/sessions/dossier", { status: postResp.status, ok: postResp.ok });
      if (!postResp.ok) {
        const errRaw = await postResp.text().catch(() => "");
        throw new Error(`Erreur HTTP ${postResp.status} : ${extractApiMessage(errRaw) || errRaw || "Erreur POST dossier."}`);
      }

      const getResp = await fetchWithTrace(getUrl, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      jsConsoleLog("GET /v1/sessions/dossier", { status: getResp.status, ok: getResp.ok });

      const raw = await getResp.text();
      let dossierData;
      try { dossierData = raw ? JSON.parse(raw) : null; }
      catch { dossierData = { raw }; }

      if (!getResp.ok) throw new Error(`Erreur HTTP ${getResp.status} : ${extractApiMessage(raw) || raw || "Erreur GET dossier."}`);

      const code = dossierData?.Code ?? "";
      const nom = dossierData?.Nom ?? "";
      const siret = dossierData?.SIRET ?? "";
      const societeCode = dossierData?.Societe?.Code ?? "";
      const genreCode = dossierData?.Genre?.Code ?? "";

      $("dossierInfoBox").innerHTML =
        `<strong>Code du dossier : ${escapeHtml(code)}</strong>\n` +
        `Nom du dossier : ${escapeHtml(nom)}\n` +
        `SIRET : ${escapeHtml(siret)}\n` +
        `Cabinet de rattachement (Code) : ${escapeHtml(societeCode)}\n` +
        `Genre du dossier (Code) : ${escapeHtml(genreCode)}\n`;

      setStatus($("dossierStatus"), "Dossier OK.", "ok");
      showGedSection();
        $("afterDossierSection").classList.remove("hidden");
        $("afterDossierSection").classList.remove("hidden");
      await fetchComptaDossier();
    fetchCodesTva();
    } catch (e) {
      const msg = (e && e.message) ? e.message : String(e);
      jsConsoleLog("Erreur validateDossier", { message: msg, stack: e && e.stack ? e.stack : null });
      setStatus($("dossierStatus"), msg || "Erreur dossier.", "err");
    }
  }

  function getAnalytiqueObject(data) {
    if (!data) return null;
    const a = data.Analytique;
    if (a && typeof a === "object") return a;
    for (const k of ["AnalytiqueParametrage","ParametrageAnalytique","ParametresAnalytique"]) {
      if (data[k] && typeof data[k] === "object") return data[k];
    }
    return null;
  }

  function boolFromAny(v) {
    if (v === true || v === false) return v;
    if (typeof v === "string") {
      const s = v.trim().toLowerCase();
      if (s === "true" || s === "1" || s === "oui" || s === "yes") return true;
      if (s === "false" || s === "0" || s === "non" || s === "no") return false;
    }
    if (typeof v === "number") return v !== 0;
    return null;
  }

  function boolFromON(v) {
    if (v === true || v === false) return v;
    if (typeof v === "string") {
      const s = v.trim().toUpperCase();
      if (s === "O" || s === "Y" || s === "1" || s === "TRUE") return true;
      if (s === "N" || s === "0" || s === "FALSE") return false;
    }
    if (typeof v === "number") return v !== 0;
    return null;
  }

  async function fetchComptaDossier() {
    setStatus($("comptaStatus"), "R√©cup√©ration‚Ä¶");
    (document.getElementById("comptaJsonBox") ? (document.getElementById("comptaJsonBox").textContent = "‚Äî") : null);
    (document.getElementById("exercicesJsonBox") ? (document.getElementById("exercicesJsonBox").textContent = "‚Äî") : null);
    (document.getElementById("exercicesJsonBox") ? (document.getElementById("exercicesJsonBox").textContent = "‚Äî") : null);
    resetBadges();

    const url = joinUrlParts(storedBaseApi, "v1/compta/dossier");

    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; }
      catch { data = { raw }; }

      // M√©morisation pour le bouton JSON / exports
      lastComptaDossierJson = data;
      lastComptaDossierConfigJson = data;

      (document.getElementById("comptaJsonBox") ? (document.getElementById("comptaJsonBox").textContent = JSON.stringify(data, null, 2)) : null);

      /* balance stored separately */
      if (!resp.ok) {
        // Motif : champ Message si JSON, sinon texte brut
        let apiMsg = "";
        if (data && typeof data === "object") {
          apiMsg = data.Message ?? data.message ?? data.Raw ?? data.raw ?? "";
        } else if (typeof data === "string") {
          apiMsg = data;
        }
        if (!apiMsg && typeof raw === "string") apiMsg = raw;
        apiMsg = String(apiMsg || "").trim();
        setStatus($("comptaStatus"), `Erreur HTTP ${resp.status}${apiMsg ? " : " + apiMsg : ""}.`, "err");
        return;
      }

      setBadgeBoolOnly("bPublie", boolFromAny(data?.PublieSurISuite));
      setValueOnly("vLongueur", data?.LongueurComptes);
      setBadgeBoolOnly("bFacture", boolFromON(data?.GestionNumeroFacture));
      setBadgeBoolOnly("bQte", boolFromAny(data?.GestionQuantites));
      
      const qteActive = boolFromAny(data?.GestionQuantites);
      setQteButtonsVisible(qteActive === true);

      // Param√®tres quantit√©s (si gestion activ√©e)
      if (qteActive === true) {
        await fetchQuantitesParams();
      } else {
        lastQteParamsJson = null;
        const qwrap = $("qteTableWrap");
        if (qwrap) qwrap.classList.add("hidden");
        $("qteDetailBtn") && ($("qteDetailBtn").textContent = "D√©tail");
      }
setBadgeBoolOnly("bEch", boolFromON(data?.GestionEcheancier));

      const anaObj = getAnalytiqueObject(data);
      let anaActive = null;
      if (anaObj) anaActive = boolFromAny(anaObj.Active);
      else anaActive = boolFromAny(data?.Analytique);

      setBadgeBoolOnly("bAna", anaActive);

      setAnaSectionsButtonsVisible(anaActive === true);

      // Sections analytiques (si analytique activ√©e)
      if (anaActive === true) {
        await fetchAnalytiqueSections();
      } else {
        lastAnaSectionsJson = null;
        const wrap = $("anaSectionsTableWrap");
        if (wrap) wrap.classList.add("hidden");
        $("anaSectionsDetailBtn") && ($("anaSectionsDetailBtn").textContent = "D√©tail");
      }


      // Param√©trage analytique peut √™tre directement sous Analytique, ou sous Analytique.Parametrage
      const anaParams = (anaObj && typeof anaObj === "object")
        ? (anaObj.Parametrage && typeof anaObj.Parametrage === "object" ? anaObj.Parametrage : anaObj)
        : null;

      if (anaActive === true && anaParams) {
        $("anaDetails").classList.remove("hidden");

        setBadgeBoolOnly("bAnaNonHier", boolFromAny(anaParams.NonHierarchise));
        setValueOnly("vAnaNiveaux", anaParams.NombreNiveaux);

        setBadgeBoolOnly("bAnaCharges", boolFromAny(anaParams.CompteCharges));
        setBadgeBoolOnly("bAnaProduits", boolFromAny(anaParams.CompteProduits));
        setBadgeBoolOnly("bAnaBilan", boolFromAny(anaParams.CompteBilan));
      } else {
        $("anaDetails").classList.add("hidden");
      }

      await fetchComptaExercices();
      await fetchComptaJournaux();
      await fetchComptaComptes();

      setStatus($("comptaStatus"), "Param√©trage r√©cup√©r√©.", "ok");
    } catch {
      setStatus($("comptaStatus"), "Erreur r√©seau.", "err");
    }
  }
  async function fetchComptaExercices() {
    // R√©cup√®re l'exercice courant (Courant = 1) et affiche DateDebut/DateFin
    (document.getElementById("exercicesJsonBox") ? (document.getElementById("exercicesJsonBox").textContent = "‚Äî") : null);
    setValueOnly("vExerciceDefaut", "‚Äî");

    const url = joinUrlParts(storedBaseApi, "v1/compta/exercices");

    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; }
      catch { data = { raw }; }

      (document.getElementById("exercicesJsonBox") ? (document.getElementById("exercicesJsonBox").textContent = JSON.stringify(data, null, 2)) : null);
      lastExercicesJson = data;
      lastExerciceDefautCurl = resp.__acdCurl || "";

      if (!resp.ok) return;

      if (Array.isArray(data)) {
        // Tableau des exercices (affich√© via bouton "D√©tail")
        try {
          $("exercicesTbody").innerHTML = data.map(x => `
            <tr>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(formatDateFr(x?.DateDebut))}</td>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(formatDateFr(x?.DateFin))}</td>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(x?.Courant ?? ""))}</td>
            </tr>
          `).join("");
        } catch { /* ignore */ }

        // Liste exercices pour le menu d√©roulant
        exercicesList = Array.isArray(data) ? data : [];
        populateExercicesSelect();


        const courant = data.find(x => (x && (x.Courant === 1 || x.Courant === true || String(x.Courant) === "1" || String(x.Courant).toLowerCase() === "true")));
        if (courant && courant.DateDebut && courant.DateFin) {
          setValueOnly("vExerciceDefaut", `${formatDateFr(courant.DateDebut)} ‚Üí ${formatDateFr(courant.DateFin)}`);
        } else {
          // fallback : premier exercice si pas de courant
          const first = data[0];
          if (first && first.DateDebut && first.DateFin) setValueOnly("vExerciceDefaut", `${formatDateFr(first.DateDebut)} ‚Üí ${formatDateFr(first.DateFin)}`);
        }
      }
    } catch {
      // silencieux : ne doit pas bloquer l'affichage principal
    }
  }




  

  function exerciceLabel(ex) {
    const d1 = formatDateFr(ex?.DateDebut);
    const d2 = formatDateFr(ex?.DateFin);
    const c = (ex?.Courant === 1 || ex?.Courant === true || String(ex?.Courant) === "1") ? " (d√©faut)" : "";
    return `${d1} ‚Üí ${d2}${c}`;
  }

  function isCourant(ex) {
    return ex && (ex.Courant === 1 || ex.Courant === true || String(ex.Courant) === "1" || String(ex.Courant).toLowerCase() === "true");
  }

  function populateExercicesSelect() {
    const sel = $("selectExercice");
    if (!sel) return;
    sel.innerHTML = "";

    if (!Array.isArray(exercicesList) || exercicesList.length === 0) return;

    exercicesList.forEach((ex, i) => {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = exerciceLabel(ex);
      sel.appendChild(opt);
    });

    // s√©lectionner l'exercice courant par d√©faut si pr√©sent
    const idxCourant = exercicesList.findIndex(isCourant);
    sel.value = String(idxCourant >= 0 ? idxCourant : 0);

    // Afficher le bloc Donn√©es comptable (apr√®s r√©cup√©ration des exercices)
    $("donneesComptablesCard").classList.remove("hidden");
  }

  function getSelectedExercice() {
    const sel = $("selectExercice");
    const idx = sel && sel.value ? parseInt(sel.value, 10) : 0;
    if (!Array.isArray(exercicesList) || exercicesList.length === 0) return null;
    return exercicesList[Math.max(0, Math.min(idx, exercicesList.length - 1))];
  }


  async function fetchComptaJournaux() {
    $("vNbJournaux").textContent = "‚Äî";
    $("journauxTableWrap").classList.add("hidden");
    $("btnJournauxDetail").textContent = "D√©tail";
    $("journauxTbody").innerHTML = "";
    $("vNbComptesGeneraux").textContent = "‚Äî";
    $("vNbComptesClients").textContent = "‚Äî";
    $("vNbComptesFournisseurs").textContent = "‚Äî";
    $("comptesGenerauxWrap").classList.add("hidden");
    $("comptesClientsWrap").classList.add("hidden");
    $("comptesFournisseursWrap").classList.add("hidden");
    $("btnComptesGenerauxDetail").textContent = "D√©tail";
    $("btnComptesClientsDetail").textContent = "D√©tail";
    $("btnComptesFournisseursDetail").textContent = "D√©tail";
    $("comptesGenerauxHead").innerHTML = "";
    $("comptesClientsHead").innerHTML = "";
    $("comptesFournisseursHead").innerHTML = "";
    $("comptesGenerauxBody").innerHTML = "";
    $("comptesClientsBody").innerHTML = "";
    $("comptesFournisseursBody").innerHTML = "";

    const url = joinUrlParts(storedBaseApi, "v1/compta/journal");

    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; }
      catch { data = null; }

      if (!resp.ok) return;

      if (Array.isArray(data)) {
        lastJournauxJson = data;
        $("vNbJournaux").textContent = String(data.length);

        const rows = data.map(j => ({
          Code: j?.Code ?? "",
          Libelle: j?.Libelle ?? "",
          Nature: j?.Nature ?? "",
          TypeDeSaisie: j?.TypeDeSaisie ?? "",
          CompteDeTresorerie: (j?.CompteDeTresorerie ?? ""),
          NumeroFacture: (j?.NumeroFacture === true ? "true" : (j?.NumeroFacture === false ? "false" : (j?.NumeroFacture ?? "")))
        }));

        $("journauxTbody").innerHTML = rows.map(r => `
          <tr>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(r.Code)}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(r.Libelle)}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(r.Nature)}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(r.TypeDeSaisie)}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(r.CompteDeTresorerie)}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(r.NumeroFacture)}</td>
          </tr>
        `).join("");
      }
    } catch {
      // silencieux
    }
  }


  

  function numOrZero(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  
  async function downloadFec() {
    const ex = getSelectedExercice();
    if (!ex) {
      setStatus($("donneesComptablesStatus"), "Aucun exercice s√©lectionn√©.", "err");
      return;
    }

    const url = joinUrlParts(storedBaseApi, "v1/compta/fec");
    const body = {
      DateDebut: ex.DateDebut, // YYYY-MM-DD
      DateFin: ex.DateFin      // YYYY-MM-DD
    };

    try {
      setStatus($("donneesComptablesStatus"), "T√©l√©chargement FEC en cours‚Ä¶", "info");

      const resp = await fetchWithTrace(url, {
        method: "POST",
        headers: {
          "accept": "text/plain",
          "UUID": storedUUID,
          "Content-Type": "application/json-patch+json"
        },
        body: JSON.stringify(body)
      });

      const raw = await resp.text();

      if (!resp.ok) {
        let msg = raw;
        try {
          const j = JSON.parse(raw);
          msg = j?.Message ?? j?.message ?? raw;
        } catch {}
        const errPayload = { status: resp.status, ok: false, body: (data && typeof data === "object") ? data : { Message: String(raw || msg || "") } };
        setStatus($("donneesComptablesStatus"), `Erreur HTTP ${resp.status}${msg ? " : " + msg : ""}.`, "err");
        setRowError("vNbJournaux", errPayload);
        return;
      }

      // L'API renvoie g√©n√©ralement un fichier en texte (FEC). On cr√©e un blob √† partir du contenu.
      const blob = new Blob([raw], { type: "text/plain;charset=utf-8" });

      const fileName = `FEC_${ex.DateDebut}_${ex.DateFin}.txt`;

      const link = document.createElement("a");
      link.href = window.URL.createObjectURL(blob);
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      setStatus($("donneesComptablesStatus"), "FEC t√©l√©charg√©.", "ok");
    } catch {
      setStatus($("donneesComptablesStatus"), "Erreur lors du t√©l√©chargement FEC.", "err");
    }
  }


  

async function fetchBalanceGeneraux() {
    const ex = getSelectedExercice();
    if (!ex) {
      setStatus($("donneesComptablesStatus"), "Aucun exercice disponible.", "err");
      return;
    }

    $("vNbBalance").textContent = "‚Äî";
    $("vResultat").textContent = "‚Äî";
    $("balanceTbody").innerHTML = "";
    $("balanceTableWrap").classList.add("hidden");
    $("btnBalanceDetail").textContent = "D√©tail";
    lastBalanceJson = null;
    lastBalanceCurl = "";
  

    const url = joinUrlParts(storedBaseApi, "v1/compta/balance/generaux");
    const body = {
      CptDebut: "1",
      CptFin: "79999999",
      DateDebut: ex.DateDebut,
      DateFin: ex.DateFin,
      RecupererANouveau: true
    };

    try {
      setStatus($("donneesComptablesStatus"), "Calcul en cours‚Ä¶", "info");
      const resp = await fetchWithTrace(url, {
        method: "POST",
        headers: {
          "accept": "text/plain",
          "UUID": storedUUID,
          "Content-Type": "application/json-patch+json"
        },
        body: JSON.stringify(body)
      });
      lastBalanceCurl = window.lastGeneratedCurl || "";

      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; } catch { data = raw; }

      /* balance stored separately */
      if (!resp.ok) {
        const apiMsg = (data && typeof data === "object") ? (data.Message ?? data.message ?? "") : "";
        const errPayload = { status: resp.status, ok: false, body: (data && typeof data === "object") ? data : { Message: String(raw || apiMsg || "") } };
        setStatus($("donneesComptablesStatus"), `Erreur HTTP ${resp.status}${apiMsg ? " : " + apiMsg : ""}.`, "err");
        setRowError("vNbBalance", errPayload);
        $("vResultat").textContent = "‚Äî";
        lastResultBalance = null;
        updateEcartGLBalance();
        return;
      }

      if (!Array.isArray(data)) {
        const errPayload = { status: resp.status, ok: false, body: { Message: "R√©ponse inattendue (balance)." } };
        setStatus($("donneesComptablesStatus"), "R√©ponse inattendue (balance).", "err");
        setRowError("vNbBalance", errPayload);
        $("vResultat").textContent = "‚Äî";
        lastResultBalance = null;
        updateEcartGLBalance();
        return;
      }

      lastBalanceJson = data;
      $("vNbBalance").textContent = String(data.length);

      // Calcul r√©sultat = (Œ£ Solde comptes 7) - (Œ£ Solde comptes 6)
      let sum7 = 0;
      let sum6 = 0;

      data.forEach(it => {
        const code = String(it?.Code ?? "").trim();
        const solde = numOrZero(it?.Solde);
        if (code.startsWith("7")) sum7 += solde;
        if (code.startsWith("6")) sum6 += solde;
      });

      const resultat = (-sum7) - (sum6);

      // Affichage d√©taill√© (utile au contr√¥le)
      lastResultBalance = resultat;
      $("vResultat").textContent = formatEuroSafe(resultat);
      updateEcartGLBalance();


      // Tableau d√©tail
      $("balanceTbody").innerHTML = data.map(it => {
        const code = it?.Code ?? "";
        const lib = it?.Lib ?? "";
        const deb = it?.Deb ?? 0;
        const cre = it?.Cre ?? 0;
        const solde = it?.Solde ?? 0;
        return `
          <tr>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(code))}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(String(lib))}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border); text-align:right; font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(deb))}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border); text-align:right; font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(cre))}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border); text-align:right; font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(solde))}</td>
          </tr>`;
      }).join("");

      setStatus($("donneesComptablesStatus"), "Calcul termin√©.", "ok");
    } catch {
      setStatus($("donneesComptablesStatus"), "Erreur lors de l‚Äôappel balance.", "err");
    }
  }

  async function fetchGrandLivre(endpointPath, label, infoSpanId, assignResult){
    const ex = getSelectedExercice();
    if (!ex) {
      $(infoSpanId).textContent = "Aucun exercice.";
      assignResult(null);
      return;
    }

    const url = joinUrlParts(storedBaseApi, endpointPath);

    // payload demand√©
    const rangesByEndpoint = {
      "v1/compta/grandlivre/generaux": { CptDebut: "1", CptFin: "799999" },
      "v1/compta/grandlivre/clients": { CptDebut: "C", CptFin: "CZZZZZZZZZZZZ" },
      "v1/compta/grandlivre/fournisseurs": { CptDebut: "F", CptFin: "FZZZZZZZZZZZZ" }
    };

    const range = rangesByEndpoint[String(endpointPath || "")] || { CptDebut: "1", CptFin: "799999" };

    // payload demand√©
    const body = {
      CptDebut: range.CptDebut,
      CptFin: range.CptFin,
      DateDebut: ex.DateDebut,
      DateFin: ex.DateFin,
      RecupererAnalytique: true,
      RecupererEcheances: true,
      RecupererANouveau: true,
      RecupererEcritureId: true
    };

    // UI
    $(infoSpanId).textContent = label + " : en cours‚Ä¶";

    try{
      const resp = await fetchWithTrace(url, {
        method: "POST",
        headers: {
          "accept": "text/plain",
          "UUID": storedUUID,
          "Content-Type": "application/json-patch+json"
        },
        body: JSON.stringify(body)
      });

      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; } catch { data = raw; }

      if(!resp.ok){
        const apiMsg = (data && typeof data === "object") ? (data.Message ?? data.message ?? "") : "";
        const errPayload = { status: resp.status, ok: false, body: (data && typeof data === "object") ? data : { Message: String(raw || apiMsg || "") } };
        setSpanError(infoSpanId, label, errPayload);
        assignResult(null);
        return;
      }

      if(!Array.isArray(data)){
        setSpanError(infoSpanId, label, { status: resp.status, ok: false, body: { Message: "R√©ponse inattendue." } });
        assignResult(null);
        return;
      }

      assignResult(data);
      $(infoSpanId).textContent = `${label} : ${data.length} lignes`;
    }catch(e){
      setSpanError(infoSpanId, label, { status: 0, ok: false, body: { Message: e && e.message ? e.message : "Erreur r√©seau" } });
      assignResult(null);
    }
  }

  function refreshGrandLivreButtons(){
    const hasGen = Array.isArray(lastGrandLivreGenerauxJson) && lastGrandLivreGenerauxJson.length>0;
    const hasCli = Array.isArray(lastGrandLivreClientsJson) && lastGrandLivreClientsJson.length>0;
    const hasFou = Array.isArray(lastGrandLivreFournisseursJson) && lastGrandLivreFournisseursJson.length>0;

    $("btnGLGenerauxCsv").disabled = !hasGen;
    $("btnGLGenerauxJson").disabled = !hasGen;
    $("btnGLClientsCsv").disabled = !hasCli;
    $("btnGLClientsJson").disabled = !hasCli;
    $("btnGLFournisseursCsv").disabled = !hasFou;
    $("btnGLFournisseursJson").disabled = !hasFou;
  }

  async function fetchAllGrandLivres(){
    // reset before run
    $("glGenInfo").textContent = "‚Äî";
    const elResGL = document.getElementById("vResultatGL");
    if (elResGL) elResGL.textContent = "‚Äî";
    lastResultGL = null;
    updateEcartGLBalance();
    $("glCliInfo").textContent = "‚Äî";
    $("glFouInfo").textContent = "‚Äî";
    lastGrandLivreGenerauxJson = null;
    lastGrandLivreClientsJson = null;
    lastGrandLivreFournisseursJson = null;
    refreshGrandLivreButtons();

    await fetchGrandLivre("v1/compta/grandlivre/generaux", "Grand livre g√©n√©raux", "glGenInfo", (v)=>{
      lastGrandLivreGenerauxJson = v;
      // Calcul : R√©sultat depuis GL = CreE - DebE pour les comptes 6* ou 7*
      try {
        const r = computeResultatDepuisGL(v);
        const el = document.getElementById("vResultatGL");
        if (el) el.textContent = (r === null || Number.isNaN(r)) ? "‚Äî" : formatEuroSafe(r);
        lastResultGL = (r === null || Number.isNaN(r)) ? null : r;
        updateEcartGLBalance();
      } catch (e) {
        console.warn("Calcul r√©sultat GL impossible:", e);
        const el = document.getElementById("vResultatGL");
        if (el) el.textContent = "‚Äî";
        lastResultGL = null;
        updateEcartGLBalance();
      }
    });
    refreshGrandLivreButtons();

    await fetchGrandLivre("v1/compta/grandlivre/clients", "Grand livre clients", "glCliInfo", (v)=>{ lastGrandLivreClientsJson=v; });
    refreshGrandLivreButtons();

    await fetchGrandLivre("v1/compta/grandlivre/fournisseurs", "Grand livre fournisseurs", "glFouInfo", (v)=>{ lastGrandLivreFournisseursJson=v; });
    refreshGrandLivreButtons();
  }




  async function fetchComptaComptes() {
    const calls = [
      { url: joinUrlParts(storedBaseApi, "v1/compta/comptes/generaux"), countId: "vNbComptesGeneraux", headId: "comptesGenerauxHead", bodyId: "comptesGenerauxBody" },
      { url: joinUrlParts(storedBaseApi, "v1/compta/comptes/clients"), countId: "vNbComptesClients", headId: "comptesClientsHead", bodyId: "comptesClientsBody" },
      { url: joinUrlParts(storedBaseApi, "v1/compta/comptes/fournisseurs"), countId: "vNbComptesFournisseurs", headId: "comptesFournisseursHead", bodyId: "comptesFournisseursBody" },
    ];

    for (const c of calls) {
try {
  const t0 = performance.now();
  const resp = await fetchWithTrace(c.url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
  const raw = await resp.text();
  const durationMs = Math.round((performance.now() - t0) * 100) / 100;

  let parsed = null;
  try { parsed = raw ? JSON.parse(raw) : null; } catch { parsed = null; }

  if (resp.ok && Array.isArray(parsed)) {
    if (c.countId === "vNbComptesGeneraux") lastComptesGenerauxJson = parsed;
    if (c.countId === "vNbComptesClients") lastComptesClientsJson = parsed;
    if (c.countId === "vNbComptesFournisseurs") lastComptesFournisseursJson = parsed;

    $(c.countId).textContent = String(parsed.length);
    renderAccountsTable(parsed, c.headId, c.bodyId);
  } else if (!resp.ok) {
    // Important : conserver le d√©tail d'erreur pour le bouton JSON
    const errObj = (parsed && typeof parsed === "object") ? parsed : { Message: (raw || `HTTP ${resp.status}`) };

    const errPayload = {
      status: resp.status,
      ok: false,
      durationMs: durationMs,
      body: errObj
    };

    if (c.countId === "vNbComptesGeneraux") lastComptesGenerauxJson = errPayload;
    if (c.countId === "vNbComptesClients") lastComptesClientsJson = errPayload;
    if (c.countId === "vNbComptesFournisseurs") lastComptesFournisseursJson = errPayload;

    setRowError(c.countId, errPayload);
    // tableau vide (on laisse le d√©tail via JSON)
    renderAccountsTable([], c.headId, c.bodyId);
  }
} catch (e) {
  // Important : conserver le d√©tail d'erreur pour le bouton JSON
  const errPayload = { status: 0, ok: false, durationMs: 0, body: { Message: e && e.message ? e.message : "Erreur r√©seau" } };

  if (c.countId === "vNbComptesGeneraux") lastComptesGenerauxJson = errPayload;
  if (c.countId === "vNbComptesClients") lastComptesClientsJson = errPayload;
  if (c.countId === "vNbComptesFournisseurs") lastComptesFournisseursJson = errPayload;

  setRowError(c.countId, errPayload);
  renderAccountsTable([], c.headId, c.bodyId);
}
    }
  }


  

  async function fetchInformations() {
    $("sISuiteVersion").textContent = "‚Äî";
    lastInfosJson = null;

    // Route : /api/informations (sur base URL saisie, pas sur base API)
    const url = joinUrlParts(storedBaseApi, "informations");

    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; } catch { data = raw; }

      if (!resp.ok || !data || typeof data !== "object") return;

      lastInfosJson = data;
      lastApiInformationsJson = data;
      const inst = data.VersioniSuiteInstallee ?? "‚Äî";
      const disp = data.VersioniSuiteDisponible ?? "‚Äî";
      $("sISuiteVersion").textContent = `${inst} / ${disp}`;
    } catch {
      // silencieux
    }
  }



  async function fetchSecurites(authData) {
    $("sNbSecurites").textContent = "‚Äî";
    $("securitesTbody").innerHTML = "";
    $("securitesTableWrap").classList.add("hidden");
    $("btnSecuritesDetail").textContent = "D√©tail";
    lastSecuritesJson = null;

    const ident = authData?.Identite || {};
    const identifiant = (ident?.Code || "").toString().trim();

    // L‚Äôendpoint est pertinent principalement pour une connexion Collaborateur
    if (!storedBaseApi || !storedUUID || !identifiant) return;

    const url = joinUrlParts(storedBaseApi, `v1/collaborateurs/${encodeURIComponent(identifiant)}`);

    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; } catch { data = raw; }

      if (!resp.ok || !data || typeof data !== "object") return;

      // M√©morisation
      lastSecuritesJson = data;

      const securites = Array.isArray(data?.Securites) ? data.Securites : (Array.isArray(data?.SecuritesFonctionnelles) ? data.SecuritesFonctionnelles : []);
      $("sNbSecurites").textContent = String(securites.length);

      $("securitesTbody").innerHTML = securites.map(s => {
        const code = s?.Code ?? "";
        const lib = s?.Libelle ?? s?.Libell√© ?? "";
        const parent = s?.CodeParent ?? "";
        return `
          <tr>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(code))}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(String(lib))}</td>
            <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(parent))}</td>
          </tr>`;
      }).join("");
    } catch {
      // silencieux
    }
  }


  async function fetchDossiers() {
    $("sNbDossiers").textContent = "‚Äî";
    $("dossiersTbody").innerHTML = "";
    $("dossiersTableWrap").classList.add("hidden");
    $("btnDossiersDetail").textContent = "D√©tail";
    lastDossiersJson = null;

    const url = joinUrlParts(storedBaseApi, "v1/dossiers");

    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; } catch { data = raw; }

      if (!resp.ok) return;

      if (Array.isArray(data)) {
        lastDossiersJson = data;
        $("sNbDossiers").textContent = String(data.length);

        $("dossiersTbody").innerHTML = data.map(d => {
          const genre = d?.Genre?.Code ?? "";
          const cab = d?.Societe?.Code ?? "";
          const siret = d?.Siret ?? "";
          return `
            <tr>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(d?.Id ?? ""))}</td>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(d?.Code ?? ""))}</td>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(String(d?.Nom ?? ""))}</td>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(genre))}</td>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(cab))}</td>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(siret))}</td>
            </tr>`;
        }).join("");
      }
    } catch {
      // silencieux
    }
  }

  async function fetchCabinets() {
    $("sNbCabinets").textContent = "‚Äî";
    $("cabinetsTbody").innerHTML = "";
    $("cabinetsTableWrap").classList.add("hidden");
    $("btnCabinetsDetail").textContent = "D√©tail";
    lastCabinetsJson = null;

    const url = joinUrlParts(storedBaseApi, "v1/cabinets");

    try {
      const resp = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": storedUUID } });
      lastCabinetsCurl = resp.__acdCurl || "";
      const raw = await resp.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; } catch { data = raw; }

      if (!resp.ok) return;

      if (Array.isArray(data)) {
        lastCabinetsJson = data;
        $("sNbCabinets").textContent = String(data.length);

        $("cabinetsTbody").innerHTML = data.map(c => {
          const siret = c?.Siret ?? "";
          const ville = c?.Ville ?? "";
          return `
            <tr>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(c?.Code ?? ""))}</td>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(String(c?.Nom ?? ""))}</td>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border); font-family:ui-monospace,SFMono-Regular,Consolas,monospace;">${escapeHtml(String(siret))}</td>
              <td style="padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(String(ville))}</td>
            </tr>`;
        }).join("");
      }
    } catch {
      // silencieux
    }
  }

  function clearAll() {
    // Auth inputs
    $("urlInput").value = "";
      updateEnvBadge();
    // Effacer : vider URL + Ticket Zendesk + storage
    const urlInput = document.getElementById("urlInput");
    const ticketInput = document.getElementById("referenceInput");
    if (urlInput) urlInput.value = "";
    if (ticketInput) ticketInput.value = "";

    try {
      sessionStorage.removeItem("ACD_BASE_URL_SAISIE");
      sessionStorage.removeItem("acd_ticket_zendesk");
    } catch (e) {}
    try {
      localStorage.removeItem("ACD_BASE_URL_SAISIE");
      localStorage.removeItem("acd_ticket_zendesk");
    } catch (e) {}

    const btnTicket = document.getElementById("btnTicketZendesk");
    if (btnTicket) btnTicket.style.display = "none";


    // Effacer : d√©cocher "Chiffrer le mot de passe dans l'export JSON"
    const encryptCheckbox = document.getElementById("chkEncryptPwd");
    if (encryptCheckbox) {
      encryptCheckbox.checked = false;
      encryptCheckbox.disabled = false;
    }

    refreshGrandLivreButtons();
    if ($("urlInput2")) $("urlInput2").value = "";
    $("loginInput").value = "";
    $("pwdInput").value = "";
    $("uuidInput").value = "";
    $("dossierInput").value = "";

    // Session / globals
    storedUUID = "";
    storedBaseApi = "";
    storedTimeout = "";

    sessionStorage.removeItem("ACD_UUID");
    sessionStorage.removeItem("ACD_BASE_API");
    sessionStorage.removeItem("ACD_SESSION_TIMEOUT");

    // Reset API call history (console + in-memory)
    try { if (window.__acdApiLogs) window.__acdApiLogs.length = 0; } catch {}
    const pre = $("jsConsoleLog");
    if (pre) pre.textContent = "";
    const toggleBtn = $("jsConsoleToggleBtn");
    if (pre) pre.style.display = "none";
    if (toggleBtn) toggleBtn.textContent = "Afficher";

    // Reset GED fields
    const gj = $("gedJournalSelect");
    const ga = $("gedArboSelect");
    if (gj) gj.selectedIndex = 0;
    if (ga) ga.selectedIndex = 0;
    if ($("gedIdInput")) $("gedIdInput").value = "";
    if ($("gedDocsCountVal")) $("gedDocsCountVal").textContent = "0";
    if ($("gedRubriqueTbody")) $("gedRubriqueTbody").innerHTML = "";
    if ($("gedRubriqueDetail")) $("gedRubriqueDetail").classList.add("hidden");
    if ($("gedMsg")) $("gedMsg").textContent = "";
    const gBadge = $("gedStatusBadge");
    if (gBadge) { gBadge.classList.add("hidden"); gBadge.textContent = "OK"; }

    // Reset all computed outputs / tables
    resetOutputs();
    updateAuthUI();
  }

  function setMode(mode) {
    const isLogin = mode === "login";
    $("tabLogin").classList.toggle("active", isLogin);
    $("tabUuid").classList.toggle("active", !isLogin);
    $("panelLogin").classList.toggle("hidden", !isLogin);
    $("panelUuid").classList.toggle("hidden", isLogin);
  }

  function applyTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("ACD_THEME", theme);
    $("themeSwitch").setAttribute("aria-checked", theme === "dark" ? "true" : "false");
  }
  function toggleTheme() {
    const current = document.documentElement.getAttribute("data-theme") || "light";
    applyTheme(current === "dark" ? "light" : "dark");
  }

  $("tabLogin")?.addEventListener("click", () => setMode("login"));
  $("tabUuid")?.addEventListener("click", () => setMode("uuid"));

  $("btnAuth")?.addEventListener("click", authenticateWithLogin);
  $("quickApiBtn")?.addEventListener("click", async () => { $("loginInput").value = "API"; $("pwdInput").value = "api"; try { await authenticateWithLogin(); } catch (e) { jsConsoleLog("Erreur quick API", e?.message ? {message:e.message, stack:e.stack}: e); } });
  $("btnUseUuid")?.addEventListener("click", authenticateWithUuid);
  $("btnDossier")?.addEventListener("click", validateDossier);

  $("btnClear")?.addEventListener("click", clearAll);
  $("btnClear2")?.addEventListener("click", clearAll);
  $("copyUuidBtn")?.addEventListener("click", () => copyText(storedUUID || $("sUuid").textContent || "", $("sessionStatus")));

  $("copyDossierBtn")?.addEventListener("click", async () => {
    const code = ($("sDossierEnCours")?.textContent || "").trim();
    const inp =
      $("dossierInput") ||
      $("codeDossierInput") ||
      $("codeDossier") ||
      $("dossierInput") ||
      document.querySelector('input[name="codeDossier"]') ||
      document.querySelector('input[placeholder*="dossier" i]');

    if (inp) inp.value = code;

    // Si pas de code -> rien √† faire
    if (!code) {
      setStatus($("dossierStatus"), "Aucun dossier en cours.", "warn");
      return;
    }

    // Valider automatiquement le dossier
    try {
      await validateDossier();
    } catch (e) {
      jsConsoleLog("Erreur auto-validation dossier", e && e.message ? { message: e.message, stack: e.stack } : e);
    }
  });

  

  $("btnComptesGenerauxDetail")?.addEventListener("click", () => {
    const wrap = $("comptesGenerauxWrap");
    const hidden = wrap.classList.contains("hidden");
    wrap.classList.toggle("hidden", !hidden);
    $("btnComptesGenerauxDetail").textContent = hidden ? "Masquer" : "D√©tail";
  });

  $("btnComptesClientsDetail")?.addEventListener("click", () => {
    const wrap = $("comptesClientsWrap");
    const hidden = wrap.classList.contains("hidden");
    wrap.classList.toggle("hidden", !hidden);
    $("btnComptesClientsDetail").textContent = hidden ? "Masquer" : "D√©tail";
  });

  $("btnComptesFournisseursDetail")?.addEventListener("click", () => {
    const wrap = $("comptesFournisseursWrap");
    const hidden = wrap.classList.contains("hidden");
    wrap.classList.toggle("hidden", !hidden);
    $("btnComptesFournisseursDetail").textContent = hidden ? "Masquer" : "D√©tail";
  });



  $("btnSwagger")?.addEventListener("click", () => {
    if (!storedBaseApi) return;
    const url = storedBaseApi.replace(/\/+$/, "") + "/swagger";
    window.open(url, "_blank");
  });


  $("btnTestComptaWeb")?.addEventListener("click", () => {
    if (!storedBaseApi) {
      alert("BaseApi non d√©finie. Connectez-vous d'abord.");
      return;
    }

    let cab = (sessionStorage.getItem("ACD_CODE_CABINET") || "").trim();
    if (!cab) {
      const el = document.querySelector("[data-cabinet-code]") || document.getElementById("sCabinetAffectation") || document.getElementById("cabinetAffectation") || document.getElementById("vCabinetAffectation");
      if (el && el.textContent) cab = String(el.textContent).trim();
      if (cab) { try { sessionStorage.setItem("ACD_CODE_CABINET", cab); } catch(e) {} }
    }
    if (!cab) {
      alert("CodeCabinet non d√©fini. Validez la connexion.");
      return;
    }

    const siteRoot = String(storedBaseApi).replace(/\/?api\/?$/i, "");
    const url = siteRoot.replace(/\/+$/, "") +
      "/Comptabilite/ServiceAcdProd.svc/ServiceWindowsAccessible?CAB=" + encodeURIComponent(cab);

    window.open(url, "_blank");
  });

  $("btnTicketZendesk")?.addEventListener("click", () => {
    const t = (document.getElementById("referenceInput")?.value || "").trim();
    if (!t) return;
    if (!/^\d+$/.test(t)) { alert("Ticket Zendesk invalide : il doit √™tre uniquement num√©rique."); return; }
    const url = "https://acd1581.zendesk.com/agent/tickets/" + encodeURIComponent(t);
    window.open(url, "_blank", "noopener,noreferrer");
  });

  // --- Ticket Zendesk: numeric-only + show/hide link button (robust, even if other init changes)
  (function setupTicketZendeskUI(){
    const input = document.getElementById("referenceInput");
    const btn = document.getElementById("btnTicketZendesk");
    if (!input || !btn) return;

    const sanitize = (v) => String(v || "").replace(/\D+/g, "");
    const refresh = () => {
      const t = sanitize(input.value).trim();
      btn.style.display = t ? "inline-flex" : "none";
    };

    // Force numeric-only while typing/pasting
    const onInput = () => {
      const before = input.value || "";
      const after = sanitize(before);
      if (before !== after) input.value = after;
      try { sessionStorage.setItem("acd_ticket_zendesk", after); } catch(e) {}
      refresh();
    };

    // Restore saved ticket (if any)
    try {
      const saved = sessionStorage.getItem("acd_ticket_zendesk") || "";
      if (saved) input.value = sanitize(saved);
    } catch(e) {}

    input.addEventListener("input", onInput);
    input.addEventListener("change", onInput);
    refresh();
  })();
$("btnJournauxDetail")?.addEventListener("click", () => {
    const wrap = $("journauxTableWrap");
    const hidden = wrap.classList.contains("hidden");
    wrap.classList.toggle("hidden", !hidden);
    $("btnJournauxDetail").textContent = hidden ? "Masquer" : "D√©tail";
  });

  $("btnExercicesDetail")?.addEventListener("click", () => {
    const wrap = $("exercicesTableWrap");
    const hidden = wrap.classList.contains("hidden");
    wrap.classList.toggle("hidden", !hidden);
    $("btnExercicesDetail").textContent = hidden ? "Masquer" : "D√©tail";
  });



  $("themeSwitch")?.addEventListener("click", toggleTheme);
  $("themeSwitch").addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleTheme(); }
  });

  
  // Boutons JSON (ouverture nouvelle fen√™tre)
  $("btnExercicesJson")?.addEventListener("click", () => openJsonWindow("GET /v1/compta/exercices", lastExercicesJson));
  $("btnJournauxJson")?.addEventListener("click", () => openJsonWindow("GET /v1/compta/journaux", lastJournauxJson, "", "", lastJournauxCurl));
  $("btnComptesGenerauxJson")?.addEventListener("click", () => openJsonWindow("GET /v1/compta/comptes/generaux", lastComptesGenerauxJson));
  $("btnComptesClientsJson")?.addEventListener("click", () => openJsonWindow("GET /v1/compta/comptes/clients", lastComptesClientsJson));
  $("btnComptesFournisseursJson")?.addEventListener("click", () => openJsonWindow("GET /v1/compta/comptes/fournisseurs", lastComptesFournisseursJson));

  // Boutons CSV
  $("btnCabinetsCsv")?.addEventListener("click", () => {
    const fn = makeExportFilename("Cabinets_visibles", "csv", window.lastGeneratedCurl);
    downloadCsvFile(lastCabinetsJson || [], fn);
  });

  $("codesTvaCsvBtn")?.addEventListener("click", () => {
    const fn = makeExportFilename("Codes_TVA", "csv");
    downloadCsvFile(lastCodesTvaJson || [], fn);
  });

  $("anaSectionsCsvBtn")?.addEventListener("click", () => {
    const fn = makeExportFilename("Sections_Analytiques", "csv");
    downloadCsvFile(lastAnaSectionsJson || [], fn);
  });

  // Gestion des quantit√©s - Param√®tres quantit√©s
  $("qteDetailBtn")?.addEventListener("click", () => toggleQteTable());
  $("qteJsonBtn")?.addEventListener("click", () => openJsonWindow("GET /v1/compta/param√®tres/quantite", lastQteParamsJson));
  $("qteCsvBtn")?.addEventListener("click", () => {
    const fn = makeExportFilename("csv", "quantites", window.lastGeneratedCurl);
    downloadCsvFile(lastQteParamsJson || [], fn);
  });


  $("btnJournauxCsv")?.addEventListener("click", () => {
    const fn = makeExportFilename("Journaux", "csv");
    downloadCsvFile(lastJournauxJson || [], fn);
  });

  $("btnComptesGenerauxCsv")?.addEventListener("click", () => {
    const fn = makeExportFilename("Comptes_Generaux", "csv");
    downloadCsvFile(lastComptesGenerauxJson || [], fn);
  });

  $("btnComptesClientsCsv")?.addEventListener("click", () => {
    const fn = makeExportFilename("Comptes_Clients", "csv");
    downloadCsvFile(lastComptesClientsJson || [], fn);
  });

  $("btnComptesFournisseursCsv")?.addEventListener("click", () => {
    const fn = makeExportFilename("Comptes_Fournisseurs", "csv");
    downloadCsvFile(lastComptesFournisseursJson || [], fn);
  });

// Donn√©es comptable
  $("btnCalculerBalance")?.addEventListener("click", async () => { await fetchBalanceGeneraux(); await fetchAllGrandLivres(); });

  $("btnBalanceDetail")?.addEventListener("click", () => {
    const wrap = $("balanceTableWrap");
    const hidden = wrap.classList.contains("hidden");
    wrap.classList.toggle("hidden", !hidden);
    $("btnBalanceDetail").textContent = hidden ? "Masquer" : "D√©tail";
  });

  $("btnBalanceJson")?.addEventListener("click", () => openJsonWindow("POST /v1/compta/balance/generaux", lastBalanceJson, "", "", lastBalanceCurl));


  // Grand livre : exports
  $("btnGLGenerauxCsv")?.addEventListener("click", () => {
    const fn = makeExportFilename("GrandLivre_Generaux", "csv", window.lastGeneratedCurl);
    downloadCsvFile(lastGrandLivreGenerauxJson || [], fn);
  });
  $("btnGLGenerauxJson")?.addEventListener("click", () => openJsonWindow("POST /v1/compta/grandlivre/generaux", lastGrandLivreGenerauxJson));

  $("btnGLClientsCsv")?.addEventListener("click", () => {
    const fn = makeExportFilename("GrandLivre_Clients", "csv", window.lastGeneratedCurl);
    downloadCsvFile(lastGrandLivreClientsJson || [], fn);
  });
  $("btnGLClientsJson")?.addEventListener("click", () => openJsonWindow("POST /v1/compta/grandlivre/clients", lastGrandLivreClientsJson));

  $("btnGLFournisseursCsv")?.addEventListener("click", () => {
    const fn = makeExportFilename("GrandLivre_Fournisseurs", "csv", window.lastGeneratedCurl);
    downloadCsvFile(lastGrandLivreFournisseursJson || [], fn);
  });
  $("btnGLFournisseursJson")?.addEventListener("click", () => openJsonWindow("POST /v1/compta/grandlivre/fournisseurs", lastGrandLivreFournisseursJson));

  

  // Session : S√©curit√©s
  $("btnSecuritesDetail")?.addEventListener("click", () => {
    const wrap = $("securitesTableWrap");
    const hidden = wrap.classList.contains("hidden");
    wrap.classList.toggle("hidden", !hidden, window.lastGeneratedCurl);
    $("btnSecuritesDetail").textContent = hidden ? "Masquer" : "D√©tail";
  });
  $("btnSecuritesJson")?.addEventListener("click", () => openJsonWindow("GET /v1/collaborateurs/{Identifiant}", lastSecuritesJson, "", "", lastSecuritesCurl));


  // Session : Dossiers / Cabinets
  $("btnDossiersDetail")?.addEventListener("click", () => {
    const wrap = $("dossiersTableWrap");
    const hidden = wrap.classList.contains("hidden");
    wrap.classList.toggle("hidden", !hidden, window.lastGeneratedCurl);
    $("btnDossiersDetail").textContent = hidden ? "Masquer" : "D√©tail";
  });
  $("btnDossiersJson")?.addEventListener("click", () => openJsonWindow("GET /v1/dossiers", lastDossiersJson, "", "", lastDossiersVisiblesCurl));

  
  $("btnDossiersCsv")?.addEventListener("click", () => {
    try{
      if(!lastDossiersJson){
        alert("Aucun dossier √† exporter (faites d‚Äôabord une connexion).");
        return;
      }

      const asArray = normalizeRowsForCsv(lastDossiersJson);

      const mapped = asArray.map(d => {
        const titreCode = d?.Titre?.Code ?? d?.TitreCode ?? "";
        const genreCode = d?.Genre?.Code ?? d?.GenreCode ?? "";
        const societeCode = d?.Socie?.Code ?? d?.Societe?.Code ?? d?.SocieteCode ?? "";

        const adrFact =
          d?.AdresseFacturation ??
          d?.AdresseDeFacturation ??
          d?.AdresseFacturationTiers ??
          d?.Facturation?.Adresse ??
          d?.Adresses?.Facturation ??
          null;

        const activiteLib = d?.Activite?.Libelle ?? d?.ActiviteLibelle ?? "";

        const coll =
          Array.isArray(d?.Collaborateurs) ? d.Collaborateurs.length :
          Array.isArray(d?.Collaborateur) ? d.Collaborateur.length :
          (typeof d?.NbCollaborateurs === "number" ? d.NbCollaborateurs :
           typeof d?.NombreCollaborateurs === "number" ? d.NombreCollaborateurs :
           typeof d?.CollaborateursCount === "number" ? d.CollaborateursCount :
           "");

        return {
          Id: d?.Id ?? d?.DossierId ?? "",
          Code: d?.Code ?? d?.CodeDossier ?? "",
          SIRET: d?.SIRET ?? d?.Siret ?? "",
          Titre: String(titreCode ?? ""),
          Nom: d?.Nom ?? d?.RaisonSociale ?? "",
          Societe: String(societeCode ?? ""),
          Genre: String(genreCode ?? ""),
          Activite: String(activiteLib ?? ""),
          AdresseFacturation: adrFact ? "Vrai" : "Faux",
          CodeCompta: d?.CodeCompta ?? "",
          CodePaie: d?.CodePaie ?? ""
        };
      });

      const filename = (typeof makeExportFilename === "function")
        ? makeExportFilename("dossiers_visibles","csv")
        : ("dossiers_visibles_" + Date.now() + ".csv");

      downloadCsvFile(mapped, filename);
    }catch(e){
      console.error(e);
      alert("Erreur export CSV : " + (e && e.message ? e.message : e));
    }
  });
  $("btnCabinetsDetail")?.addEventListener("click", () => {
    const wrap = $("cabinetsTableWrap");
    const hidden = wrap.classList.contains("hidden");
    wrap.classList.toggle("hidden", !hidden);
    $("btnCabinetsDetail").textContent = hidden ? "Masquer" : "D√©tail";
  });
  $("btnCabinetsJson")?.addEventListener("click", () => openJsonWindow("GET /v1/cabinets", lastCabinetsJson, null, null, lastCabinetsCurl));

  
  $("btnDownloadFec")?.addEventListener("click", () => downloadFec());

  $("btnComptaDossierJson")?.addEventListener("click", () => openJsonWindow("GET /v1/compta/dossier", lastComptaDossierConfigJson));

  


  
  function showPortalBadge(kind, text) {
    const b = $("uuidPortalBadge");
    if (!b) return;
    b.textContent = text || (kind === "ok" ? "OK" : "NO");
    b.classList.remove("hidden", "ok","err", window.lastGeneratedCurl);
    b.classList.add(kind === "ok" ? "ok" : "err");
    window.clearTimeout(b._t);
    b._t = window.setTimeout(() => {
      b.classList.add("hidden");
      b.classList.remove("ok","err");
    }, 2500);
  }


  
  function buildUserVariablesJson() {
    // Valeurs saisies / calcul√©es (export)
    const getTxt = (id) => (document.getElementById(id)?.textContent || "").trim();
    const url = (document.getElementById("urlInput")?.value || "").trim();
    const login = (document.getElementById("loginInput")?.value || "").trim();
    const pwd = (document.getElementById("pwdInput")?.value || "").trim();
    const dossierCode = (document.getElementById("dossierInput")?.value || "").trim() || (typeof selectedDossierCode === "string" ? selectedDossierCode : "");
    const exSel = document.getElementById("selectExercice");
    const exLabel = exSel && exSel.selectedOptions && exSel.selectedOptions[0] ? exSel.selectedOptions[0].textContent.trim() : "";

    

    // Export timestamps (local + ISO)
    const __now = new Date();
    const exportedAtISO = __now.toISOString();
    const pad2 = (n) => String(n).padStart(2, "0");
    const exportedAt = `${__now.getFullYear()}-${pad2(__now.getMonth()+1)}-${pad2(__now.getDate())}T${pad2(__now.getHours())}:${pad2(__now.getMinutes())}:${pad2(__now.getSeconds())}`;
const infos = (lastApiInformationsJson && typeof lastApiInformationsJson === "object") ? lastApiInformationsJson : {};
    const comptaDossier = (lastComptaDossierConfigJson && typeof lastComptaDossierConfigJson === "object") ? lastComptaDossierConfigJson : null;

    // Auth: priorit√© aux objets en m√©moire, sinon fallback DOM
    const authObj = (lastUuidAuthJson || lastAuthJson || null);

    const payload = {
      
      Meta: {
        Version: (document.querySelector("header")?.innerText.match(/V[0-9._-]+/) || [""])[0],
        ExportedAt: exportedAt,
        ExportedAtISO: exportedAtISO,
        CodeAgent: (document.getElementById("agentCodeInput")?.value || "").trim(),
        TicketZendesk: (document.getElementById("referenceInput")?.value || "").trim(),
        CodeCabinet: (document.getElementById("cabinetCodeInput")?.value || "").trim(),
        Commentaire: (() => {
          const v = (document.getElementById("commentaireInput")?.value || "").trim();
          return v ? v : undefined;
        })()
      },
Identification: {
        URL: (typeof storedBaseApi === "string" ? storedBaseApi : ""),
        Identifiant: authObj?.Identite?.Code || getTxt("sCode"),
        MotDePasse: (getEnvironmentFromUrl(url) === "LOCAL") ? pwd : true,
        CodeDossier: dossierCode,
      },
      
      Session: {
        VersionInstallee: infos?.VersioniSuiteInstallee || "",
        VersionDisponible: infos?.VersioniSuiteDisponible || "",
        UUID: (typeof storedUUID === "string" ? storedUUID : ""),
        TypeConnexion: authObj?.Identite?.Type || getTxt("sType"),
        Nom: authObj?.Identite?.Nom || getTxt("sNom"),
        Prenom: authObj?.Identite?.Prenom || getTxt("sPrenom"),
        DureeSession: (typeof storedTimeout === "string" && storedTimeout) ? storedTimeout : getTxt("sTimeout"),
NbSecurites: (() => { try { const v = $("sNbSecurites")?.textContent || ""; return /^\d+$/.test(v.trim()) ? Number(v.trim()) : null; } catch { return null; } })(),
        Securites: (lastSecuritesJson && typeof lastSecuritesJson === "object") ? (lastSecuritesJson.Securites ?? lastSecuritesJson.SecuritesFonctionnelles ?? null) : null,
      },
DonneesComptables: {
        ExerciceSelectionne: exLabel,
    ComptaDossier: (lastComptaDossierJson ?? null)
      }
      ,
      GED: (() => {
        try {
          const jSel = document.getElementById("gedJournalSelect");
          const jCode = jSel && jSel.value ? String(jSel.value) : "";
          const jLib = (jSel && jSel.selectedOptions && jSel.selectedOptions[0]) ? String(jSel.selectedOptions[0].textContent || "").trim() : "";

          const aSel = document.getElementById("gedArboSelect");
          const aId = aSel && aSel.value ? String(aSel.value) : "";
          const aLib = (aSel && aSel.selectedOptions && aSel.selectedOptions[0]) ? String(aSel.selectedOptions[0].textContent || "").trim() : "";

          const idGed = (document.getElementById("gedIdInput")?.value || "").trim();
          const docsTxt = (document.getElementById("gedDocsCountVal")?.textContent || "").trim();
          const docsCount = /^\d+$/.test(docsTxt) ? Number(docsTxt) : null;

          const planRaw = (typeof lastGedPlanJson !== "undefined") ? lastGedPlanJson : null;
          const filtreRaw = (typeof lastGedFilterJson !== "undefined") ? lastGedFilterJson : null;

          return {
IdGed: idGed || null,
            PlanClassementEcriture: planRaw !== null ? { Raw: planRaw, Value: (typeof parseMaybeJson === "function" ? parseMaybeJson(planRaw) : planRaw) } : null,
NombreDocuments: docsCount,
            RubriqueDetail: (typeof lastGedRubriqueNode !== "undefined") ? (lastGedRubriqueNode ?? null) : null
          };
        } catch (e) {
          return { ErreurJS: String(e && e.message ? e.message : e) };
        }
      })()

    };
    return payload;
    }

  
// ===========================
// Crypto helpers (WebCrypto)
// AES-GCM + PBKDF2(SHA-256)
// ===========================
const _te = new TextEncoder();

function _b64Normalize(b64){
  // Support base64url + missing padding
  let s = String(b64 || "").trim().replace(/-/g, "+").replace(/_/g, "/");
  const pad = s.length % 4;
  if (pad) s += "=".repeat(4 - pad);
  return s;
}

function _b64FromBytes(bytes){
  let bin = "";
  const chunk = 0x8000;
  for (let i = 0; i < bytes.length; i += chunk) {
    bin += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
  }
  return btoa(bin);
}

function _bytesFromB64(b64){
  const bin = atob(_b64Normalize(b64));
  const bytes = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
  return bytes;
}

async function encryptStringAesGcm(plaintext, passphrase, iter){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const it = (typeof iter === "number" && iter >= 10000) ? iter : 150000;

  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    _te.encode(String(passphrase)),
    "PBKDF2",
    false,
    ["deriveKey"]
  );

  const key = await crypto.subtle.deriveKey(
    { name: "PBKDF2", salt, iterations: it, hash: "SHA-256" },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt"]
  );

  const ctBuf = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv },
    key,
    _te.encode(String(plaintext))
  );

  return {
    ciphertextB64: _b64FromBytes(new Uint8Array(ctBuf)),
    saltB64: _b64FromBytes(salt),
    ivB64: _b64FromBytes(iv),
    iter: it
  };
}

async function decryptStringAesGcm(ciphertextB64, passphrase, saltB64, ivB64, iter){
  const salt = _bytesFromB64(saltB64);
  const iv = _bytesFromB64(ivB64);
  const it = (typeof iter === "number" && iter >= 10000) ? iter : 150000;

  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    _te.encode(String(passphrase)),
    "PBKDF2",
    false,
    ["deriveKey"]
  );

  const key = await crypto.subtle.deriveKey(
    { name: "PBKDF2", salt, iterations: it, hash: "SHA-256" },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    false,
    ["decrypt"]
  );

  const ct = _bytesFromB64(ciphertextB64);
  const ptBuf = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv },
    key,
    ct
  );

  return new TextDecoder().decode(ptBuf);
}


function onCopyVarsJson() {
    (async () => {
      try {
        const agent = (document.getElementById("agentCodeInput")?.value || "").trim();
        if(!agent){
          alert("Veuillez renseigner le Code Agent (obligatoire) avant d‚Äôouvrir l‚Äôexport JSON.");
          document.getElementById("agentCodeInput")?.focus();
          return;
        }

        await fetchComptaDossierForExport();
        const payload = buildUserVariablesJson();

        // Horodatage local coh√©rent avec l'intitul√© de la fen√™tre
        const now = new Date();
        const generatedAt = formatLocalDateTime(now);
        payload.ExportedAt = generatedAt;
        payload.ExportedAtISO = now.toISOString();

        const filename = buildExportJsonFilename(payload, now);
        // Export JSON : ouverture dans une nouvelle fen√™tre (le t√©l√©chargement se fait via le bouton Enregistrer)
        
        // Option A : chiffrement du mot de passe dans l'export JSON (AES-GCM + PBKDF2)
// - CLIENT : obligatoire (case coch√©e + d√©sactiv√©e)
// - LOCAL  : optionnel
try{
  const chk = document.getElementById("chkEncryptPwd");
  const shouldEncrypt = !!(chk && chk.checked);

  if(shouldEncrypt){
    if(!window.crypto || !crypto.subtle){
      alert("WebCrypto n'est pas disponible : impossible de chiffrer le mot de passe.");
      return;
    }

    // On chiffre le mot de passe r√©ellement saisi dans le champ (et pas le bool√©en export√© c√¥t√© CLIENT)
    const plainPwd = (typeof getVal === "function" ? (getVal("pwdInput") || "") : (document.getElementById("pwdInput")?.value || "")).trim();
    if(!plainPwd){
      alert("Export annul√© : le mot de passe n'est pas renseign√©.");
      document.getElementById("pwdInput")?.focus();
      return;
    }

    const passphrase = prompt("D√©finir une passphrase (√† conserver pour r√©importer ‚Äî ce n‚Äôest pas le mot de passe API) :");
    if(!passphrase){
      alert("Export annul√© : passphrase non renseign√©e.");
      return;
    }

    const ident = payload?.Identification;
    if(ident){
      const enc = await encryptStringAesGcm(plainPwd, passphrase, 150000);
      // On remplace MotDePasse (quel que soit son √©tat) par MotDePasseChiffre
      delete ident.MotDePasse;
      ident.MotDePasseChiffre = enc.ciphertextB64;
      ident.Crypto = { Alg: "AES-GCM", Kdf: "PBKDF2-SHA256", Salt: enc.saltB64, IV: enc.ivB64, Iter: enc.iter };
    }
  }
}catch(e){
  console.error(e);
  alert("Erreur lors du chiffrement du mot de passe pour l'export JSON.");
  return;
}

openJsonWindow("Export JSON", payload, generatedAt, filename, window.lastGeneratedCurl);
} catch (e) {
        jsConsoleLog("Erreur export JSON", e?.message ? { message: e.message, stack: e.stack } : e);
        alert("Erreur export JSON");
      }
    })();  }





function initSidebarLinks(){
  const btnSwagger = document.getElementById("btnSwaggerSidebar");
  const btnZendesk = document.getElementById("btnZendeskSidebar");
  const refInput = document.getElementById("referenceInput");

  const getUuid = () => {
    try{
      const u1 = (typeof storedUUID !== "undefined" && storedUUID) ? String(storedUUID).trim() : "";
      if (u1) return u1;
      const u2 = ($("uuidValue")?.textContent || "").trim();
      if (u2) return u2;
      return (sessionStorage.getItem("ACD_UUID") || "").trim();
    }catch(e){
      return (sessionStorage.getItem("ACD_UUID") || "").trim();
    }
  };

  const getBaseSaisie = () => (document.getElementById("urlInput")?.value || document.getElementById("urlSaisie")?.value || "").trim();

  const getBaseApi = () => {
    // 1) stockage (si l'app l'alimente)
    const s = (sessionStorage.getItem("ACD_BASE_API") || "").trim();
    if (s) return s.replace(/\/+$/,"");
    // 2) variables globales
    try{
      const b1 = (typeof storedBaseApi !== "undefined" && storedBaseApi) ? String(storedBaseApi).trim() : "";
      if (b1) return b1.replace(/\/+$/,"");
      const b2 = (typeof baseApi !== "undefined" && baseApi) ? String(baseApi).trim() : "";
      if (b2) return b2.replace(/\/+$/,"");
    }catch(e){}
    // 3) fallback sur URL saisie
    const bSaisie = getBaseSaisie();
    return bSaisie ? (bSaisie.replace(/\/+$/,"") + "/api") : "";
  };

  function refreshQuickLinks(){
    const uuid = getUuid();
    if (btnSwagger) btnSwagger.style.display = uuid ? "block" : "none";

    const ticket = (refInput?.value || "").trim();
    if (btnZendesk) btnZendesk.style.display = ticket ? "block" : "none";
  }
  window.refreshQuickLinks = refreshQuickLinks;

  // Timer l√©ger (√©vite d'avoir √† recharger) - ne cr√©e qu'un seul interval
  if (!window.__acdkQuickLinksTimer){
    window.__acdkQuickLinksTimer = setInterval(refreshQuickLinks, 500);
  }

  if (refInput){
    if (!refInput.dataset.quickLinksBound){
      refInput.dataset.quickLinksBound = "1";
      refInput.addEventListener("input", refreshQuickLinks);
      refInput.addEventListener("change", refreshQuickLinks);
    }
  }

  // Bind click handlers ONCE to avoid multiple window.open => popups blocked
  if (btnSwagger && !btnSwagger.dataset.quickLinksBound){
    btnSwagger.dataset.quickLinksBound = "1";
    btnSwagger.addEventListener("click", () => {
      const uuid = getUuid();
      if (!uuid){
        alert("UUID non d√©fini. Connectez-vous d'abord.");
        return;
      }
      const baseApi = getBaseApi();
      if (!baseApi){
        alert("URL Swagger non disponible.");
        return;
      }
      const url = baseApi.replace(/\/+$/,"") + "/swagger";
      const w = window.open(url, "_blank", "noopener,noreferrer");
      if(!w){/* popup blocked */}
    });
  }

  if (btnZendesk && !btnZendesk.dataset.quickLinksBound){
    btnZendesk.dataset.quickLinksBound = "1";
    btnZendesk.addEventListener("click", () => {
      const t = (refInput?.value || "").trim();
      if (!t){
        alert("URL Ticket Zendesk non disponible.");
        return;
      }
      const url = "https://acd1581.zendesk.com/agent/tickets/" + encodeURIComponent(t);
      const w = window.open(url, "_blank", "noopener,noreferrer");
      if(!w){/* popup blocked */}
    });
  }

  refreshQuickLinks();
}

function init() {

    
  try{ initSidebarLinks(); }catch(e){}
// Environnement (badge)
    updateEnvBadge();
    refreshGrandLivreButtons();
    $("urlInput")?.addEventListener("input", updateEnvBadge);
    $("urlInput")?.addEventListener("change", updateEnvBadge);

    // Historique des appels API : masqu√© par d√©faut
    try {
      const pre = $("jsConsoleLog");
      const btn = $("jsConsoleToggleBtn");
      if (pre) pre.style.display = "none";
      if (btn) btn.textContent = "Afficher";
    } catch (e) {}


    $("selectExercice")?.addEventListener("change", () => {
      try {
        const idx = $("selectExercice").selectedIndex;
        if (Array.isArray(lastExercicesJson) && idx >= 0) {
          // options may include a placeholder; try match by dataset if present
          const opt = $("selectExercice").options[idx];
          const dd = opt?.getAttribute("data-datedebut");
          const df = opt?.getAttribute("data-datefin");
          const courant = opt?.getAttribute("data-courant");
          if (dd && df) {
            selectedExerciceObj = { DateDebut: dd, DateFin: df, Courant: courant === "1" ? 1 : 0 };
          } else {
            // fallback: find by text
            selectedExerciceObj = lastExercicesJson[idx] || null;
          }
        }
      } catch (e) { jsConsoleLog?.("Erreur change exerciceSelect", e); }
    });
    $("btnCopyVarsHeader")?.addEventListener("click", onCopyVarsJson);
$("btnCopyVars")?.addEventListener("click", onCopyVarsJson);
    // Import JSON (restauration des champs principaux)
    (function initImportJson(){
      const btn = $("btnImportVarsHeader");
      const fileInput = $("importJsonFile");
      const modal = $("importJsonModal");
      const btnClose = $("btnImportJsonClose");
      const btnChooseFile = $("btnImportJsonChooseFile");
      const btnPasteToggle = $("btnImportJsonPasteToggle");
      const pasteZone = $("importJsonPasteZone");
      const ta = $("importJsonTextarea");
      const btnFromText = $("btnImportJsonFromText");
      const btnClearText = $("btnImportJsonClearText");

      function openModal(){
        if (!modal) return;
        modal.setAttribute("aria-hidden","false");
        // reset paste zone by default (choice first)
        if (pasteZone) pasteZone.style.display = "none";
      }
      function closeModal(){
        if (!modal) return;
        modal.setAttribute("aria-hidden","true");
      }

      async function applyImportFromData(data){



        // Commentaire (Meta.Commentaire) - optionnel
        try{
          const commentaire = (data?.Meta?.Commentaire ?? data?.Meta?.commentaire ?? "");
          const elC = document.getElementById("commentaireInput");
          if(elC){
            elC.value = (typeof commentaire === "string") ? commentaire : "";
          }
        }catch(e){}
// ---------- Compat import JSON (Identification v2 + legacy v1) ----------
            const _ident = data?.Identification || {};
            const _base = data?.Base || {};
            const _session = data?.Session || {};

            const _baseApi = (_ident.URL ?? _ident.BaseApi ?? _base.BaseApi ?? "");
            const _idConnexion = (_ident.Identifiant ?? _ident.IdConnexion ?? _session.IdConnexion ?? "");
            
            let _motDePasse = (_ident.MotDePasse ?? _session.MotDePasse);

            // Option A : d√©chiffrement si MotDePasseChiffre est pr√©sent
            try{
              if(_ident?.MotDePasseChiffre){
                if(!window.crypto || !crypto.subtle){
                  alert("WebCrypto n'est pas disponible : impossible de d√©chiffrer le mot de passe.");
                }else{
                  const passphrase = prompt("Passphrase utilis√©e √† l‚Äôexport (ce n‚Äôest pas le mot de passe API) :");
                  if(passphrase){
                    const cm = _ident.Crypto || {};
                    const saltB64 = cm.Salt;
                    const ivB64 = cm.IV;
                    const iter = cm.Iter || 150000;
                    if(saltB64 && ivB64){
                      _motDePasse = await decryptStringAesGcm(_ident.MotDePasseChiffre, passphrase, saltB64, ivB64, iter);
                    }else{
                      alert("Mot de passe chiffr√© d√©tect√©, mais m√©tadonn√©es Crypto manquantes (Salt/IV).");
                    }
                  }else{
                    alert("Mot de passe non import√© : passphrase non renseign√©e.");
                    _motDePasse = "";
                  }
                }
              }
            }catch(e){
              console.error(e);
              alert("Erreur lors du d√©chiffrement du mot de passe √† l'import JSON.");
              _motDePasse = "";
            }

const setVal = (id, v) => {
              const el = $(id);
              if (!el) return;
              el.value = (v === null || v === undefined) ? "" : String(v);
              el.dispatchEvent(new Event("input", { bubbles: true }));
              el.dispatchEvent(new Event("change", { bubbles: true }));
            };
            const setText = (id, v) => {
              const el = $(id);
              if (!el) return;
              el.textContent = (v === null || v === undefined || v === "") ? "‚Äî" : String(v);
            };

            // Mapping demand√©
            const urlSaisie = _baseApi || "";
            const idConnexion = _idConnexion ?? "";
            const codeDossier = (_ident.CodeDossier ?? data?.Dossier?.CodeDossier ?? data?.Session?.DossierEnCours ?? "").trim();
            const metaTicketZendesk = (data?.Meta?.TicketZendesk ?? "").trim();
            setVal("referenceInput", metaTicketZendesk);
            const metaCodeCabinet = (data?.Meta?.CodeCabinet ?? "").trim();
            setVal("cabinetCodeInput", metaCodeCabinet);

            try { sessionStorage.setItem("acd_ticket_zendesk", metaTicketZendesk); } catch(e) {}

            setVal("urlInput", urlSaisie);
            
            
            try { if (typeof updateEnvBadge === "function") updateEnvBadge(); } catch(e) {}
// Recalcul automatique de l‚Äôenvironnement (LOCAL / CLIENT)
            try { if (typeof updateEnvBadge === "function") updateEnvBadge(); } catch(e) {}
setVal("loginInput", _idConnexion);
            setVal("dossierInput", codeDossier);

            // Mot de passe (si fourni dans le JSON)
            const motDePasse = _motDePasse;
            if (motDePasse !== undefined && motDePasse !== null && String(motDePasse) !== "") {
              if (typeof _motDePasse === "string") setVal("pwdInput", _motDePasse);
            }
            
            const btnDossier = $("btnDossier");
            if (btnDossier) btnDossier.disabled = !codeDossier;

            // Bonus coh√©rent (non demand√© mais utile)
            const uuid = data?.Session?.UUID ?? "";
            if (uuid) setVal("uuidInput", uuid);

            // Restauration d'affichages session si pr√©sents
            const vInst = data?.Session?.VersionInstallee ?? "";
            const vDisp = data?.Session?.VersionDisponible ?? "";
            if (vInst || vDisp) setText("sISuiteVersion", [vInst, vDisp].filter(Boolean).join(" / "));

            setText("sUuid", uuid || "‚Äî");
            setText("sType", data?.Session?.TypeConnexion ?? "‚Äî");
            setText("sCode", idConnexion || "‚Äî");
            setText("sNom", data?.Session?.Nom ?? "‚Äî");
            setText("sPrenom", data?.Session?.Prenom ?? "‚Äî");
            setText("sTimeout", data?.Session?.DureeSession ?? "‚Äî");
            setText("sDossierEnCours", data?.Session?.DossierEnCours ?? codeDossier ?? "‚Äî");

            // S√©curit√©s (m√©moire + compteur)
            try {
              lastSecuritesJson = Array.isArray(data?.Session?.Securites) ? data.Session.Securites : [];
              setText("sNbSecurites", (data?.Session?.NbSecurites ?? lastSecuritesJson.length ?? 0));
            } catch(e) {}

            // Donn√©es comptables (pour Export JSON)
            try {
              const cd = data?.DonneesComptables?.ComptaDossier ?? null;
              if (cd) {
                lastComptaDossierJson = cd;
                lastComptaDossierConfigJson = cd;
              }
              const exSel = data?.DonneesComptables?.ExerciceSelectionne ?? "";
              if (exSel) {
                // essaye de s√©lectionner l'exercice par libell√©
                const sel = $("exerciceSelect");
                if (sel) {
                  const opt = Array.from(sel.options || []).find(o => (o.textContent || "").trim() === String(exSel).trim());
                  if (opt) { sel.value = opt.value; sel.dispatchEvent(new Event("change", { bubbles: true })); }
                }
              }
            } catch(e) {}

            // Affiche la section post-auth si elle existe
            try {
              $("afterAuth")?.classList?.remove("hidden");
              // ne force pas une "connexion", mais permet de continuer le test
              $("btnDossier") && ($("btnDossier").disabled = false);
            } catch(e) {}

            
            // Si Identifiant + Mot de passe sont pr√©sents, valider automatiquement la connexion
            try {
              const _loginNow = ($("loginInput")?.value || "").trim();
              const _pwdNow = ($("pwdInput")?.value || "");
              const _urlNow = ($("urlInput")?.value || "").trim();
              if (_urlNow && _loginNow && _pwdNow && typeof authenticateWithLogin === "function") {
                await authenticateWithLogin();
              }
            } catch(e) {
              // Ne bloque pas l'import si l'auth √©choue
            }

            if (typeof jsConsoleLog === 'function') jsConsoleLog(`Import JSON: URL=${urlSaisie || "‚Äî"} | Identifiant=${idConnexion || "‚Äî"} | Dossier=${codeDossier || "‚Äî"}`);
      }

      async function importFromText(text){
        const trimmed = (text || "").trim();
        if (!trimmed) { alert("Veuillez s√©lectionner un fichier ou coller un JSON."); return; }
        let data;
        try {
          data = JSON.parse(trimmed);
        } catch(e) {
          alert("JSON invalide : " + (e?.message || e));
          return;
        }
        await applyImportFromData(data);
      }

      if (btn && fileInput) {
        btn.addEventListener("click", () => openModal());

        // Close actions
        if (btnClose) btnClose.addEventListener("click", closeModal);
        if (modal) {
          modal.addEventListener("click", (ev) => {
            const t = ev.target;
            if (t && t.dataset && t.dataset.close === "1") closeModal();
          });
        }

        // Choice: file
        if (btnChooseFile) {
          btnChooseFile.addEventListener("click", () => {
            try { fileInput.value = ""; } catch(e) {}
            fileInput.click();
          });
        }

        // Choice: paste
        if (btnPasteToggle && pasteZone) {
          btnPasteToggle.addEventListener("click", () => {
            // Affiche la zone "Coller le JSON"
            pasteZone.style.display = (pasteZone.style.display === "none" ? "block" : "none");

            // IMPORTANT : √† la s√©lection "Coller le JSON"
            // - d√©cocher "Chiffrer le mot de passe"
            // - vider la zone JSON √† importer
            const chkEncrypt = $("chkEncryptPwd");
            if (chkEncrypt) chkEncrypt.checked = false;

            if (ta) ta.value = "";

            try { if (ta) ta.focus(); } catch(e) {}
          });
        }

if (btnClearText && ta) {
          btnClearText.addEventListener("click", () => { ta.value = ""; ta.focus(); });
        }

        if (btnFromText && ta) {
          btnFromText.addEventListener("click", async () => {
            try {
              await importFromText(ta.value);
              closeModal();
            } catch(err) {
              // importFromText affiche d√©j√† ses erreurs
              if (typeof jsConsoleLog === 'function') jsConsoleLog("Import JSON (paste) error: " + (err?.message || err));
            }
          });
        }

        // File change
        fileInput.addEventListener("change", async () => {
          const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
          if (!file) return;
          try {
            const text = await file.text();
            await importFromText(text);
            closeModal();
          } catch (err) {
            if (typeof jsConsoleLog === 'function') jsConsoleLog("Import JSON (file) error: " + (err?.message || err));
            alert("Impossible d'importer le JSON : " + (err?.message || err));
          }
        });

        // ESC to close
        document.addEventListener("keydown", (ev) => {
          if (ev.key === "Escape") {
            try {
              if (modal && modal.getAttribute("aria-hidden") === "false") closeModal();
            } catch(e) {}
          }
        });
      }
    })();
    // Console JS buttons
    $("jsConsoleCopyBtn")?.addEventListener("click", async () => {
      const txt = $("jsConsoleLog")?.textContent || "";
      if (!txt) return;

      // Clipboard API works only in secure contexts (https) and may fail on file://.
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(txt);
          jsConsoleLog("Copie OK");
          return;
        }
      } catch (e) {
        // fallback below
      }

      // Fallback: hidden textarea + execCommand('copy')
      try {
        const ta = document.createElement("textarea");
        ta.value = txt;
        ta.setAttribute("readonly", "");
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        jsConsoleLog(ok ? "Copie OK" : "Copie impossible");
      } catch (e) {
        jsConsoleLog("Copie impossible", e && e.message ? e.message : String(e));
      }
    });
    $("jsConsoleClearBtn")?.addEventListener("click", () => {
      const pre = $("jsConsoleLog");
      if (pre) pre.textContent = "";
    });

    $("uuidPortalBtn")?.addEventListener("click", () => {
      if (!storedBaseApi || !storedUUID) { showPortalBadge("err","NO"); return; }
      const base = storedBaseApi.replace(/\/api\/?$/i, "");
      const portailUrl = base.replace(/\/$/, "") + "/isuiteexpert/?UUID=" + encodeURIComponent(storedUUID);
      const w = window.open(portailUrl, "_blank", "noopener,noreferrer");
      if (w) showPortalBadge("ok","OK"); else showPortalBadge("err","NO");
    });

    $("codesTvaDetailBtn")?.addEventListener("click", toggleCodesTvaTable);
    $("codesTvaJsonBtn")?.addEventListener("click", () => openJsonWindow("GET /v1/compta/param√®tres/codesTVA", lastCodesTvaJson));

    $("anaSectionsDetailBtn")?.addEventListener("click", toggleAnaSectionsTable);
    $("anaSectionsJsonBtn")?.addEventListener("click", () => openJsonWindow("GET /v1/compta/param√®tres/analytique", lastAnaSectionsJson));

    $("dossierSessionJsonBtn")?.addEventListener("click", openSessionDossierJson);

    $("uuidJsonBtn")?.addEventListener("click", callAuthUuidEndpoint, window.lastGeneratedCurl);

    $("btnUuidJson")?.addEventListener("click", callAuthUuidEndpoint);

    $("btnAuthJson")?.addEventListener("click", () => openJsonWindow("POST /v1/authentification", lastAuthJson));
    // Version d‚Äôaffichage (VAA.MM-AAA)
    const pv = document.getElementById("prettyVersion");
    if (pv) pv.textContent = "";

    // Boutons pr√©remplissage URL
    $("btnTestLocal")?.addEventListener("click", () => { $("urlInput").value = "http://localhost/cnx";
      updateEnvBadge();
    refreshGrandLivreButtons(); });
    $("btnTestProd")?.addEventListener("click", () => { $("urlInput").value = "https://isuiteproddev.suiteexpert.fr/cnx";
      updateEnvBadge();
    refreshGrandLivreButtons(); });
    $("btnTestAlpha")?.addEventListener("click", () => { $("urlInput").value = "https://isuiteprodalpha.suiteexpert.fr/cnx1";
      updateEnvBadge();
    refreshGrandLivreButtons(); });
  

    // M√™mes presets pour le mode UUID (urlInput2)
    $("btnTestLocal2")?.addEventListener("click", () => { $("urlInput2").value = "http://localhost/cnx"; });
    $("btnTestProd2")?.addEventListener("click", () => { $("urlInput2").value = "https://isuiteproddev.suiteexpert.fr/cnx"; });
    $("btnTestAlpha2")?.addEventListener("click", () => { $("urlInput2").value = "https://isuiteprodalpha.suiteexpert.fr/cnx1"; });

    // Synchronisation basique entre les 2 champs URL (login / UUID)
    $("urlInput")?.addEventListener("input", () => { if ($("urlInput2")) $("urlInput2").value = $("urlInput").value; });
    $("urlInput2")?.addEventListener("input", () => { if ($("urlInput")) $("urlInput").value = $("urlInput2").value;
      updateEnvBadge();
    refreshGrandLivreButtons(); });
$("testLocalBtn")?.addEventListener("click", () => { $("urlInput").value = "http://localhost/cnx";
      updateEnvBadge();
    refreshGrandLivreButtons(); });

    applyTheme(localStorage.getItem("ACD_THEME") || "light");
    setMode("login");
    resetBadges();

    storedUUID = sessionStorage.getItem("ACD_UUID") || "";
    storedBaseApi = sessionStorage.getItem("ACD_BASE_API") || "";
    storedTimeout = sessionStorage.getItem("ACD_SESSION_TIMEOUT") || "";

    updateAuthUI();

    if (storedUUID && storedBaseApi) {
      showSession({ UUID: storedUUID, Identite: {}, VariablesSession: { SESSION_TIMEOUT: storedTimeout } });
    } else {
      hideSession();
    }
  async function fetchComptaDossierForExport() {
  try {
    const baseApiUrl = storedBaseApi || deriveBaseApi($("urlInput")?.value || "");
    const uuid = storedUUID || $("uuidValue")?.textContent?.trim();
    if (!baseApiUrl || !uuid) return null;

    const url = baseApiUrl + "/v1/compta/dossier";
    const res = await fetchWithTrace(url, { method: "GET", headers: { "accept": "text/plain", "UUID": uuid } });

    const raw = await res.text();
    let data = null;
    try { data = raw ? JSON.parse(raw) : null; } catch { data = null; }

    // On conserve quelque chose m√™me en erreur (400/401/‚Ä¶)
    lastComptaDossierJson = res.ok ? data : { "ErreurHTTP": res.status, "Raw": raw };

    // Affichage UI (si existant)
    if (res.ok && data) {
      if (typeof renderComptaDossierParams === "function") { renderComptaDossierParams(data); }
    } else {
      // Si la route renvoie un motif lisible, l'afficher dans la ligne d'erreur si disponible
      const msg = (data && (data.Message || data.message)) ? (data.Message || data.message) : raw;
      setText("comptaDossierStatus", `Erreur HTTP ${res.status}${msg ? " : " + msg : ""}.`, true);
    }

    return lastComptaDossierJson;
  } catch (err) {
    jsConsoleLog("Erreur fetchComptaDossierForExport", err);
    lastComptaDossierJson = { "ErreurJS": String(err) };
    return lastComptaDossierJson;
  }
}


    // --- Delegated handlers for Historique des appels API (section is placed after this <script>) ---
    document.addEventListener("click", async (ev) => {
      const t = ev && ev.target ? ev.target : null;
      const id = t && t.id ? t.id : "";
      if (!id) return;

      if (id === "jsConsoleCopyBtn") {
        const txt = $("jsConsoleLog")?.textContent || "";
        if (!txt) return;

        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(txt);
            jsConsoleLog("Copie OK");
            return;
          }
        } catch (_) {}

        try {
          const ta = document.createElement("textarea");
          ta.value = txt;
          ta.setAttribute("readonly", "");
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          ta.style.top = "0";
          document.body.appendChild(ta);
          ta.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          jsConsoleLog(ok ? "Copie OK" : "Copie impossible");
        } catch (e) {
          jsConsoleLog("Copie impossible", e && e.message ? e.message : String(e));
        }
        return;
      }

      if (id === "jsConsoleClearBtn") {
        const pre = $("jsConsoleLog");
        if (pre) pre.textContent = "";
        return;
      }

      if (id === "jsConsoleToggleBtn") {
        const pre = $("jsConsoleLog");
        if (!pre) return;
        const hidden = (pre.style.display === "none");
        pre.style.display = hidden ? "block" : "none";
        // Optional: keep button label explicit
        const btn = $("jsConsoleToggleBtn");
        if (btn) btn.textContent = hidden ? "Masquer" : "Afficher";
        return;
      }
    });
  } // <-- fin init()

  // Boot
  document.addEventListener("DOMContentLoaded", () => {
    try { if (typeof initSidebarLinks === "function") initSidebarLinks(); } catch(e) {}
    try { if (typeof init === "function") init(); } catch(e) { console.error(e); }
  });
</script>


</div>

  
  <div class="card hidden" id="gedCard" style="margin-top:14px;">
<h2>3. Test GED</h2>
    <div class="kv" style="margin-top:10px;">
      <div class="kv-row">
        <div class="kv-key">Journal</div>
        <div class="kv-val">
          <select id="gedJournalSelect" class="input" style="max-width:280px;"></select>
          <button class="copybtn btn-primary-acd btn-primary-acd" id="gedLoadPlanBtn" type="button" style="margin-left:6px;">R√©cup√©rer IdGed</button>
        </div>
      </div>

      <div class="kv-row">
        <div class="kv-key">Rubrique GED</div>
        <div class="kv-val">
          <select id="gedArboSelect" class="input" style="max-width:520px;"></select>
          <button class="copybtn btn-primary-acd btn-primary-acd" id="gedPickArboBtn" type="button" style="margin-left:6px;">R√©cup√©rer IdGed</button>
        </div>
      </div>

      <div class="kv-row">
        <div class="kv-key">IdGed</div>
        <div class="kv-val">
          <input id="gedIdInput" class="input" type="text" maxlength="10" style="max-width:140px;">
          <button class="copybtn btn-primary-acd btn-primary-acd" id="gedValidateBtn" type="button" style="margin-left:6px;">Valider</button>
          <span id="gedStatusBadge" class="pill hidden" style="margin-left:6px;">OK</span>
          <span id="gedMsg" class="status" style="margin-left:10px;"></span>
        </div>
      </div>
          <div class="kv-row hidden" id="gedDocsCountRow">
            <div class="kv-key">Nombre de documents</div>
            <div class="kv-val"><span id="gedDocsCountVal">‚Äî</span></div>
          </div>
      <div id="gedRubriqueDetail" style="margin-top:12px; display:none; border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card);">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div class="subTitle">D√©tail de la rubrique GED</div>
          <button type="button" class="copybtn" id="gedRubriqueJsonBtn" disabled>JSON</button>
        </div>
        <div style="margin-top:10px; overflow:auto;">
          <table id="gedRubriqueTable" style="width:100%; border-collapse:collapse; font-size:12px; min-width:520px;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border); color:var(--muted);">Champ</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border); color:var(--muted);">Valeur</th>
              </tr>
            </thead>
            <tbody id="gedRubriqueTbody"></tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:10px;">
        <button class="copybtn" id="gedJsonPlanBtn" type="button">JSON plan</button>
        <button class="copybtn" id="gedJsonFilterBtn" type="button">JSON filtre</button>
      </div>
    </div>
  </div>

<div class="card" id="jsConsoleCard" style="margin-top:14px;">
<h2>Historique des appels API</h2>
    <div class="muted" style="margin-top:6px;">
      Affiche l‚Äôensemble des routes API appel√©es ainsi que leurs r√©ponses (succ√®s et erreurs).
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
      <button class="copybtn" id="jsConsoleCopyBtn" type="button">Copier</button>
      <button class="copybtn" id="jsConsoleClearBtn" type="button">Vider</button>
      <button class="copybtn" id="jsConsoleToggleBtn" type="button">Afficher</button>
    </div>

    <pre id="jsConsoleLog" style="display:none; margin-top:10px; max-height:240px; overflow:auto; border:1px solid var(--border); border-radius:14px; padding:10px 12px; font-size:12px; line-height:1.35; background:rgba(0,0,0,.06);"></pre>
  </div>







<script id="acd-format-currency-enhanced">
(function(){
  function formatEuro(value){
    const number = Number(value);
    if(isNaN(number)) return null;
    const formatted = new Intl.NumberFormat('fr-FR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(number) + " ‚Ç¨";
    return { number, formatted };
  }

  function applyFormatting(){
    document.querySelectorAll("*").forEach(function(el){
      if(!el || !el.childNodes || el.childNodes.length !== 1) return;

      const txt = (el.textContent || "").trim();

      if(/^[-]?\d+\.\d{2}$/.test(txt)){
        const result = formatEuro(txt);
        if(!result) return;

        el.textContent = result.formatted;

        el.classList.remove("acd-positive","acd-negative");
        if(result.number < 0){
          el.classList.add("acd-negative");
        }else{
          el.classList.add("acd-positive");
        }
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function(){
    applyFormatting();

    const obs = new MutationObserver(function(){
      applyFormatting();
    });

    obs.observe(document.body, { childList:true, subtree:true });
  });
})();</script>


<script id="acd-toggle-password">
(function(){
  function bind(){
    const pwd = document.getElementById("pwdInput");
    const eye = document.getElementById("btnTogglePwd");
    if(!pwd || !eye) return;

    eye.style.cursor = "pointer";

    // Avoid double-binding
    if(eye.dataset.bound === "1") return;
    eye.dataset.bound = "1";

    const setIcon = (isShown) => {
      // Emoji toggle (stable, no external deps)
      eye.textContent = isShown ? "üôà" : "üëÅ";
      eye.setAttribute("aria-pressed", isShown ? "true" : "false");
      eye.title = isShown ? "Masquer" : "Afficher";
    };

    // init icon from current state
    setIcon(pwd.type === "text");

    eye.addEventListener("click", function(){
      const show = pwd.type === "password";
      pwd.type = show ? "text" : "password";
      setIcon(show);
      // keep focus for usability
      try{ pwd.focus(); }catch(e){}
    });
  }

  document.addEventListener("DOMContentLoaded", function(){
    bind();

    // In case auth panel is re-rendered
    const obs = new MutationObserver(function(){
      bind();
    });
    obs.observe(document.documentElement, {childList:true, subtree:true});
  });

// ---- Fix initial: ne pas cocher "Chiffrer le mot de passe" √† l'ouverture ----
document.addEventListener("DOMContentLoaded", () => {
  try{
    const chk = document.getElementById("chkEncryptPwd");
    if(chk) chk.checked = false;
  }catch(e){}
});
})();
// Console ACD Pro : sidebar r√©tractable
(function(){
  const KEY = "ACD_SidebarCollapsed";
  function applyState(isCollapsed){
    document.body.classList.toggle("sidebar-collapsed", !!isCollapsed);
  }
  function load(){
    try{
      const v = localStorage.getItem(KEY);
      if (v === "1") applyState(true);
    }catch(e){}
  }
  function save(isCollapsed){
    try{ localStorage.setItem(KEY, isCollapsed ? "1" : "0"); }catch(e){}
  }

  document.addEventListener("DOMContentLoaded", function(){
    load();
    const btn = document.getElementById("sidebarToggle");
    if (!btn) return;
    btn.addEventListener("click", function(){
      const next = !document.body.classList.contains("sidebar-collapsed");
      applyState(next);
      save(next);
    });
  });
})();


// Sidebar Pro : ajoute des tooltips utiles sur les boutons en mode compact
document.addEventListener("DOMContentLoaded", () => {
  const sb = document.getElementById("sidebar");
  if (!sb) return;
  sb.querySelectorAll("button").forEach((b) => {
    if (!b.getAttribute("title")) {
      const t = (b.textContent || "").trim();
      if (t) b.setAttribute("title", t);
    }
  });
});






// Console UI : badge environnement en haut (juste sous le bouton "Console")
document.addEventListener("DOMContentLoaded", () => {
  try {
    const sb = document.getElementById("sidebar");
    if (!sb) return;

    const env =
      sb.querySelector(".envBadgeWrap") ||
      document.getElementById("envBadgeWrap") ||
      document.getElementById("envBadge");

    if (!env) return;

    // Cible : juste apr√®s le bloc sidebarTop (bouton Console)
    const top = sb.querySelector(".sidebarTop");
    const title =
      sb.querySelector(".headerTitle") ||
      sb.querySelector(".app-name") ||
      sb.querySelector(".app-title") ||
      sb.querySelector(".headerTop") ||
      sb.querySelector("h1");

    // Force affichage et mise en avant
    env.style.display = "block";
    env.style.margin = "10px 0 10px";
    env.style.order = "0";

    if (top && top.parentNode === sb) {
      // Ins√©rer apr√®s sidebarTop
      if (top.nextSibling) sb.insertBefore(env, top.nextSibling);
      else sb.appendChild(env);
    } else if (title) {
      sb.insertBefore(env, title);
    } else {
      sb.insertBefore(env, sb.firstChild);
    }
  } catch (e) {}
});


// ---------------------------------------------------------------------------
// Fix: Historique des appels API (Copier / Vider / Afficher)
// But : garantir le binding m√™me si une partie de init() √©choue (null refs, etc.).
// ---------------------------------------------------------------------------
(function bindApiHistoryButtons(){
  function safeBind(){
    const copyBtn   = document.getElementById("jsConsoleCopyBtn");
    const clearBtn  = document.getElementById("jsConsoleClearBtn");
    const toggleBtn = document.getElementById("jsConsoleToggleBtn");
    const logEl     = document.getElementById("jsConsoleLog");
    const box       = document.getElementById("jsConsoleBox");
    if(!copyBtn || !clearBtn || !toggleBtn || !logEl || !box) return;

    // Reset inline handlers to avoid duplicate triggers (file may bind elsewhere)
    copyBtn.onclick = null;
    clearBtn.onclick = null;
    toggleBtn.onclick = null;

    async function copyTextToClipboard(text){
      const txt = (text ?? "").toString();
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(txt);
          return true;
        }
      }catch(e){}
      try{
        const ta = document.createElement("textarea");
        ta.value = txt;
        ta.setAttribute("readonly", "");
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return !!ok;
      }catch(e){
        return false;
      }
    }

    function toast(msg){
      try{
        if(typeof showToast === "function") showToast(msg);
      }catch(e){}
    }

    toggleBtn.addEventListener("click", (ev)=>{
      ev.preventDefault();
      const hidden = (box.style.display === "none") || (getComputedStyle(box).display === "none");
      if(hidden){
        box.style.display = "block";
        toggleBtn.textContent = "Masquer";
      }else{
        box.style.display = "none";
        toggleBtn.textContent = "Afficher";
      }
    });

    clearBtn.addEventListener("click", (ev)=>{
      ev.preventDefault();
      logEl.textContent = "";
      toast("Historique vid√©.");
    });

    copyBtn.addEventListener("click", async (ev)=>{
      ev.preventDefault();
      const txt = (logEl.innerText || logEl.textContent || "").trim();
      if(!txt){
        toast("Historique vide.");
        return;
      }
      const ok = await copyTextToClipboard(txt);
      toast(ok ? "Historique copi√©." : "Copie impossible.");
    });
  }

  document.addEventListener("DOMContentLoaded", safeBind);
  window.addEventListener("load", safeBind);
})();




</script>






</body>
</html>